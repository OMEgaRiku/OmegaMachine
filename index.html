<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>OMEGA STONE</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23d4af37%22 style=%22font-family:serif; font-weight:bold;%22>Î©</text></svg>">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-color: #050505;
    --text-main: #e0d0b0;
    --accent-color: #d4af37;
  }

  body {
    font-family: 'Shippori Mincho', serif;
    background-color: var(--bg-color);
    background-image: radial-gradient(circle at 50% 50%, #1a150e 0%, #000000 100%);
    color: var(--text-main);
    text-align: center;
    padding: 20px;
    margin: 0;
    min-height: 100vh;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    transition: background-image 1s ease;
  }
  .en-font { font-family: 'Cinzel', serif; }

  /* Title Screen */
  #title-screen {
    display: flex; flex-direction: column; justify-content: center; align-items: center; height: 90vh; animation: fadeIn 2s;
  }
  .game-title {
    font-family: 'Cinzel', serif; font-size: 2.5rem; font-weight: 900; letter-spacing: 3px;
    background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; color: transparent;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.3); margin-bottom: 5px;
  }

  /* Difficulty Buttons */
  .btn {
    background: rgba(0,0,0,0.5); border: 1px solid #777; color: #ccc; padding: 18px; margin: 8px;
    font-size: 1.1rem; font-family: 'Shippori Mincho', serif; font-weight: bold; cursor: pointer;
    width: 90%; max-width: 350px; position: relative; overflow: hidden; transition: 0.3s; border-radius: 8px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .btn:active { transform: scale(0.98); }
  
  .btn-std { border-color: #3498db; color: #aed6f1; box-shadow: 0 0 10px rgba(52, 152, 219, 0.2); }
  .btn-hard { border-color: #e74c3c; color: #f5b7b1; box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }
  .btn-night { border-color: #9b59b6; color: #d7bde2; box-shadow: 0 0 10px rgba(155, 89, 182, 0.2); }
  .btn-chaos { border-color: #95a5a6; color: #d0d0d0; box-shadow: 0 0 10px rgba(255, 255, 255, 0.1); border-style: dashed;}
  
  /* Omega Mode Styles */
  .btn-omega { 
    border-color: #fff; color: #fff; background: #000; 
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); font-family: 'Cinzel', serif;
  }

  /* Game Screen */
  #game-screen { display: none; max-width: 600px; margin: 0 auto; animation: slideIn 0.5s ease-out; }
  @keyframes slideIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

  .hud {
    display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.2);
    padding-bottom: 10px; margin-bottom: 20px; font-family: 'Cinzel', serif;
  }
  .hud-left { display: flex; gap: 8px; }
  .hud-btn { 
    cursor: pointer; font-size: 0.85rem; color: #aaa; border: 1px solid #555; 
    padding: 6px 12px; border-radius: 4px; background: rgba(0,0,0,0.6); 
    display: flex; align-items: center; justify-content: center;
  }
  .btn-guide { border-color: #d4af37; color: #f1c40f; font-weight: bold; }
  .mana-bar { font-size: 1.1rem; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }

  /* Rune Inputs */
  .rune-container {
    display: flex; justify-content: center; gap: 12px; margin-bottom: 20px;
    background: rgba(0,0,0,0.4); padding: 20px 10px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);
  }
  .rune-wrapper { position: relative; width: 80px; }
  .rune-label { position: absolute; top: -28px; left: 0; width: 100%; font-size: 0.8rem; font-weight: bold; }
  .rune-sub { font-size: 0.6rem; color: #888; display: block; margin-top: -2px; font-family: 'Cinzel', serif; }
  
  input.rune-input {
    width: 100%; height: 75px; font-size: 2.2rem; text-align: center; background: #0f0f0f;
    border: 2px solid #333; border-radius: 8px; color: #fff; font-family: 'Cinzel', serif; transition: 0.3s;
  }
  input:focus { outline: none; border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
  
  #r1 { border-color: #8a1c1c; color: #ff9999; } /* Ignis */
  #r2 { border-color: #1c4e8a; color: #99ccff; } /* Aqua */
  #r3 { border-color: #1c8a5e; color: #99ffcc; } /* Ventus */

  /* Logic Matrix */
  .logic-grid {
    display: grid; grid-template-columns: auto repeat(5, 1fr); gap: 4px;
    margin: 10px 0 10px 0; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
  }
  .grid-header { font-family: 'Cinzel', serif; font-weight: bold; color: #888; font-size: 0.8rem; padding-bottom: 5px;}
  .grid-row-label { text-align: right; padding-right: 10px; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; justify-content: flex-end;}
  
  .grid-cell {
    background: rgba(255,255,255,0.05); border: 1px solid #333; aspect-ratio: 1; border-radius: 4px;
    cursor: pointer; display: flex; justify-content: center; align-items: center;
    font-weight: bold; font-size: 1.2rem; user-select: none; transition: 0.1s;
  }
  
  /* Shared Cell Styles */
  .cell-x, .memo-btn.is-x { background: rgba(200, 50, 50, 0.2); color: #ff5555; border-color: #552222; }
  .cell-x::after, .memo-btn.is-x::after { content: "Ã—"; }
  
  .cell-o, .memo-btn.is-o { background: rgba(50, 200, 50, 0.2); color: #55ff55; border-color: #225522; }
  .cell-o::after, .memo-btn.is-o::after { content: "â—‹"; }

  /* Memo Toggle & Area */
  .memo-toggle-btn {
    width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #444; border-radius: 6px;
    color: #aaa; font-size: 0.8rem; cursor: pointer; margin-bottom: 5px; font-weight: bold; transition: 0.2s;
  }
  .memo-toggle-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

  .memo-area {
    background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 8px;
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out; overflow: hidden;
  }
  .memo-area.closed { display: none; }

  .memo-row { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
  .memo-label { width: 100%; font-size: 0.7rem; color: #888; margin-bottom: 2px; text-align: left; padding-left: 5px;}
  .memo-btn {
    border: 1px solid #444; background: #111; color: #ccc; padding: 6px 8px; border-radius: 4px;
    font-size: 0.75rem; cursor: pointer; min-width: 45px; display: flex; align-items: center; justify-content: center; gap: 3px; user-select: none;
  }
  .memo-btn::after { margin-left: 2px; font-weight: bold; }

  /* Prophecy List */
  .prophecy-list { display: flex; flex-direction: column; gap: 10px; }
  .stone {
    background: linear-gradient(to right, rgba(30,30,30,0.9), rgba(10,10,10,0.9));
    border: 1px solid #444; padding: 10px 15px;
    border-radius: 5px; cursor: pointer; text-align: left; transition: 0.2s;
    display: flex; justify-content: space-between; align-items: center; position: relative;
    backdrop-filter: blur(5px);
  }
  .stone:hover { border-color: #aaa; transform: translateX(5px); }
  .stone::after { content: ''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: #666; }
  .stone.disabled { opacity: 0.4; pointer-events: none; }
  .stone-title { font-size: 0.75rem; color: #888; margin-bottom: 2px; }
  .stone-text { font-size: 1rem; color: #fff; font-weight: bold; letter-spacing: 0.5px; }
  .stone-id { font-family: 'Cinzel', serif; font-size: 1.4rem; color: #444; margin-left: 10px;}
  
  /* Mystery Stone (Omega) */
  .stone.is-mystery {
    color: #fff; background: #000; border: 1px solid #555;
    display: flex; justify-content: center; align-items: center;
  }
  .stone.is-mystery .stone-title { display: none; }
  .stone.is-mystery .stone-text { 
    font-family: 'Cinzel', serif; font-size: 1.5rem; letter-spacing: 5px; color: #888; 
  }

  /* Log */
  .log-area {
    margin-top: 20px; border-top: 1px solid #444; padding-top: 10px; max-height: 200px; overflow-y: auto; text-align: left; font-size: 0.9rem;
  }
  .log-entry { margin-bottom: 5px; padding: 8px 10px; border-radius: 4px; background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
  .log-true { border-left: 3px solid #2ecc71; color: #aaffaa; }
  .log-false { border-left: 3px solid #e74c3c; color: #ffaaaa; }
  .log-nums { font-family: 'Cinzel', serif; font-weight: bold; background: #000; padding: 1px 6px; border-radius: 3px; letter-spacing: 1px; font-size: 0.8rem;}

  /* Action Bar */
  .action-bar { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
  .btn-action { flex: 1; padding: 15px; font-weight: bold; font-family: 'Shippori Mincho', serif; border: none; cursor: pointer; border-radius: 8px; font-size: 1rem; color: #fff; transition: 0.2s; }
  .btn-next { background: #333; border: 1px solid #555; }
  .btn-solve { background: #27ae60; box-shadow: 0 4px 0 #1e8449; }

  /* Chaos Bar */
  .chaos-bar { background: #c0392b; color: white; padding: 5px; font-size: 0.8rem; font-weight: bold; margin-bottom: 15px; border-radius: 4px; display: none; text-shadow: 0 0 5px #000; letter-spacing: 2px;}

  /* Modals */
  .modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 10000; flex-direction: column; justify-content: center; align-items: center;
    backdrop-filter: blur(5px);
  }
  .seal-broken { font-size: 2.5rem; color: #fff; text-shadow: 0 0 30px #fff; font-weight: bold; }
  .answer-reveal { font-size: 4rem; letter-spacing: 15px; margin: 20px; color: #fff; font-family: 'Cinzel', serif; }

  /* Help & History Styles */
  #help-content, #history-content {
    background: #111; border: 1px solid #444; padding: 20px; border-radius: 10px; width: 85%; max-width: 500px;
    max-height: 80vh; overflow-y: auto; text-align: left; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.8);
  }
  .help-section { margin-bottom: 25px; border-bottom: 1px dashed #333; padding-bottom: 15px; }
  .help-title { color: #d4af37; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;}
  .help-text { font-size: 0.9rem; line-height: 1.6; color: #ccc; }
  /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚è¿½å¾“ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ï¼‰ */
.close-help { 
  position: sticky !important; /* absolute ã‹ã‚‰ sticky ã«å¤‰æ›´ */
  top: 0; 
  float: right; /* å³ã«å¯„ã›ã‚‹ */
  font-size: 2rem; /* å°‘ã—å¤§ããã—ã¦æŠ¼ã—ã‚„ã™ã */
  cursor: pointer; 
  color: #888; 
  padding: 5px 10px;
  background: #111; /* èƒŒæ™¯ã‚’ã¤ã‘ã¦æ–‡å­—ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã« */
  border-radius: 0 0 0 8px;
  z-index: 10;
  margin-top: -10px; /* ä½ç½®å¾®èª¿æ•´ */
  margin-right: -10px;
}

  
  .diagram-box {
    background: #222; border: 1px solid #444; padding: 15px; border-radius: 6px; margin: 10px 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .d-stone {
    width: 90%; background: #333; border-left: 3px solid #666; padding: 8px; margin: 5px 0; color: #fff; font-size: 0.8rem; display: flex; justify-content: space-between;
  }
  .d-arrow { font-size: 1.5rem; color: #d4af37; margin: 5px 0; }
  .d-result { font-weight: bold; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
  .d-true { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
  .d-false { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
  
  /* Liar Styles */
  .stone.is-liar {
    border: 2px solid #e74c3c;
    background: linear-gradient(to right, rgba(231, 76, 60, 0.2), rgba(0,0,0,0.8));
  }
  .stone.is-liar::after { background: #e74c3c; }
  .stone.is-liar .stone-title::after {
    content: " (å˜˜ã¤ã)"; color: #e74c3c; font-weight: bold; margin-left: 5px;
  }
  .res-row { font-size: 0.8rem; border-bottom: 1px solid #444; padding: 5px 0; color: #ccc; }
  .res-liar-txt { color: #e74c3c; font-weight:bold; }

  /* Omega Rule List */
  #omega-rule-area {
    margin-top: 15px; padding: 10px; border: 1px solid #444; border-radius: 8px;
    background: rgba(0,0,0,0.8); display: none; text-align: left;
  }
  .omega-label { color: #fff; font-size: 0.9rem; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; }
  .omega-list-item {
    padding: 6px; font-size: 0.85rem; color: #ccc; cursor: pointer; border-bottom: 1px dashed #333; transition: 0.2s;
  }
  .omega-list-item:hover { color: #fff; background: rgba(255,255,255,0.1); }
  .omega-list-item.excluded {
    text-decoration: line-through; color: #555; opacity: 0.6;
  }

  /* History List Styles */
  .hist-item {
    background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 10px;
    margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
  }
  .hist-left { text-align: left; }
  .hist-mode { font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; margin-right: 5px; font-weight: bold; }
  .mode-standard { background: #1c4e8a; color: #aed6f1; }
  .mode-hard { background: #8a1c1c; color: #f5b7b1; }
  .mode-nightmare { background: #4a1c8a; color: #d7bde2; }
  .mode-chaos { background: #555; color: #ccc; }
  .mode-omega { background: #000; color: #fff; border: 1px solid #fff; }

  .hist-id { font-family: 'Cinzel', serif; color: #d4af37; font-weight: bold; letter-spacing: 1px; }
  .hist-date { font-size: 0.7rem; color: #666; margin-top: 2px; }
  .hist-result { font-weight: bold; font-size: 0.9rem; }
  .res-win { color: #2ecc71; }
  .res-lose { color: #e74c3c; }

  .btn-replay {
    background: transparent; border: 1px solid #555; color: #aaa; cursor: pointer;
    padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; transition: 0.2s;
  }
  .btn-replay:hover { background: #333; color: #fff; border-color: #fff; }
  
  /* Tutorial Styles */
  .t-container { display: flex; flex-direction: column; gap: 15px; }
  .t-step { background: #1a1a1a; border: 1px solid #444; border-radius: 8px; padding: 15px; position: relative; text-align: left; }
  .t-step-num { background: var(--accent-color); color: #000; font-weight: bold; display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 8px; }
  .t-row { display: flex; align-items: center; justify-content: space-around; margin: 10px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; }
  .t-stone-mock { border: 1px solid #666; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; color: #ccc; background: #222; }
  .t-result-mock { font-weight: bold; font-family: 'Cinzel', serif; padding: 5px 10px; border-radius: 4px; }
  .t-res-true { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
  .t-res-false { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
  .t-logic-text { font-size: 0.9rem; line-height: 1.6; color: #ddd; margin-top: 5px; }
  .t-highlight { color: #ff9999; font-weight: bold; }
  .t-highlight-b { color: #99ccff; font-weight: bold; }
  .t-conclusion { border-top: 1px dashed #444; margin-top: 10px; padding-top: 10px; font-weight: bold; color: var(--accent-color); }

  #loading-indicator { font-size: 1.2rem; color: #d4af37; margin-top: 20px; display: none; }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  
    /* --- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (æ”¹ä¿®ç‰ˆ) --- */
  
  /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢å³ä¸Šã®ãƒœã‚¿ãƒ³ */
  .title-top-right {
    position: absolute; top: 20px; right: 20px;
    display: flex; gap: 10px; z-index: 10;
  }
  .btn-tutorial {
    background: rgba(46, 204, 113, 0.2); border: 1px solid #2ecc71; color: #2ecc71;
    padding: 10px 15px; border-radius: 30px; font-weight: bold; cursor: pointer;
    font-size: 0.9rem; display: flex; align-items: center; gap: 5px;
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.2); transition: 0.2s;
  }
  .btn-tutorial:hover { background: rgba(46, 204, 113, 0.4); transform: scale(1.05); }

  /* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸BOX */
  #tut-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    /* èƒŒæ™¯ã®æš—ã•ã‚’å°‘ã—å’Œã‚‰ã’ã¾ã—ãŸ (0.7 -> 0.4) */
    background: rgba(0,0,0,0.4); z-index: 2000; display: none;
    pointer-events: auto;
  }
  
  /* ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆç©´ã‚’é–‹ã‘ã‚‹ï¼‰ */
  .tut-highlight {
    position: relative; z-index: 2001; 
    /* å‘¨ã‚Šã®æš—ã•ã‚‚å°‘ã—å’Œã‚‰ã’ã¾ã—ãŸ */
    box-shadow: 0 0 0 9999px rgba(0,0,0,0.6); 
    pointer-events: auto; 
    border-radius: 4px;
    transition: all 0.3s ease;
  }

  /* èµ¤ãç‚¹æ»…ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ³¨ç›®ï¼ï¼‰ */
  @keyframes blink-red {
    0% { border-color: #ff0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); transform: scale(1); }
    50% { border-color: #ffcccc; box-shadow: 0 0 25px rgba(255, 50, 50, 0.9); transform: scale(1.02); }
    100% { border-color: #ff0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); transform: scale(1); }
  }
  .tut-blink {
    animation: blink-red 1.2s infinite ease-in-out !important;
    border: 2px solid #ff0000 !important;
    background: rgba(0, 0, 0, 0.8) !important; /* æ–‡å­—ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«èƒŒæ™¯ã‚’æ¿ƒã */
  }
  /* --- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«BOX (å¼·åˆ¶ä½ç½®ä¿®æ­£ç‰ˆ) --- */

  .tut-msg-box {
    position: fixed !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 92% !important; /* æ¨ªå¹… */
    max-width: 500px !important;
    background: rgba(15, 15, 20, 0.95) !important;
    border: 1px solid #d4af37 !important;
    border-radius: 8px !important;
    padding: 12px 15px !important; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
    z-index: 9999 !important; /* æœ€å‰é¢ã« */
    text-align: left !important;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.9) !important;
    transition: all 0.3s ease !important;
    
    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œç”»é¢ã®ä¸€ç•ªä¸‹ã€ã«é…ç½® */
    bottom: 20px !important;
    top: auto !important;
  }

  /* ä¸Šã«è¡¨ç¤ºã™ã‚‹å ´åˆã®ã‚¯ãƒ©ã‚¹ */
  .tut-pos-top {
    top: 80px !important; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸‹ */
    bottom: auto !important;
  }

  /* ä¸‹ã«è¡¨ç¤ºã™ã‚‹å ´åˆã®ã‚¯ãƒ©ã‚¹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨åŒã˜ã ãŒå¿µã®ãŸã‚) */
  .tut-pos-bottom {
    bottom: 20px !important;
    top: auto !important;
  }

  /* ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
  .tut-text {
    color: #fff;
    line-height: 1.4;
    font-size: 0.9rem; /* æ–‡å­—ã‚’å°‘ã—å°ã•ã */
    margin-bottom: 8px;
  }

  /* ãƒœã‚¿ãƒ³èª¿æ•´ */
  .tut-next-btn {
    background: #d4af37;
    color: #000;
    border: none;
    padding: 5px 15px;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    float: right;
    font-size: 0.8rem;
  }

    
  .tut-msg-box {
    position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
    width: 90%; max-width: 500px; background: #111; border: 2px solid #d4af37;
    border-radius: 10px; padding: 20px; z-index: 2002; text-align: left;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
  }
  .tut-text { color: #fff; line-height: 1.6; font-size: 1rem; margin-bottom: 15px; }
  .tut-next-btn {
    background: #d4af37; color: #000; border: none; padding: 8px 20px;
    font-weight: bold; border-radius: 4px; cursor: pointer; float: right;
  }
  .tut-arrow {
    position: absolute; color: #d4af37; font-size: 2rem; font-weight: bold;
    animation: bounce 1s infinite; z-index: 2003; text-shadow: 0 0 5px #000;
  }
  @keyframes bounce { 0%, 100% { transform:translateY(0); } 50% { transform:translateY(-10px); } }

/* --- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ï¼ˆä¿®æ­£ç‰ˆï¼‰ --- */

/* åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ */
.tut-embedded-mode {
  position: relative !important; /* å›ºå®šé…ç½®ã‚’è§£é™¤ */
  left: auto !important;
  transform: none !important;
  bottom: auto !important;
  top: auto !important;
  
  width: 100% !important;
  max-width: 100% !important;
  margin: 0 0 20px 0 !important;
  
  background: rgba(20, 20, 25, 0.95) !important;
  border: 1px solid #d4af37 !important;
  border-radius: 8px !important;
  padding: 15px !important;
  box-shadow: 0 0 10px rgba(212, 175, 55, 0.3) !important;
  
  display: flex !important;
  flex-direction: column;
  justify-content: center;
  min-height: 120px; 
}

/* çŸ¢å°ã¯åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã§ã¯æ¶ˆã™ */
.tut-embedded-mode .tut-arrow {
  display: none !important;
}

/* çµæœè¡¨ç¤ºã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
.tut-result-display {
  font-family: 'Cinzel', serif;
  font-size: 1.4rem;
  font-weight: bold;
  text-align: center;
  margin: 10px 0;
  padding: 8px;
  background: rgba(0,0,0,0.5);
  border-radius: 4px;
}

/* --- ã‚ªãƒ¡ã‚¬ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ¡ãƒ¢æ¬„ --- */
.omega-memo-box {
  margin-top: 5px;
  padding: 0 5px;
}
.omega-memo-input {
  width: 100%;
  box-sizing: border-box;
  background: #000;
  border: 1px solid #444;
  color: #d4af37; /* é‡‘è‰²æ–‡å­— */
  font-size: 0.8rem;
  padding: 5px;
  border-radius: 4px;
  font-family: 'Shippori Mincho', serif;
  transition: 0.3s;
}
.omega-memo-input:focus {
  outline: none;
  border-color: #d4af37;
  box-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
  background: #111;
}
.omega-memo-input::placeholder {
  color: #444;
  font-style: italic;
}

/* --- ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
input.rune-input:disabled {
  background: #222;       /* èƒŒæ™¯ã‚’æš—ã */
  color: #555;            /* æ–‡å­—ã‚’æš—ã */
  border-color: #444;     /* æ ç·šã‚‚ç›®ç«‹ãŸãªã */
  opacity: 0.7;
  cursor: not-allowed;
}

/* ãƒ­ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes fadeIn { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }

/* --- iPhone (iOS Safari) è¡¨ç¤ºå´©ã‚Œå¯¾ç­– --- */

/* 1. å…¥åŠ›æ¬„ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆï¼†ã‚µã‚¤ã‚ºå›ºå®š */
.rune-input {
  /* iPhoneç‰¹æœ‰ã®ä¸¸ã¿ã‚„å½±ã‚’æ¶ˆã™ */
  -webkit-appearance: none !important; 
  appearance: none !important;
  
  /* æ¨ªå¹…ã‚’å¼·åˆ¶çš„ã«åºƒã’ã‚‹ */
  width: 80px !important; 
  min-width: 80px !important; /* å¿µã®ãŸã‚æœ€å°å¹…ã‚‚æŒ‡å®š */
  
  /* ä½™è¨ˆãªéš™é–“ã‚’æ¶ˆã™ */
  margin: 0;
  border-radius: 8px; /* ãƒ‡ã‚¶ã‚¤ãƒ³ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦OK */
  box-sizing: border-box; /* æ ç·šã‚’å«ã‚ãŸã‚µã‚¤ã‚ºè¨ˆç®—ã«ã™ã‚‹ */
}

/* 2. å…¥åŠ›æ¬„ã‚’åŒ…ã‚“ã§ã„ã‚‹ç®±ãŒæ½°ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
.rune-wrapper {
  flex-shrink: 0 !important; /* ã€Œç¸®ã‚€ãªï¼ã€ã¨ã„ã†å‘½ä»¤ */
  width: auto !important;
}


</style>
</head>
<body>
  <div id="title-screen">
      <div class="title-top-right">
      <div class="btn-tutorial" onclick="startTutorial()">Tutorial</div>
    </div>

    <div class="game-title">OMEGA STONE</div>
    <div style="color:#aaa; margin-bottom:40px; letter-spacing:2px; font-size:0.9rem;">Logical Deduction RPG</div>
    
    <div class="btn btn-std" onclick="startGame('standard')"><span>Standard</span><span class="en-font">I</span></div>
    <div class="btn btn-hard" onclick="startGame('hard')"><span>Hard</span><span class="en-font">II</span></div>
    <div class="btn btn-night" onclick="startGame('nightmare')"><span>Nightmare</span><span class="en-font">III</span></div>
    <div class="btn btn-chaos" onclick="startGame('chaos')"><span>Chaos</span><span class="en-font">âˆ</span></div>
    <div class="btn btn-omega" onclick="startGame('omega')"><span>Omega</span><span class="en-font">?</span></div>

    <div style="display:flex; gap:10px; width:90%; max-width:350px; margin-top:10px;">
      <div class="btn btn-std" style="font-size:0.9rem; padding:12px;" onclick="showHistory()">ğŸ“œ å±¥æ­´</div>
      <div class="btn btn-std" style="font-size:0.9rem; padding:12px; border-color:#aaa; color:#eee;" onclick="showInputId()">ğŸ”‘ IDå…¥åŠ›</div>
    </div>
    
    <div id="loading-indicator">ç”Ÿæˆä¸­...</div>
  </div>

  <div id="game-screen">
    <div class="hud">
      <div class="hud-left">
        <div class="hud-btn" onclick="location.reload()">MENU</div>
        <div class="hud-btn btn-guide" onclick="showHelp()">GUIDE&RULE</div>
        <div id="btn-show-result" class="hud-btn" style="display:none; border-color:#2ecc71; color:#2ecc71; font-weight:bold;" onclick="showResult()">â˜… RESULT</div>
      </div>
      <div class="mana-bar"><span style="font-size:0.8rem; color:#888;">MANA</span> <span id="ui-mana" class="en-font">0/3</span></div>
    </div>

    <div style="text-align:right; font-size:0.8rem; color:#aaa; margin-top:-15px; margin-bottom:15px; margin-right:5px;">ROUND <span id="ui-round" class="en-font" style="color:#fff; font-size:1.1rem;">1</span></div>

    <div id="chaos-warning" class="chaos-bar">âš  å¸¸ã«å˜˜ã‚’ã¤ãå½ã‚Šã®çŸ³ç¢‘ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ (ONE LIAR)</div>

        <div class="rune-container" style="flex-direction:column; gap:5px;">
      <div style="display:flex; justify-content:center; gap:12px;">
        <div class="rune-wrapper">
          <div class="rune-label" style="color:#ff9999">ç‚<span class="rune-sub">IGNIS</span></div>
          <input type="number" id="r1" class="rune-input" min="1" max="5" placeholder="-" onchange="limitInput(this)">
        </div>
        <div class="rune-wrapper">
          <div class="rune-label" style="color:#99ccff">æ°´<span class="rune-sub">AQUA</span></div>
          <input type="number" id="r2" class="rune-input" min="1" max="5" placeholder="-" onchange="limitInput(this)">
        </div>
        <div class="rune-wrapper">
          <div class="rune-label" style="color:#99ffcc">é¢¨<span class="rune-sub">VENTUS</span></div>
          <input type="number" id="r3" class="rune-input" min="1" max="5" placeholder="-" onchange="limitInput(this)">
        </div>
      </div>
      <div id="rune-lock-msg" style="display:none; color:#e74c3c; font-size:0.75rem; font-weight:bold; margin-top:5px; animation:fadeIn 0.5s;">
        ğŸ”’ï¸æ•°å­—ã¯æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¾ã§å¤‰æ›´ã§ãã¾ã›ã‚“
      </div>
    </div>


    <div style="text-align:left; color:#666; font-size:0.7rem; margin-bottom:5px; margin-left:5px;">LOGIC MATRIX & MEMO</div>
    <div class="logic-grid" id="logic-matrix"></div>

    <button class="memo-toggle-btn" onclick="toggleMemoArea()">ğŸ“ MEMO PAD (Show/Hide)</button>
    
    <div class="memo-area closed" id="memo-pad">
      <div class="memo-label">åˆè¨ˆãƒ¡ãƒ¢</div>
      <div class="memo-row">
        <div class="memo-btn" onclick="toggleMemo(this)">å¶æ•°</div>
        <div class="memo-btn" onclick="toggleMemo(this)">å¥‡æ•°</div>
        <div class="memo-btn" onclick="toggleMemo(this)">&lt; 6</div>
        <div class="memo-btn" onclick="toggleMemo(this)">â‰§ 6</div>
        <div class="memo-btn" onclick="toggleMemo(this)">&lt; 10</div>
        <div class="memo-btn" onclick="toggleMemo(this)">â‰§ 10</div>
      </div>
      <div class="memo-label">å¤§å°ãƒ¡ãƒ¢ (å€¤ â‰§ ä»–)</div>
      <div class="memo-row">
        <div class="memo-btn" onclick="toggleMemo(this)">Max<span style="color:#ff9999">ç‚</span></div>
        <div class="memo-btn" onclick="toggleMemo(this)">Max<span style="color:#99ccff">æ°´</span></div>
        <div class="memo-btn" onclick="toggleMemo(this)">Max<span style="color:#99ffcc">é¢¨</span></div>
        <div class="memo-btn" onclick="toggleMemo(this)">Min<span style="color:#ff9999">ç‚</span></div>
        <div class="memo-btn" onclick="toggleMemo(this)">Min<span style="color:#99ccff">æ°´</span></div>
        <div class="memo-btn" onclick="toggleMemo(this)">Min<span style="color:#99ffcc">é¢¨</span></div>
      </div>
    </div>
    <div id="prophecy-container" class="prophecy-list"></div>

    <div id="omega-rule-area">
      <div class="omega-label">DETECTED LAWS (Search & Destroy)</div>
      <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">â€»ã‚¯ãƒªãƒƒã‚¯ã§å–ã‚Šæ¶ˆã—ç·š (ãƒ¡ãƒ¢)</div>
      <div id="omega-list"></div>
    </div>

    <div class="action-bar">
      <button class="btn-action btn-next" onclick="nextRound()">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸</button>
      <button class="btn-action btn-solve" onclick="attemptUnlock()">å°å°è§£é™¤</button>
    </div>

    <div id="log-container" class="log-area">
      <div style="color:#666; text-align:center; font-style:italic; font-size:0.8rem;">-- è§£æã®è¨˜éŒ² --</div>
    </div>
  </div>

  <div id="help-modal" class="modal-overlay">
    <div id="help-content">
      <div class="close-help" onclick="closeHelp()">Ã—</div>
      <h2 style="text-align:center; margin-top:0; color:#fff; border-bottom:1px solid #333; padding-bottom:15px;">éºè·¡è§£æã‚¬ã‚¤ãƒ‰</h2>
      <div class="help-section">
        <div class="help-title">1. ã“ã®ã‚²ãƒ¼ãƒ ã®ç›®çš„</div>
        <div class="help-text">
          ã‚ãªãŸã®ç›®çš„ã¯ã€3ã¤ã®ãƒ«ãƒ¼ãƒ³ï¼ˆ<span class="t-highlight">ç‚</span>ãƒ»<span class="t-highlight-b">æ°´</span>ãƒ»<span style="color:#99ffcc; font-weight:bold;">é¢¨</span>ï¼‰ã«è¨­å®šã•ã‚ŒãŸ<strong>ã€Œæ­£è§£ã®æ•°å­— (1ã€œ5)ã€</strong>ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã§ã™ã€‚<br><br>
          ã—ã‹ã—ã€ã„ããªã‚Šæ•°å­—ã‚’å½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚<br>
          ã¾ãšã¯çŸ³ç¢‘ã«è³ªå•ã‚’ã—ã¦<strong>ã€Œéš ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã€</strong>ã‚’æš´ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
        </div>
      </div>
      <div class="help-section">
        <div class="help-title">2. ä¾‹é¡Œã§ã‚ã‹ã‚‹ã€Œè§£æã€ã®æµã‚Œ</div>
        <div class="help-text" style="margin-bottom:15px;">
          ã‚ã‚‹çŸ³ç¢‘ã«<strong>ã€Œç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)ã€</strong>ã¨æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚<br>
          ã“ã‚Œã¯ã€ã€Œç‚ãŒå¤§ãã„ã€ã®ã‹ã€ŒåŒã˜ã€ãªã®ã‹ã€Œæ°´ãŒå¤§ãã„ã€ã®ã‹ã€<strong>ãƒ«ãƒ¼ãƒ«ãŒã¾ã ä¸æ˜</strong>ãªçŠ¶æ…‹ã§ã™ã€‚<br>
          ã“ã‚Œã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€æ•°å­—ã‚’å…¥åŠ›ã—ã¦çŸ³ç¢‘ã®åå¿œã‚’è¦‹ã¾ã™ã€‚
        </div>
        <div class="t-container">
          <div class="t-step">
            <div class="t-step-num">STEP 1 : è©¦ã—ã«å…¥åŠ›ã—ã¦ã¿ã‚‹</div>
            <div class="t-logic-text">
              ã‚ãªãŸã¯ã€Œç‚(4)ã€ã¨ã€Œæ°´(1)ã€ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚
            </div>
            <div class="t-row">
              <div style="text-align:center;">
                <span class="t-highlight">ç‚:4</span> <span class="t-arrow">></span> <span class="t-highlight-b">æ°´:1</span>
              </div>
            </div>
          </div>
          <div class="t-step">
            <div class="t-step-num">STEP 2 : çŸ³ç¢‘ã«å•ã†</div>
            <div class="t-logic-text">
              çŸ³ç¢‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åˆ¤å®šã—ã¾ã™ã€‚<br>
              ã‚‚ã—ã€çµæœãŒ <span class="t-result-mock t-res-true">TRUE</span> ã ã£ãŸã‚‰â€¦ï¼Ÿ
            </div>
            <div class="t-row">
              <div class="t-stone-mock">çŸ³ç¢‘: ç‚ã¨æ°´</div>
              <div class="t-arrow">â†’</div>
              <div class="t-result-mock t-res-true">TRUE (çœŸå®Ÿ)</div>
            </div>
            <div class="t-logic-text">
              çŸ³ç¢‘ã¯<strong>ã€ŒãŠå‰ã®å…¥åŠ›ã—ãŸã€ç‚ > æ°´ã€ã¨ã„ã†é–¢ä¿‚æ€§ã¯æ­£ã—ã„ãã€</strong>ã¨è¨€ã£ã¦ã„ã¾ã™ã€‚
            </div>
          </div>
          <div class="t-step" style="border-color: #d4af37;">
            <div class="t-step-num" style="background:#d4af37; color:#000;">STEP 3 : ãƒ«ãƒ¼ãƒ«ç¢ºå®šï¼</div>
            <div class="t-logic-text">
              å…¥åŠ›ã—ãŸé–¢ä¿‚æ€§(4>1)ãŒè‚¯å®šã•ã‚ŒãŸã®ã§ã€ã“ã®çŸ³ç¢‘ã®æ­£ä½“ã¯<strong>ã€Œç‚ > æ°´ã€ã®ãƒ«ãƒ¼ãƒ«</strong>ã ã¨ç¢ºå®šã—ã¾ã™ï¼
            </div>
            <div class="t-conclusion">
              â˜…æ¨ç†å®Œäº†<br>
              æ­£è§£ã®ã‚³ãƒ¼ãƒ‰ã‚‚å¿…ãšã€Œç‚ > æ°´ã€ã«ãªã£ã¦ã„ã¾ã™ã€‚<br>
              ã€Œç‚ãŒæ°´ã‚ˆã‚Šå°ã•ã„ã€çµ„ã¿åˆã‚ã›ã¯å…¨ã¦ä¸æ­£è§£ãªã®ã§ã€Ã—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚
            </div>
          </div>
        </div>
      </div>
      <button class="btn btn-std" style="width:100%; box-sizing:border-box;" onclick="closeHelp()">ç†è§£ã—ãŸ</button>
    </div>
  </div>

    <div id="result-modal" class="modal-overlay">
    <div class="seal-broken">å°å°è§£é™¤</div>
    <div style="color:#ccc; margin-top:10px;">çœŸå®Ÿã®ãƒ«ãƒ¼ãƒ³:</div>
    <div class="answer-reveal" id="final-code"></div>
    <div id="result-details" style="width:90%; max-width:400px; background:#222; padding:10px; border-radius:8px; margin-bottom:20px; text-align:left; max-height:30vh; overflow-y:auto; border:1px solid #444;"></div>
    
    <div style="color:#fff; margin-bottom:20px; font-size:0.9rem;">
      åˆ°é”ãƒ©ã‚¦ãƒ³ãƒ‰: <span id="final-round" class="en-font" style="font-size:1.2rem; color:#d4af37; margin-right:15px;"></span>
      ç·æ¤œè¨¼æ•°: <span id="final-checks" class="en-font" style="font-size:1.2rem; color:#d4af37;"></span>å›
    </div>

    <div style="display:flex; gap:10px; width:90%; max-width:350px;">
      <button class="btn btn-std" style="justify-content:center; flex:1;" onclick="reviewBoard()">ç›¤é¢ã‚’è¦‹ã‚‹</button>
      <button class="btn btn-std" style="justify-content:center; flex:1; background:#d4af37; color:#000; border-color:#fff;" onclick="location.reload()">æ¬¡ã®éºè·¡ã¸</button>
    </div>
  </div>


  <div id="id-modal" class="modal-overlay">
    <div style="background:#111; padding:20px; border:1px solid #444; border-radius:10px; width:80%; max-width:300px;">
      <h3 style="color:#fff; margin-top:0;">çŸ³ç¢‘IDã‚’å…¥åŠ›</h3>
      <input type="text" id="input-seed" placeholder="ä¾‹: A1B2C" style="width:100%; padding:10px; font-size:1.2rem; text-align:center; margin-bottom:15px; background:#222; border:1px solid #555; color:#fff; font-family:'Cinzel', serif; text-transform:uppercase;">
      <div style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">é›£æ˜“åº¦ã‚’é¸æŠã—ã¦é–‹å§‹:</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
        <button class="btn btn-std" style="width:auto; padding:10px; font-size:0.8rem; margin:0;" onclick="startFromId('standard')">åŸºæœ¬</button>
        <button class="btn btn-hard" style="width:auto; padding:10px; font-size:0.8rem; margin:0;" onclick="startFromId('hard')">é«˜é›£åº¦</button>
        <button class="btn btn-night" style="width:auto; padding:10px; font-size:0.8rem; margin:0;" onclick="startFromId('nightmare')">æ‚ªå¤¢</button>
        <button class="btn btn-omega" style="width:auto; padding:10px; font-size:0.8rem; margin:0; border:1px solid #fff;" onclick="startFromId('omega')">Î©</button>
      </div>
      <button class="btn btn-std" style="margin-top:15px; width:100%; border-color:#555; color:#aaa;" onclick="closeIdModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="history-modal" class="modal-overlay">
    <div id="history-content">
      <div class="close-help" onclick="closeHistory()">Ã—</div>
      <h3 style="color:#fff; margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">æ¢æŸ»ã®è¨˜éŒ²</h3>
      <div id="history-list"></div>
    </div>
  </div>
  <div id="tut-overlay"></div> <div id="tut-box" class="tut-msg-box" style="display:none;">
    <div id="tut-text" class="tut-text">ã“ã“ã«èª¬æ˜ãŒå…¥ã‚Šã¾ã™</div>
    <div id="tut-pointer" class="tut-arrow" style="display:none;">â¬‡</div>
    <button id="tut-btn" class="tut-next-btn" onclick="nextTutorialStep()">æ¬¡ã¸</button>
  </div>
<script>
// --- LOGIC ENGINE v7.3 (Final Balance) ---

// ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ã®çŠ¶æ…‹å¤‰æ•°
let isTutorialMode = false;
let tutStep = 0;


class SeededRandom {
  constructor(seedStr) {
    let h = 2166136261 >>> 0;
    for (let i = 0; i < seedStr.length; i++) {
      h = Math.imul(h ^ seedStr.charCodeAt(i), 16777619);
    }
    this.a = h >>> 0;
  }
  next() {
    let t = this.a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }
}
let rng = null;

// --- è¿½åŠ ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
function colorize(text) {
  if (!text) return "";
  return text
    .replace(/ç‚/g, '<span style="color:#ff9999; font-weight:bold;">ç‚</span>')
    .replace(/æ°´/g, '<span style="color:#99ccff; font-weight:bold;">æ°´</span>')
    .replace(/é¢¨/g, '<span style="color:#99ffcc; font-weight:bold;">é¢¨</span>');
}


const POOL = [
  { name:"ç‚ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"ç‚ = å¶æ•°", f:(i,a,v)=>i%2==0 }, 
  { name:"ç‚ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"ç‚ = å¥‡æ•°", f:(i,a,v)=>i%2!=0 }, 
  { name:"æ°´ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"æ°´ = å¶æ•°", f:(i,a,v)=>a%2==0 }, 
  { name:"æ°´ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"æ°´ = å¥‡æ•°", f:(i,a,v)=>a%2!=0 }, 
  { name:"é¢¨ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"é¢¨ = å¶æ•°", f:(i,a,v)=>v%2==0 }, 
  { name:"é¢¨ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"é¢¨ = å¥‡æ•°", f:(i,a,v)=>v%2!=0 },

    // ç‚ãƒ»æ°´ãƒ»é¢¨ã¨1ã€œ5ã®é–¢ä¿‚ï¼ˆ<, =, >ï¼‰
  { name:"ç‚ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"ç‚ = 1", f:(i,a,v)=>i==1 },
  { name:"ç‚ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"ç‚ > 1", f:(i,a,v)=>i>1 },
  { name:"æ°´ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"æ°´ = 1", f:(i,a,v)=>a==1 },
  { name:"æ°´ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"æ°´ > 1", f:(i,a,v)=>a>1 },
  { name:"é¢¨ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"é¢¨ = 1", f:(i,a,v)=>v==1 },
  { name:"é¢¨ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"é¢¨ > 1", f:(i,a,v)=>v>1 },
  
  { name:"ç‚ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ = 2", f:(i,a,v)=>i==2 },
  { name:"ç‚ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ > 2", f:(i,a,v)=>i>2 },
  { name:"ç‚ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ < 2", f:(i,a,v)=>i<2 },
  { name:"æ°´ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ = 2", f:(i,a,v)=>a==2 },
  { name:"æ°´ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ > 2", f:(i,a,v)=>a>2 },
  { name:"æ°´ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ < 2", f:(i,a,v)=>a<2 },
  { name:"é¢¨ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ = 2", f:(i,a,v)=>v==2 },
  { name:"é¢¨ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ > 2", f:(i,a,v)=>v>2 },
  { name:"é¢¨ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ < 2", f:(i,a,v)=>v<2 },

  { name:"ç‚ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ = 3", f:(i,a,v)=>i==3 },
  { name:"ç‚ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ > 3", f:(i,a,v)=>i>3 },
  { name:"ç‚ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ < 3", f:(i,a,v)=>i<3 },
  { name:"æ°´ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ = 3", f:(i,a,v)=>a==3 },
  { name:"æ°´ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ > 3", f:(i,a,v)=>a>3 },
  { name:"æ°´ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ < 3", f:(i,a,v)=>a<3 },
  { name:"é¢¨ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ = 3", f:(i,a,v)=>v==3 },
  { name:"é¢¨ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ > 3", f:(i,a,v)=>v>3 },
  { name:"é¢¨ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ < 3", f:(i,a,v)=>v<3 },

  { name:"ç‚ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ = 4", f:(i,a,v)=>i==4 },
  { name:"ç‚ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ > 4", f:(i,a,v)=>i>4 },
  { name:"ç‚ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ < 4", f:(i,a,v)=>i<4 },
  { name:"æ°´ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ = 4", f:(i,a,v)=>a==4 },
  { name:"æ°´ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ > 4", f:(i,a,v)=>a>4 },
  { name:"æ°´ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ < 4", f:(i,a,v)=>a<4 },
  { name:"é¢¨ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ = 4", f:(i,a,v)=>v==4 },
  { name:"é¢¨ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ > 4", f:(i,a,v)=>v>4 },
  { name:"é¢¨ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ < 4", f:(i,a,v)=>v<4 },

  { name:"ç‚ã¨5ã®é–¢ä¿‚ (<, = )", desc:"ç‚ = 5", f:(i,a,v)=>i==5 },
  { name:"ç‚ã¨5ã®é–¢ä¿‚ (<, = )", desc:"ç‚ < 5", f:(i,a,v)=>i<5 },
  { name:"æ°´ã¨5ã®é–¢ä¿‚ (<, = )", desc:"æ°´ = 5", f:(i,a,v)=>a==5 },
  { name:"æ°´ã¨5ã®é–¢ä¿‚ (<, = )", desc:"æ°´ < 5", f:(i,a,v)=>a<5 },
  { name:"é¢¨ã¨5ã®é–¢ä¿‚ (<, = )", desc:"é¢¨ = 5", f:(i,a,v)=>v==5 },
  { name:"é¢¨ã¨5ã®é–¢ä¿‚ (<, = )", desc:"é¢¨ < 5", f:(i,a,v)=>v<5 },

  { name:"ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ > æ°´", f:(i,a,v)=>i>a }, 
  { name:"ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ < æ°´", f:(i,a,v)=>i<a }, 
  { name:"ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ = æ°´", f:(i,a,v)=>i==a },
  { name:"æ°´ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"æ°´ > é¢¨", f:(i,a,v)=>a>v }, 
  { name:"æ°´ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"æ°´ < é¢¨", f:(i,a,v)=>a<v }, 
  { name:"æ°´ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"æ°´ = é¢¨", f:(i,a,v)=>a==v },
  { name:"ç‚ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ > é¢¨", f:(i,a,v)=>i>v }, 
  { name:"ç‚ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ < é¢¨", f:(i,a,v)=>i<v }, 
  { name:"ç‚ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ = é¢¨", f:(i,a,v)=>i==v },

  { name:"æœ€å¤§å€¤ã®æ‰€åœ¨ (â‰§)", desc:"ç‚ãŒæœ€å¤§ (ä»–ä»¥ä¸Š)", f:(i,a,v)=>i>=a && i>=v }, 
  { name:"æœ€å¤§å€¤ã®æ‰€åœ¨ (â‰§)", desc:"æ°´ãŒæœ€å¤§ (ä»–ä»¥ä¸Š)", f:(i,a,v)=>a>=i && a>=v }, 
  { name:"æœ€å¤§å€¤ã®æ‰€åœ¨ (â‰§)", desc:"é¢¨ãŒæœ€å¤§ (ä»–ä»¥ä¸Š)", f:(i,a,v)=>v>=i && v>=a }, 
  { name:"æœ€å°å€¤ã®æ‰€åœ¨ (â‰¦)", desc:"ç‚ãŒæœ€å° (ä»–ä»¥ä¸‹)", f:(i,a,v)=>i<=a && i<=v }, 
  { name:"æœ€å°å€¤ã®æ‰€åœ¨ (â‰¦)", desc:"æ°´ãŒæœ€å° (ä»–ä»¥ä¸‹)", f:(i,a,v)=>a<=i && a<=v }, 
  { name:"æœ€å°å€¤ã®æ‰€åœ¨ (â‰¦)", desc:"é¢¨ãŒæœ€å° (ä»–ä»¥ä¸‹)", f:(i,a,v)=>v<=i && v<=a }, 

  { name:"åˆè¨ˆã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"åˆè¨ˆ = å¶æ•°", f:(i,a,v)=>(i+a+v)%2==0 },
  { name:"åˆè¨ˆã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"åˆè¨ˆ = å¥‡æ•°", f:(i,a,v)=>(i+a+v)%2!=0 },
  { name:"åˆè¨ˆã¨6ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ < 6", f:(i,a,v)=>(i+a+v)<6 },
  { name:"åˆè¨ˆã¨6ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ â‰§ 6", f:(i,a,v)=>(i+a+v)>=6 },
  { name:"åˆè¨ˆã¨10ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ < 10", f:(i,a,v)=>(i+a+v)<10 },
  { name:"åˆè¨ˆã¨10ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ â‰§ 10", f:(i,a,v)=>(i+a+v)>=10 },

  { name:"ç´ æ•°ã®æœ‰ç„¡ (ã‚ã‚Š, ãªã—)", desc:"ç´ æ•°ã‚’å«ã‚€", f:(i,a,v)=>[i,a,v].some(n=>[2,3,5].includes(n)) },
  { name:"ç´ æ•°ã®æœ‰ç„¡ (ã‚ã‚Š, ãªã—)", desc:"ç´ æ•°ã‚’å«ã¾ãªã„", f:(i,a,v)=>![i,a,v].some(n=>[2,3,5].includes(n)) },

  { name:"ç‚+æ°´ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+æ°´ > 5", f:(i,a,v)=>(i+a)>5 },
  { name:"ç‚+æ°´ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+æ°´ < 5", f:(i,a,v)=>(i+a)<5 },
  { name:"ç‚+æ°´ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+æ°´ = 5", f:(i,a,v)=>(i+a)==5 },
  { name:"æ°´+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´+é¢¨ > 5", f:(i,a,v)=>(a+v)>5 },
  { name:"æ°´+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´+é¢¨ < 5", f:(i,a,v)=>(a+v)<5 },
  { name:"æ°´+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´+é¢¨ = 5", f:(i,a,v)=>(a+v)==5 },
  { name:"ç‚+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+é¢¨ > 5", f:(i,a,v)=>(i+v)>5 },
  { name:"ç‚+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+é¢¨ < 5", f:(i,a,v)=>(i+v)<5 },
  { name:"ç‚+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+é¢¨ = 5", f:(i,a,v)=>(i+v)==5 },

  { name:"å¶æ•°ã®æ•° (0, 1, 2)", desc:"å¶æ•°ãŒ0å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n%2==0).length==0 },
  { name:"å¶æ•°ã®æ•° (0, 1, 2)", desc:"å¶æ•°ãŒ1å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n%2==0).length==1 },
  { name:"å¶æ•°ã®æ•° (0, 1, 2)", desc:"å¶æ•°ãŒ2å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n%2==0).length==2 },
  { name:"1ã®æ•° (0, 1, 2, 3)", desc:"1ã‚’å«ã¾ãªã„", f:(i,a,v)=>[i,a,v].filter(n=>n==1).length==0 },
  { name:"1ã®æ•° (0, 1, 2, 3)", desc:"1ãŒ1å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==1).length==1 },
  { name:"1ã®æ•° (0, 1, 2, 3)", desc:"1ãŒ2å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==1).length==2 },
  { name:"1ã®æ•° (0, 1, 2, 3)", desc:"1ãŒ3å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==1).length==3 },
  { name:"3ã®æ•° (0, 1, 2, 3)", desc:"3ã‚’å«ã¾ãªã„", f:(i,a,v)=>[i,a,v].filter(n=>n==3).length==0 },
  { name:"3ã®æ•° (0, 1, 2, 3)", desc:"3ãŒ1å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==3).length==1 },
  { name:"3ã®æ•° (0, 1, 2, 3)", desc:"3ãŒ2å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==3).length==2 },
  { name:"3ã®æ•° (0, 1, 2, 3)", desc:"3ãŒ3å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==3).length==3 },
  
  
  { name:"é †åºã®æ³•å‰‡ (æ˜‡é †, é™é †, é †ä¸åŒ)", desc:"æ˜‡é † (ç‚ < æ°´ < é¢¨)", f:(i,a,v)=> (i < a && a < v) },
  { name:"é †åºã®æ³•å‰‡ (æ˜‡é †, é™é †, é †ä¸åŒ)", desc:"é™é † (ç‚ > æ°´ > é¢¨)", f:(i,a,v)=> (i > a && a > v) },
  { name:"é †åºã®æ³•å‰‡ (æ˜‡é †, é™é †, é †ä¸åŒ)", desc:"é †ä¸åŒ (ãƒãƒ©ãƒãƒ©)", f:(i,a,v)=> !((i < a && a < v) || (i > a && a > v)) },


  { name:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(0 , 1 , 2)", desc:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(0ç®‡æ‰€)", f:(i,a,v)=> {
      let c = 0;
      if(Math.abs(i-a) === 1) c++;
      if(Math.abs(a-v) === 1) c++;
      return c === 0;
  }},
  { name:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(0 , 1 , 2)", desc:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(1ç®‡æ‰€)", f:(i,a,v)=> {
      let c = 0;
      if(Math.abs(i-a) === 1) c++;
      if(Math.abs(a-v) === 1) c++;
      return c === 1;
  }},
  { name:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(0 , 1 , 2)", desc:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(å®Œå…¨é€£çµ)", f:(i,a,v)=> {
      let c = 0;
      if(Math.abs(i-a) === 1) c++;
      if(Math.abs(a-v) === 1) c++;
      return c === 2;
  }},
  { name:"2ã¤ã®åŒã˜æ•°å­— (ãªã—, 1çµ„)", desc:"2ã¤ã®åŒã˜æ•°å­—ã¯ãªã„ (ã™ã¹ã¦ç•°ãªã‚‹)", f:(i,a,v)=> (i!=a && a!=v && i!=v) },
  { name:"2ã¤ã®åŒã˜æ•°å­— (ãªã—, 1çµ„)", desc:"2ã¤åŒã˜ã¯1ã¤", f:(i,a,v)=> {
      // 3ã¤åŒã˜(ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰)ã¯é™¤å¤–ã—ã¦ã€å³å¯†ã«ã€Œ2ã¤ã ã‘åŒã˜ã€å ´åˆ
      if (i===a && a===v) return false; 
      return (i===a || a===v || i===v);
  }},

  { name:"æœ€å¤§ã¨æœ€å°ã®å·®(0 ,1 ,2 ,3 ,4)", desc:"æœ€å¤§ã¨æœ€å°ã®å·®ãŒ 0 (ã™ã¹ã¦åŒã˜)", f:(i,a,v)=> (Math.max(i,a,v) - Math.min(i,a,v)) === 0 },
  { name:"æœ€å¤§ã¨æœ€å°ã®å·®(0 ,1 ,2 ,3 ,4)", desc:"æœ€å¤§ã¨æœ€å°ã®å·®ãŒ 1 ", f:(i,a,v)=> (Math.max(i,a,v) - Math.min(i,a,v)) === 1 },
  { name:"æœ€å¤§ã¨æœ€å°ã®å·®(0 ,1 ,2 ,3 ,4)", desc:"æœ€å¤§ã¨æœ€å°ã®å·®ãŒ 2 ", f:(i,a,v)=> (Math.max(i,a,v) - Math.min(i,a,v)) === 2 },
  { name:"æœ€å¤§ã¨æœ€å°ã®å·®(0 ,1 ,2 ,3 ,4)", desc:"æœ€å¤§ã¨æœ€å°ã®å·®ãŒ 3 ", f:(i,a,v)=> (Math.max(i,a,v) - Math.min(i,a,v)) === 3 },
  { name:"æœ€å¤§ã¨æœ€å°ã®å·®(0 ,1 ,2 ,3 ,4)", desc:"æœ€å¤§ã¨æœ€å°ã®å·®ãŒ 4 ", f:(i,a,v)=> (Math.max(i,a,v) - Math.min(i,a,v)) === 4 },

  { name:"åˆè¨ˆãŒç‰¹å®šã®å€æ•°(2, 3, 5)", desc:"åˆè¨ˆãŒ 2ã®å€æ•° ", f:(i,a,v)=> (i+a+v)%2 === 0 },
  { name:"åˆè¨ˆãŒç‰¹å®šã®å€æ•°(2, 3, 5)", desc:"åˆè¨ˆãŒ 3ã®å€æ•°", f:(i,a,v)=> (i+a+v)%3 === 0 },
  { name:"åˆè¨ˆãŒç‰¹å®šã®å€æ•°(2, 3, 5)", desc:"åˆè¨ˆãŒ 5ã®å€æ•°", f:(i,a,v)=> (i+a+v)%5 === 0 },

  { name:"åˆè¨ˆå€¤ãŒç´ æ•°ã‹ã©ã†ã‹", desc:"åˆè¨ˆãŒç´ æ•° (3,5,7,11,13)", f:(i,a,v)=> {
      const sum = i+a+v;
      return [3, 5, 7, 11, 13].includes(sum);
  }},
  { name:"åˆè¨ˆå€¤ãŒç´ æ•°ã‹ã©ã†ã‹", desc:"åˆè¨ˆãŒç´ æ•°ã§ã¯ãªã„", f:(i,a,v)=> {
      const sum = i+a+v;
      return ![3, 5, 7, 11, 13].includes(sum);
  }},


];

let state = { 
  ans:{i:0,a:0,v:0}, rules:[], round:1, mana:0, maxMana:3, 
  liarIndex:-1, stoneCount:5, isOmega:false,
  currentSeed: "", currentMode: "",
  doomLimit: 0 // ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶é™(0ã¯ç„¡åˆ¶é™)
};

function generateSeed(length) {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

function limitInput(el) {
  if(el.value < 1) el.value = 1;
  if(el.value > 5) el.value = 5;
}

function initMatrix() {
  const grid = document.getElementById('logic-matrix');
  grid.innerHTML = '<div></div>'; 
  for(let n=1; n<=5; n++) grid.innerHTML += `<div class="grid-header">${n}</div>`;
  const rows = [
    {label:"ç‚", color:"#ff9999", id:"m-i"},
    {label:"æ°´", color:"#99ccff", id:"m-a"},
    {label:"é¢¨", color:"#99ffcc", id:"m-v"}
  ];
  rows.forEach(r => {
    grid.innerHTML += `<div class="grid-row-label" style="color:${r.color}">${r.label}</div>`;
    for(let n=1; n<=5; n++) {
      grid.innerHTML += `<div class="grid-cell" id="${r.id}-${n}" onclick="toggleCell(this)"></div>`;
    }
  });
  document.querySelectorAll('.memo-btn').forEach(btn => {
    btn.classList.remove('is-o');
    btn.classList.remove('is-x');
  });
}
function toggleCell(el) {
  if(el.classList.contains('cell-x')) {
    el.classList.remove('cell-x'); el.classList.add('cell-o');
  } else if(el.classList.contains('cell-o')) {
    el.classList.remove('cell-o');
  } else { el.classList.add('cell-x'); }
}
function toggleMemo(el) {
  if(el.classList.contains('is-x')) {
    el.classList.remove('is-x');
  } else if(el.classList.contains('is-o')) {
    el.classList.remove('is-o'); el.classList.add('is-x');
  } else { el.classList.add('is-o'); }
}
function toggleMemoArea() {
  document.getElementById('memo-pad').classList.toggle('closed');
}

function setBackground(mode) {
    const body = document.body;
    switch(mode) {
        case 'standard': body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #1a252e 0%, #05080a 100%)"; break;
        case 'hard': body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #3e1a1a 0%, #0a0505 100%)"; break;
        case 'nightmare': body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #2c1a3e 0%, #08050a 100%)"; break;
        case 'chaos': body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #333 0%, #000 100%)"; break;
        case 'omega': body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #000 0%, #111 100%)"; break;
    }
}

 function startGame(mode) {
  isTutorialMode = false; // â˜…è¿½åŠ : é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤º
  const newSeed = generateSeed(5);
  initGame(mode, newSeed);
}

function startFromId(mode) {
  const input = document.getElementById('input-seed');
  const seed = input.value.trim().toUpperCase();
  if(!seed) { alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  closeIdModal();
  initGame(mode, seed);
}

function initGame(mode, seed) {
  document.getElementById('loading-indicator').style.display = 'block';
  
  rng = new SeededRandom(seed);
  state.currentSeed = seed;
  state.currentMode = mode;
  
  setTimeout(() => {
    state.round = 1;
    state.mana = 0;
    state.totalChecks = 0;
    
    state.maxMana = (mode === 'nightmare') ? 2 : 3;
    state.doomLimit = (mode === 'nightmare') ? 5 : 0; 
    state.stoneCount = (mode === 'standard') ? 4 : 5;
    state.isOmega = (mode === 'omega');

    const resultBtn = document.getElementById('btn-show-result');
    if(resultBtn) resultBtn.style.display = 'none';
    
    let success = false;
    let attempts = 0;
    const maxAttempts = 10000; // è©¦è¡Œå›æ•°
    
    while(!success && attempts < maxAttempts) {
      attempts++;
      state.ans = {
        i: Math.floor(rng.next()*5)+1,
        a: Math.floor(rng.next()*5)+1,
        v: Math.floor(rng.next()*5)+1
      };
      
      // 1. ä»Šå›ã®ç­”ãˆã§ã€ŒTRUEã€ã«ãªã‚‹ãƒ«ãƒ¼ãƒ«ã‚’å…¨æŠ½å‡º
      let validRules = POOL.filter(r => r.f(state.ans.i, state.ans.a, state.ans.v) === true);
      
      // ãã‚‚ãã‚‚æ­£è§£ãƒ«ãƒ¼ãƒ«ãŒå°‘ãªã™ãã‚‹å ´åˆã¯ãƒ‘ã‚¹
      if(validRules.length < state.stoneCount) continue;

      // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
      let temp = [...validRules];
      for (let i = temp.length - 1; i > 0; i--) {
          const j = Math.floor(rng.next() * (i + 1));
          [temp[i], temp[j]] = [temp[j], temp[i]];
      }

      // --- â˜…ã“ã“ã‹ã‚‰é¸å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¿®æ­£ç‰ˆï¼‰---
      let picked = [];

      // ãƒ•ã‚§ãƒ¼ã‚º1: é‡è¤‡ï¼ˆã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆï¼‰ã‚’é¿ã‘ã¦é¸ã¶
      for(let r of temp) {
        if(picked.some(p => p.name === r.name)) continue; // å®Œå…¨ä¸€è‡´ã¯å¸¸ã«NG
        if(isConflict(picked, r)) continue; // ä¼¼ãŸãƒ«ãƒ¼ãƒ«ã‚‚é¿ã‘ã‚‹

        picked.push(r);
        if(picked.length === state.stoneCount) break;
      }

      // ãƒ•ã‚§ãƒ¼ã‚º2: ã‚‚ã—æ•°ãŒè¶³ã‚Šãªã‘ã‚Œã°ã€é‡è¤‡ã‚’è¨±å®¹ã—ã¦è£œå……ã™ã‚‹ï¼ˆç”Ÿæˆå¤±æ•—ã‚’é˜²ããŸã‚ï¼‰
      if(picked.length < state.stoneCount) {
        for(let r of temp) {
          if(picked.length === state.stoneCount) break;
          // ã™ã§ã«é¸ã‚“ã ã‚‚ã®ã¨ã€Œåå‰ãŒå®Œå…¨ä¸€è‡´ã€ã—ã¦ãªã‘ã‚Œã°æ¡ç”¨ï¼ˆisConflictã¯ç„¡è¦–ï¼‰
          if(!picked.some(p => p.name === r.name)) {
            picked.push(r);
          }
        }
      }
      
      // ãã‚Œã§ã‚‚è¶³ã‚Šãªã„å ´åˆï¼ˆæ¥µã‚ã¦ç¨€ï¼‰ã¯ã‚„ã‚Šç›´ã—
      if(picked.length < state.stoneCount) continue;

      // --- é¸å®šå®Œäº† ---

      // è§£ãŒ1ã¤ã«å®šã¾ã‚‹ã‹ã©ã†ã‹ã®æ¤œè¨¼ï¼ˆã‚«ã‚ªã‚¹ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰
      let matches = 0;
      // é«˜é€ŸåŒ–ã®ãŸã‚ã€æ¤œè¨¼ãƒ«ãƒ¼ãƒ—ã¯å°‘ã—è»½é‡åŒ–ã—ã¦ã‚‚ã‚ˆã„ãŒã€ã“ã“ã§ã¯æ­£ç¢ºæ€§é‡è¦–
      for(let i=1; i<=5; i++) {
        for(let a=1; a<=5; a++) {
          for(let v=1; v<=5; v++) {
             if(picked.every(rule => rule.f(i,a,v))) matches++;
          }
        }
      }

      if(matches === 1) {
        if(mode === 'chaos') {
          // ã‚«ã‚ªã‚¹ãƒ¢ãƒ¼ãƒ‰: å˜˜ã¤ãã‚’æ··ãœã¦ã‚‚è§£ã‘ã‚‹ã‹åˆ¤å®š
          const tempLiar = Math.floor(rng.next()*state.stoneCount);
          let chaosSolutions = 0;
          
          // ç°¡æ˜“æ¤œè¨¼: ã‚«ã‚ªã‚¹ã¯è¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã„ã®ã§ã€ç™ºè¦‹æ¬¡ç¬¬æ¡ç”¨ã™ã‚‹
          // (æœ¬æ¥ã¯å…¨æ¢ç´¢ã™ã¹ãã ãŒã€ç”Ÿæˆå¤±æ•—å›é¿ã‚’å„ªå…ˆ)
          for(let i=1; i<=5; i++) {
            for(let a=1; a<=5; a++) {
              for(let v=1; v<=5; v++) {
                 let trueCount = 0;
                 picked.forEach((r, idx) => {
                   let res = r.f(i, a, v);
                   if(idx === tempLiar) res = !res;
                   if(res) trueCount++;
                 });
                 if(trueCount === state.stoneCount) chaosSolutions++;
              }
            }
          }
          if(chaosSolutions === 1) {
            state.rules = picked;
            state.liarIndex = tempLiar;
            success = true;
          }
        } else {
          // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
          state.rules = picked;
          state.liarIndex = -1;
          success = true;
        }
      }
    }

    document.getElementById('loading-indicator').style.display = 'none';

    if(!success) {
      alert("ç”Ÿæˆå¤±æ•—: æ¡ä»¶ã«åˆã†ãƒ‘ã‚ºãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®IDã‚’è©¦ã™ã‹ã€ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ¬¡ã¯å¿…ãšæˆåŠŸã™ã‚‹ã‚ˆã†ã«ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰ã‚’å¤‰ãˆã‚‹ãªã©ã®å‡¦ç†
      rng = new SeededRandom(generateSeed(5)); 
    } else {
      document.getElementById('title-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
      setBackground(mode);
      updateHUD();
      document.getElementById('log-container').innerHTML = '';
      document.getElementById('chaos-warning').style.display = (mode === 'chaos') ? 'block' : 'none';
      
      const hud = document.querySelector('.hud');
      const oldId = document.getElementById('current-id-display');
      if(oldId) oldId.remove();
      
      hud.insertAdjacentHTML('afterend', 
        `<div id="current-id-display" style="text-align:center; color:#555; font-size:0.7rem; margin-top:-10px;">ID: <span style="font-family:'Cinzel',serif; color:#777;">${state.currentSeed}</span></div>`
      );

      document.getElementById('omega-rule-area').style.display = state.isOmega ? 'block' : 'none';
      initMatrix();
      renderProphecies();
    }
  }, 100);
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°: ç¾åœ¨é¸æŠä¸­ã®ãƒ¡ãƒ¢æ¬„ã‚’è¨˜æ†¶ã™ã‚‹
let activeOmegaInput = null;

function renderProphecies() {
  const c = document.getElementById('prophecy-container');
  c.innerHTML = '';
  const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
  
  // --- 1. Omegaãƒ¢ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆè¡¨ç¤ºéƒ¨åˆ† (ã‚¿ãƒƒãƒ—å…¥åŠ›å¯¾å¿œ) ---
  if (state.isOmega) {
    const listContainer = document.getElementById('omega-list');
    listContainer.innerHTML = '';
    let shuffledRules = [...state.rules];
    
    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¡¨ç¤ºï¼ˆãƒã‚¿ãƒãƒ¬é˜²æ­¢ï¼‰
    // â€»seedä¾å­˜ã®ãƒ©ãƒ³ãƒ€ãƒ ã ã¨å†æç”»ã§é †åºãŒå¤‰ã‚ã‚‰ãªã„ã‚ˆã†å·¥å¤«ãŒå¿…è¦ã§ã™ãŒã€
    // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«æ¯å›ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã€ã‚ã‚‹ã„ã¯å›ºå®šã§ã‚‚OKã§ã™ã€‚
    // ä»Šå›ã¯ã€Œå…¥åŠ›ã—ã‚„ã™ã•ã€å„ªå…ˆã§ã€å…ƒã®é…åˆ—é †(state.rules)ã§ã‚‚è‰¯ã„ã§ã™ãŒã€
    // ç­”ãˆãŒãƒãƒ¬ãªã„ã‚ˆã†ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã™ã€‚
    let displayRules = [...state.rules];
    displayRules.sort(() => Math.random() - 0.5); // ç°¡æ˜“ã‚·ãƒ£ãƒƒãƒ•ãƒ«

    displayRules.forEach(r => {
      const item = document.createElement('div');
      item.className = 'omega-list-item';
      item.innerHTML = colorize(r.name);
      
      // â˜…ã“ã“ãŒæ–°æ©Ÿèƒ½: ã‚¯ãƒªãƒƒã‚¯æ™‚ã®æŒ™å‹•
      item.onclick = () => {
        if (activeOmegaInput) {
          // ãƒ¡ãƒ¢æ¬„ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€ãã“ã«æ–‡å­—ã‚’è¿½è¨˜ã™ã‚‹
          // (ã™ã§ã«æ–‡å­—ãŒã‚ã‚Œã°ã‚«ãƒ³ãƒã§åŒºåˆ‡ã‚‹)
          const currentText = activeOmegaInput.value;
          const newText = r.name.split(' (')[0]; // ã‚«ãƒƒã‚³æ›¸ãã®èª¬æ˜ã¯çœã„ã¦çŸ­ãã™ã‚‹
          
          if(currentText) {
             activeOmegaInput.value = currentText + ", " + newText;
          } else {
             activeOmegaInput.value = newText;
          }
          // å…¥åŠ›å¾Œã‚‚ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¶­æŒï¼ˆé€£ç¶šå…¥åŠ›ç”¨ï¼‰
          activeOmegaInput.focus();
        } else {
          // é¸æŠã•ã‚Œã¦ãªã‘ã‚Œã°ã€å¾“æ¥é€šã‚Šã€Œå–ã‚Šæ¶ˆã—ç·šã€ã®ON/OFF
          item.classList.toggle('excluded'); 
        }
      };
      listContainer.appendChild(item);
    });
  }

  // --- 2. çŸ³ç¢‘ã®ç”Ÿæˆéƒ¨åˆ† ---
  state.rules.forEach((r, idx) => {
    // ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
    let wrapper = document.createElement('div');
    
    let div = document.createElement('div');
    if (state.isOmega) {
      // Omegaãƒ¢ãƒ¼ãƒ‰ï¼ˆ???è¡¨ç¤ºï¼‰
      div.className = 'stone is-mystery';
      div.id = `stone-${idx}`;
      div.innerHTML = `<div class="stone-text" style="font-size:1.8rem;">???</div>`;
    } else {
      // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
      div.className = 'stone';
      div.id = `stone-${idx}`;
      div.innerHTML = `
        <div class="stone-content">
          <div class="stone-title">äºˆè¨€ ${names[idx]}</div>
          <div class="stone-text">${colorize(r.name)}</div> </div>
        <div class="stone-id">${names[idx]}</div>
      `;
    }
    div.onclick = () => checkProphecy(idx, r, div);
    wrapper.appendChild(div);

    // â˜…ã“ã“ãŒæ–°æ©Ÿèƒ½: Omegaãƒ¢ãƒ¼ãƒ‰ãªã‚‰ãƒ¡ãƒ¢æ¬„ã‚’è¿½åŠ 
    if (state.isOmega) {
      const memoBox = document.createElement('div');
      memoBox.className = 'omega-memo-box';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'omega-memo-input';
      input.placeholder = `äºˆè¨€${names[idx]} ã®æ¨ç†ãƒ¡ãƒ¢ (ãƒªã‚¹ãƒˆã‚¿ãƒƒãƒ—ã§å…¥åŠ›)`;
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸã‚‰ã€Œã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå…¥åŠ›æ¬„ã€ã¨ã—ã¦è¨˜æ†¶
      input.onfocus = () => { activeOmegaInput = input; };
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸã‚‰ã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰è§£é™¤
      // (ãƒªã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯ã®ç¬é–“ã«å¤–ã‚Œã¦ã—ã¾ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®é…å»¶)
      input.onblur = () => { 
        setTimeout(() => {
          if(activeOmegaInput === input) activeOmegaInput = null;
        }, 200);
      };
      
      memoBox.appendChild(input);
      wrapper.appendChild(memoBox);
    }

    c.appendChild(wrapper);
  });
}


// é‡è¤‡ãƒ«ãƒ¼ãƒ«æ’é™¤ç”¨ã®åˆ¤å®šé–¢æ•°
function isConflict(pickedList, newRule) {
  // ãƒã‚§ãƒƒã‚¯å¯¾è±¡: "ã€‡ã€‡ã¨[æ•°å­—]ã®é–¢ä¿‚" ã¨ã„ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åå‰
  // ä¾‹: "ç‚ã¨3ã®é–¢ä¿‚", "åˆè¨ˆã¨10ã®é–¢ä¿‚", "æ°´+é¢¨ã¨5ã®é–¢ä¿‚" ãªã©
  const re = /^(.+)ã¨\d+ã®é–¢ä¿‚/;

  const matchNew = newRule.name.match(re);
  if(matchNew) {
    const key = matchNew[1]; // "ç‚", "æ°´", "åˆè¨ˆ" ãªã©ã‚’æŠœãå‡ºã™
    
    // ã™ã§ã«é¸ã°ã‚ŒãŸãƒ«ãƒ¼ãƒ«(pickedList)ã®ä¸­ã«ã€åŒã˜ã‚­ãƒ¼ã‚’æŒã¤ã‚‚ã®ãŒç„¡ã„ã‹æ¢ã™
    return pickedList.some(p => {
       const matchP = p.name.match(re);
       return matchP && matchP[1] === key;
    });
  }
  return false;
}

function checkProphecy(idx, rule, el) {
  if(isTutorialMode && tutStep !== 6 && tutStep !== 12 && tutStep !== 15) return;
  if(state.mana >= state.maxMana) return;
  const i = +document.getElementById('r1').value;
  const a = +document.getElementById('r2').value;
  const v = +document.getElementById('r3').value;
  if(!i || !a || !v) return;
  
  // â˜…ã“ã“ã‚’ä¿®æ­£: æœ€åˆã®åˆ¤å®šæ™‚ã«ãƒ­ãƒƒã‚¯ï¼†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  if(state.mana === 0) {
    document.getElementById('r1').disabled = true;
    document.getElementById('r2').disabled = true;
    document.getElementById('r3').disabled = true;
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    const msg = document.getElementById('rune-lock-msg');
    if(msg) msg.style.display = 'block';
  }

  let isTrue = rule.f(i, a, v);
  if(idx === state.liarIndex) isTrue = !isTrue;

  state.mana++;
  state.totalChecks++; // â˜…è¿½åŠ : æ¤œè¨¼å›æ•°ã‚’ãƒ—ãƒ©ã‚¹
  updateHUD();
  
  const log = document.getElementById('log-container');
  const entry = document.createElement('div');
  const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
  entry.className = isTrue ? 'log-entry log-true' : 'log-entry log-false';
  
  // â˜…ä¿®æ­£: ãƒ­ã‚°ã«äºˆè¨€åã‚’è¡¨ç¤ºã—ã€è¦‹ã‚„ã™ããƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
  entry.innerHTML = `
    <div style="width:100%;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:bold;">R${state.round} äºˆè¨€${names[idx]}</span>
        <strong>${isTrue ? "TRUE" : "FALSE"}</strong>
      </div>
      <div style="font-size:0.85rem; margin:4px 0; color:#ddd; padding-left:8px; border-left:2px solid rgba(255,255,255,0.2);">
        ${state.isOmega ? "???" : colorize(rule.name)}
      </div>
      <div style="text-align:right;">
        <span class="log-nums">${i}-${a}-${v}</span>
      </div>
    </div>
  `;
  log.prepend(entry);

  if(state.mana >= state.maxMana) {
    document.querySelectorAll('.stone').forEach(s => s.classList.add('disabled'));
  }
}

// ãƒ©ã‚¦ãƒ³ãƒ‰é€²è¡Œé–¢æ•°ï¼ˆãƒ­ãƒƒã‚¯è§£é™¤ï¼†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¶ˆå»å¯¾å¿œç‰ˆï¼‰
function nextRound() {
  // ãƒãƒŠãŒæ®‹ã£ã¦ã„ã‚‹ã®ã«æŠ¼ã—ãŸå ´åˆï¼ˆé€šå¸¸æ™‚ã®ã¿ç„¡åŠ¹åŒ–ï¼‰
  if(state.mana === 0 && !isTutorialMode) return;
  
  // --- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ä¸­ã®ç‰¹åˆ¥å‡¦ç† ---
  if(isTutorialMode) {
    // ã‚¹ãƒ†ãƒƒãƒ—9ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†æŒ‡ç¤ºï¼‰ã®æ™‚ã ã‘è¨±å¯
    if(tutStep === 9) {
      state.round++;
      state.mana = 0;
      updateHUD();
      
      // â˜…ä¿®æ­£: å…¥åŠ›ãƒ­ãƒƒã‚¯è§£é™¤ & ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™ï¼
      document.getElementById('r1').disabled = false;
      document.getElementById('r2').disabled = false;
      document.getElementById('r3').disabled = false;
      
      const msg = document.getElementById('rune-lock-msg');
      if(msg) msg.style.display = 'none'; // â† ã“ã“ã§æ¶ˆã—ã¦ã„ã¾ã™

      document.querySelectorAll('.stone').forEach(s => s.classList.remove('disabled'));
      
      nextTutorialStep(); // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
    }
    return;
  }

  // --- é€šå¸¸æ™‚ã®å‡¦ç† ---
  
  // ãƒŠã‚¤ãƒˆãƒ¡ã‚¢ãƒ¢ãƒ¼ãƒ‰ç­‰ã®ã€Œæ­»ã®å®£å‘Šã€ãƒã‚§ãƒƒã‚¯
  if(state.doomLimit > 0 && state.round >= state.doomLimit) {
    finishGame(false, "éºè·¡å´©å£Š");
    return;
  }
  
  state.round++;
  state.mana = 0;
  updateHUD();

  // â˜…ä¿®æ­£: å…¥åŠ›ãƒ­ãƒƒã‚¯è§£é™¤ & ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™ï¼
  document.getElementById('r1').disabled = false;
  document.getElementById('r2').disabled = false;
  document.getElementById('r3').disabled = false;
  
  const msg = document.getElementById('rune-lock-msg');
  if(msg) msg.style.display = 'none'; // â† ã“ã“ã§æ¶ˆã—ã¦ã„ã¾ã™

  document.querySelectorAll('.stone').forEach(s => s.classList.remove('disabled'));
}


function attemptUnlock() {
  const i = +document.getElementById('r1').value;
  const a = +document.getElementById('r2').value;
  const v = +document.getElementById('r3').value;
  const isCorrect = (i === state.ans.i && a === state.ans.a && v === state.ans.v);
  
  finishGame(isCorrect);
}

// çµ‚äº†å‡¦ç†
function finishGame(isWin, titleOverride) {
  const modal = document.getElementById('result-modal');
  modal.style.display = 'flex';
  
  const title = document.querySelector('.seal-broken');
  if(isWin) {
    title.innerText = "å°å°è§£é™¤";
    title.style.color = "#fff";
  } else {
    title.innerText = titleOverride || "è§£é™¤å¤±æ•—";
    title.style.color = "#c0392b";
  }
  
  document.getElementById('final-code').innerText = `${state.ans.i} ${state.ans.a} ${state.ans.v}`;
  document.getElementById('final-round').innerText = state.round;
  
  // â˜…è¿½åŠ : æ¤œè¨¼å›æ•°ã‚’è¡¨ç¤º (å­˜åœ¨ãƒã‚§ãƒƒã‚¯ä»˜ã)
  const checksEl = document.getElementById('final-checks');
  if(checksEl) checksEl.innerText = state.totalChecks;

  saveHistory(isWin);

  const detailBox = document.getElementById('result-details');
  let html = '';
  const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
  state.rules.forEach((r, idx) => {
      const isLiar = (idx === state.liarIndex);
      const liarTag = isLiar ? '<span class="res-liar-txt">[å˜˜ã¤ã]</span> ' : '';
      html += `<div class="res-row">
        <div><strong>äºˆè¨€${names[idx]}</strong>: ${liarTag}${r.name}</div>
        <div style="color:#d4af37; padding-left:10px; font-size:0.85rem;">
           ğŸ‘‰ æ­£è§£ã®æ³•å‰‡: <strong>${r.desc}</strong>
        </div>
      </div>`;
  });
  detailBox.innerHTML = html;
}

function saveHistory(isWin) {
  const historyItem = {
    seed: state.currentSeed,
    mode: state.currentMode,
    round: state.round,
    win: isWin,
    date: new Date().toLocaleString()
  };
  let history = JSON.parse(localStorage.getItem('omega_history') || '[]');
  history.unshift(historyItem);
  if(history.length > 30) history.pop();
  localStorage.setItem('omega_history', JSON.stringify(history));
}

function showHistory() {
  const modal = document.getElementById('history-modal');
  const list = document.getElementById('history-list');
  const history = JSON.parse(localStorage.getItem('omega_history') || '[]');
  
  modal.style.display = 'flex';
  list.innerHTML = '';
  
  if(history.length === 0) {
    list.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">è¨˜éŒ²ãªã—</div>';
    return;
  }

  history.forEach(h => {
    const item = document.createElement('div');
    item.className = 'hist-item';
    let modeLabel = h.mode.toUpperCase();
    if(h.mode==='standard') modeLabel = 'STD';
    if(h.mode==='nightmare') modeLabel = 'NIGHT';
    
    item.innerHTML = `
      <div class="hist-left">
        <span class="hist-mode mode-${h.mode}">${modeLabel}</span>
        <span class="hist-id">#${h.seed}</span>
        <div class="hist-date">${h.date} - R${h.round}</div>
      </div>
      <div style="display:flex; align-items:center;">
        <span class="hist-result ${h.win ? 'res-win':'res-lose'}">${h.win ? 'WIN':'LOSE'}</span>
        <button class="btn-replay" onclick="startFromHistory('${h.mode}', '${h.seed}')">å†æŒ‘æˆ¦</button>
      </div>
    `;
    list.appendChild(item);
  });
}

function startFromHistory(mode, seed) {
  closeHistory();
  initGame(mode, seed);
}

function reviewBoard() {
  document.getElementById('result-modal').style.display = 'none';
  const resultBtn = document.getElementById('btn-show-result');
  if(resultBtn) resultBtn.style.display = 'flex';
  
  document.getElementById('r1').disabled = true;
  document.getElementById('r2').disabled = true;
  document.getElementById('r3').disabled = true;
  document.querySelectorAll('.stone').forEach(s => s.classList.add('disabled'));
  document.querySelectorAll('.btn-action').forEach(b => b.style.display = 'none');

  if(state.liarIndex !== -1) {
      const liarStone = document.getElementById(`stone-${state.liarIndex}`);
      if(liarStone) liarStone.classList.add('is-liar');
  }
  
  if(state.isOmega) {
      const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
      state.rules.forEach((r, idx) => {
          const s = document.getElementById(`stone-${idx}`);
          if(s) {
              s.innerHTML = `
                <div style="font-size:0.7rem; color:#aaa;">${names[idx]}</div>
                <div style="font-size:0.9rem; color:#fff;">${r.name}</div>
              `;
              s.style.background = "#222";
              s.style.border = "1px solid #777";
          }
      });
  }
}

function showResult() { document.getElementById('result-modal').style.display = 'flex'; }
function updateHUD() {
  // åˆ¶é™ãŒã‚ã‚‹å ´åˆ "1 / 5" ã®ã‚ˆã†ã«è¡¨ç¤º
  const roundText = (state.doomLimit > 0) ? `${state.round} / ${state.doomLimit}` : state.round;
  document.getElementById('ui-round').innerText = roundText;
  document.getElementById('ui-mana').innerText = `${state.mana}/${state.maxMana}`;
}
// ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºé–¢æ•°ï¼ˆÃ—ãƒœã‚¿ãƒ³å‰Šé™¤ãƒ»ç†è§£ã—ãŸãƒœã‚¿ãƒ³ç‰ˆï¼‰
function showHelp() {
  const modal = document.getElementById('help-modal');
  modal.style.display = 'flex';
  
  // HTMLç”Ÿæˆç”¨ã®å¤‰æ•°
  let difficultyHtml = '';
  const mode = state.currentMode || 'standard';

  // --- 1. é›£æ˜“åº¦åˆ¥ã®ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ« ---
  if (mode === 'nightmare') {
    difficultyHtml = `
      <div class="help-section" style="border-color:#9b59b6; background:rgba(44, 26, 62, 0.4);">
        <div class="help-title" style="color:#d7bde2;">â˜… NIGHTMARE (æ‚ªå¤¢) ã®ãƒ«ãƒ¼ãƒ«</div>
        <div class="help-text">
          <ul>
            <li><strong>æ­»ã®å®£å‘Š:</strong> <span style="color:#ff5555;">5ãƒ©ã‚¦ãƒ³ãƒ‰</span>çµŒéã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã€‚</li>
            <li><strong>é­”åŠ›æ¯æ¸‡:</strong> 1ãƒ©ã‚¦ãƒ³ãƒ‰ã®ãƒãƒŠã¯ <span style="color:#ff5555;">2ã¤</span> ã®ã¿ã€‚</li>
          </ul>
        </div>
      </div>`;
  } else if (mode === 'chaos') {
    difficultyHtml = `
      <div class="help-section" style="border-color:#95a5a6; background:rgba(50,50,50,0.4);">
        <div class="help-title" style="color:#ccc;">â˜… CHAOS (æ··æ²Œ) ã®ãƒ«ãƒ¼ãƒ«</div>
        <div class="help-text">
          <ul>
            <li><strong>å˜˜ã¤ã:</strong> çŸ³ç¢‘ã®ä¸­ã«1ã¤ã ã‘<span style="color:#ff5555;">ã€Œåˆ¤å®šã‚’é€†ã«ã™ã‚‹å˜˜ã¤ãã€</span>ãŒæ··ã–ã£ã¦ã„ã¾ã™ã€‚</li>
            <li>çŸ›ç›¾ã‚’è¦‹æŠœã„ã¦ã€å˜˜ã¤ãã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚</li>
          </ul>
        </div>
      </div>`;
  } else if (mode === 'omega') {
    difficultyHtml = `
      <div class="help-section" style="border-color:#fff; background:rgba(0,0,0,0.6);">
        <div class="help-title" style="color:#fff;">â˜… OMEGA (Î©) ã®ãƒ«ãƒ¼ãƒ«</div>
        <div class="help-text">
          <ul>
            <li><strong>ä¸å¯è¦–:</strong> å…¨ã¦ã®äºˆè¨€ã®å†…å®¹ãŒ <span style="color:#fff;">???</span> ã§ã™ã€‚</li>
            <li>å³ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰ã€é©ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’æ¨ç†ã—ã¦ãã ã•ã„ã€‚</li>
          </ul>
        </div>
      </div>`;
  } else if (mode === 'hard') {
     difficultyHtml = `
      <div class="help-section" style="border-color:#e74c3c; background:rgba(62, 26, 26, 0.4);">
        <div class="help-title" style="color:#f5b7b1;">â˜… HARD (é«˜é›£åº¦) ã®ãƒ«ãƒ¼ãƒ«</div>
        <div class="help-text">
          ã€Œç‚=1ã€ã®ã‚ˆã†ãªå˜ç´”ãªãƒ’ãƒ³ãƒˆãŒå‡ºç¾ã«ããã€<br>
          è¨ˆç®—ã‚„æ¯”è¼ƒãŒå¿…è¦ãªã€æ‰‹ã”ã‚ã„äºˆè¨€ãŒç™»å ´ã—ã‚„ã™ã„ã§ã™ã€‚
        </div>
      </div>`;
  }

  // --- 2. å…±é€šã‚¬ã‚¤ãƒ‰ ---
  const contentHtml = `
    <h2 style="text-align:center; margin-top:0; color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">éºè·¡è§£æãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h2>
    
    ${difficultyHtml}

    <div class="help-section">
      <div class="help-title">1. ã‚²ãƒ¼ãƒ ã®ç›®çš„</div>
      <div class="help-text">
        éš ã•ã‚ŒãŸæ­£è§£ã®æ•°å­—ï¼ˆ<span style="color:#ff9999">ç‚</span>ãƒ»<span style="color:#99ccff">æ°´</span>ãƒ»<span style="color:#99ffcc">é¢¨</span> ãã‚Œãã‚Œ1ã€œ5ï¼‰ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã§ã™ã€‚<br>
        ã„ããªã‚Šå½“ã¦ã‚‹ã®ã¯ç„¡ç†ãªã®ã§ã€<strong>ã€Œäºˆè¨€ã®çŸ³ç¢‘ã€</strong>ã«è³ªå•ã‚’ã—ã¦ã€å°‘ã—ãšã¤çµã‚Šè¾¼ã¿ã¾ã™ã€‚
      </div>
    </div>

    <div class="help-section">
      <div class="help-title">2. è§£æã®æµã‚Œ (å›³è§£)</div>
      <div class="help-text">
        ä¾‹ãˆã°ã€ã‚ã‚‹çŸ³ç¢‘ã«<strong>ã€Œåˆè¨ˆã¨10ã®é–¢ä¿‚ã€</strong>ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ãŒæ›¸ã‹ã‚Œã¦ã„ãŸã¨ã—ã¾ã™ã€‚
      </div>

      <div class="diagram-box">
        <div style="width:100%; text-align:left; font-size:0.8rem; color:#aaa; margin-bottom:5px;">â–¼ STEP 1: ä»®ã®æ•°å­—ã‚’ã‚»ãƒƒãƒˆ</div>
        <div style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;">
          <div style="border:1px solid #8a1c1c; color:#ff9999; padding:5px 10px; border-radius:4px;">ç‚: 4</div>
          <div style="border:1px solid #1c4e8a; color:#99ccff; padding:5px 10px; border-radius:4px;">æ°´: 5</div>
          <div style="border:1px solid #1c8a5e; color:#99ffcc; padding:5px 10px; border-radius:4px;">é¢¨: 2</div>
        </div>
        <div style="font-size:0.8rem; color:#fff;">åˆè¨ˆ = <strong>11</strong> ã®çŠ¶æ…‹ã§ã™ã€‚</div>
      </div>

      <div style="text-align:center; font-size:1.5rem; color:#d4af37; margin:-10px 0;">â¬‡</div>

      <div class="diagram-box">
        <div style="width:100%; text-align:left; font-size:0.8rem; color:#aaa; margin-bottom:5px;">â–¼ STEP 2: çŸ³ç¢‘ã«åˆ¤å®šã•ã›ã‚‹</div>
        <div class="d-stone" style="width:95%;">
          <span>äºˆè¨€Î²: åˆè¨ˆã¨10ã®é–¢ä¿‚</span>
          <span style="font-weight:bold;">åˆ¤å®š â–¶</span>
        </div>
        <div style="margin:5px 0;">ã‚‚ã—ã€çµæœãŒã“ã†å‡ºãŸã‚‰â€¦ï¼Ÿ</div>
        <div class="d-result d-true" style="padding:10px; width:80%; text-align:center;">TRUE (çœŸå®Ÿ)</div>
      </div>

      <div class="diagram-box" style="border-color:#d4af37; background:rgba(212, 175, 55, 0.1);">
        <div style="width:100%; text-align:left; font-size:0.8rem; color:#d4af37; font-weight:bold; margin-bottom:5px;">â–¼ STEP 3: æ¨ç†</div>
        <div class="help-text" style="font-size:0.85rem;">
          ã€Œåˆè¨ˆ11ã€ã§ã€ŒTRUEã€ãŒå‡ºãŸã€‚<br>
          â†’ ã¤ã¾ã‚Šã“ã®çŸ³ç¢‘ã¯<strong>ã€Œåˆè¨ˆ â‰§ 10ã€</strong>ã®ãƒ«ãƒ¼ãƒ«ã ã¨æ¨æ¸¬ã§ãã¾ã™ã€‚<br>
          (ã‚‚ã—ã€Œåˆè¨ˆï¼œ10ã€ãªã‚‰FALSEã«ãªã‚‹ã¯ãšã ã‹ã‚‰ã§ã™)
        </div>
      </div>
    </div>

    <div class="help-section" style="border-bottom:none;">
      <div class="help-title">3. ãƒ¡ãƒ¢ã‚’æ´»ç”¨ã›ã‚ˆ</div>
      <div class="help-text">
        ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ¡ãƒ¢ã‚’å–ã‚Šã€å¯èƒ½æ€§ã‚’çµã‚Šè¾¼ã‚“ã§ã„ãã¾ã—ã‚‡ã†ã€‚
      </div>
    </div>

    <button class="btn btn-std" style="width:100%; box-sizing:border-box; margin-top:10px; padding:15px; font-weight:bold; font-size:1.1rem; border-color:#d4af37; color:#d4af37;" onclick="closeHelp()">ç†è§£ã—ãŸï¼</button>
  `;

  const contentDiv = document.getElementById('help-content');
  contentDiv.innerHTML = contentHtml;
}

  // --- TUTORIAL LOGIC v2 ---
function startTutorial() {
  // ã‚¨ãƒ©ãƒ¼é˜²æ­¢: colorizeé–¢æ•°ãŒãªã„å ´åˆã®å¯¾ç­–
  if (typeof colorize !== 'function') {
    window.colorize = function(t) { return t; }; // ç„¡å®³ãªãƒ€ãƒŸãƒ¼é–¢æ•°ã‚’ä½œã‚‹
  }

  isTutorialMode = true;
  tutStep = 0;
  
  const loader = document.getElementById('loading-indicator');
  if(loader) loader.style.display = 'block';
  
  document.getElementById('title-screen').style.display = 'none';
  document.getElementById('game-screen').style.display = 'block';
  
  // --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´å‡¦ç† ---
  try {
    // 1. ãƒ†ã‚­ã‚¹ãƒˆåˆæœŸåŒ–
    const txt = document.getElementById('tut-text');
    if(txt) txt.innerHTML = '<div style="text-align:center; color:#888;">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>';

    // 2. ãƒãƒˆãƒªã‚¯ã‚¹ã¨ãƒ¡ãƒ¢é–¢é€£ã‚’éè¡¨ç¤º
    const matrix = document.getElementById('logic-matrix');
    if(matrix) matrix.style.display = 'none';
    
    const memoBtn = document.querySelector('.memo-toggle-btn');
    if(memoBtn) memoBtn.style.display = 'none';
    
    const memoPad = document.getElementById('memo-pad');
    if(memoPad) memoPad.style.display = 'none';

    // "LOGIC MATRIX..." ãƒ©ãƒ™ãƒ«ã®éè¡¨ç¤ºï¼ˆå®‰å…¨ç­–ï¼‰
    const runeContainer = document.querySelector('.rune-container');
    if(runeContainer) {
       const matrixLabel = runeContainer.nextElementSibling;
       // ãƒ©ãƒ™ãƒ«ã‹ã©ã†ã‹ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
       if(matrixLabel && matrixLabel.innerText && matrixLabel.innerText.includes('LOGIC')) {
          matrixLabel.style.display = 'none';
       }
    }

    // 3. ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«BOXç§»å‹•
    const gameScreen = document.getElementById('game-screen');
    const tutBox = document.getElementById('tut-box');
    const prophecyContainer = document.getElementById('prophecy-container');
    
    if (gameScreen && tutBox && prophecyContainer) {
      gameScreen.insertBefore(tutBox, prophecyContainer);
      tutBox.classList.add('tut-embedded-mode');
      tutBox.style.display = 'flex';
    }
  } catch(e) {
    console.error("Layout Setup Error:", e);
  }
  // ---------------------------
  
  setTimeout(() => {
    try {
      // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç›¤é¢ã‚»ãƒƒãƒˆ
      state.round = 1;
      state.mana = 0;
      state.totalChecks = 0; // â˜…ã“ã‚Œã‚’è¿½åŠ ï¼
      state.maxMana = 3;
      state.stoneCount = 3;
      state.ans = { i:4, a:4, v:3 }; 
      state.liarIndex = -1;
      state.isOmega = false;
      
      // ãƒ«ãƒ¼ãƒ«ã‚»ãƒƒãƒˆ
      state.rules = [
        { name:"ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ = æ°´", f:(i,a,v)=>i==a },
        { name:"åˆè¨ˆã¨10ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ â‰§ 10", f:(i,a,v)=>(i+a+v)>=10 },
        { name:"é¢¨ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"é¢¨ = å¥‡æ•°", f:(i,a,v)=>v%2!=0 }
      ];
      
      setBackground('standard');
      updateHUD();
      
      const logContainer = document.getElementById('log-container');
      if(logContainer) logContainer.innerHTML = '';
      
      const chaosWarn = document.getElementById('chaos-warning');
      if(chaosWarn) chaosWarn.style.display = 'none';
      
      const omegaArea = document.getElementById('omega-rule-area');
      if(omegaArea) omegaArea.style.display = 'none';
      
      // ãƒãƒˆãƒªã‚¯ã‚¹å†åˆæœŸåŒ–ï¼†éè¡¨ç¤º
      initMatrix();
      const matrix = document.getElementById('logic-matrix');
      if(matrix) matrix.style.display = 'none';
      
      const c = document.getElementById('prophecy-container');
      if(c) {
        c.innerHTML = '';
        const names = ["Î±", "Î²", "Î³"];
        state.rules.forEach((r, idx) => {
          let div = document.createElement('div');
          div.className = 'stone';
          div.id = `stone-${idx}`;
          div.innerHTML = `
            <div class="stone-content">
              <div class="stone-title">äºˆè¨€ ${names[idx]}</div>
              <div class="stone-text">${colorize(r.name)}</div>
            </div>
            <div class="stone-id">${names[idx]}</div>
          `;
          div.onclick = () => { if(isTutorialMode) handleTutClick('stone', idx); };
          c.appendChild(div);
        });
      }

      document.getElementById('r1').value = "";
      document.getElementById('r2').value = "";
      document.getElementById('r3').value = "";

      nextTutorialStep(); 
    } catch(e) {
      alert("ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + e);
      console.error(e);
    } finally {
      if(loader) loader.style.display = 'none';
    }
  }, 500);
}


// æ•°å­—ã‚’é †ç•ªã«å…¥åŠ›ã™ã‚‹æ¼”å‡ºé–¢æ•°
function typeNumber(n1, n2, n3, callback) {
  const r1 = document.getElementById('r1');
  const r2 = document.getElementById('r2');
  const r3 = document.getElementById('r3');
  
  // å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼å›é¿
  if(!r1 || !r2 || !r3) {
    console.error("ã‚¨ãƒ©ãƒ¼: å…¥åŠ›æ¬„(r1, r2, r3)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    if(callback) callback(); // ç„¡ç†ã‚„ã‚Šæ¬¡ã¸é€²ã‚ã‚‹
    return;
  }
  
  // å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
  r1.value = ""; r2.value = ""; r3.value = "";
  
  // ãƒªã‚ºãƒ ã‚ˆãå…¥åŠ› (0.7ç§’, 1.2ç§’, 1.6ç§’å¾Œ)
  setTimeout(() => { r1.value = n1; }, 700);
  setTimeout(() => { r2.value = n2; }, 1200);
  setTimeout(() => { r3.value = n3; }, 1600);
  
  // å…¨ã¦çµ‚ã‚ã£ãŸå¾Œã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œ (3ç§’å¾Œ)
  setTimeout(() => {
    if(callback) callback();
  }, 3000);
}

// ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ä¸­ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©
function handleTutClick(type, idx) {
  // ã‚¹ãƒ†ãƒƒãƒ—6: çŸ³ç¢‘Î±
  if(tutStep === 6 && type === 'stone' && idx === 0) {
    checkProphecy(0, state.rules[0], document.getElementById('stone-0'));
    nextTutorialStep(); 
  }
  // ã‚¹ãƒ†ãƒƒãƒ—12: çŸ³ç¢‘Î²
  if(tutStep === 12. && type === 'stone' && idx === 1) {
    checkProphecy(1, state.rules[1], document.getElementById('stone-1'));
    nextTutorialStep(); 
  }
  // â˜…è¿½åŠ  ã‚¹ãƒ†ãƒƒãƒ—15: çŸ³ç¢‘Î³
  if(tutStep === 15 && type === 'stone' && idx === 2) {
    checkProphecy(2, state.rules[2], document.getElementById('stone-2'));
    nextTutorialStep(); 
  }
}



const originalAttemptUnlock = attemptUnlock;
attemptUnlock = function() {
  if(isTutorialMode) {
    // â˜…å¤‰æ›´: çµ‚äº†ã‚¹ãƒ†ãƒƒãƒ— 19
    if(tutStep === 19) {
      document.querySelectorAll('.tut-highlight').forEach(e => e.classList.remove('tut-highlight'));
      document.querySelectorAll('.tut-blink').forEach(e => e.classList.remove('tut-blink'));

      const tutBox = document.getElementById('tut-box');
      if(tutBox) {
        tutBox.style.display = 'none';
        tutBox.classList.remove('tut-embedded-mode');
        document.body.appendChild(tutBox); 
      }
      document.getElementById('tut-overlay').style.display = 'none';
      
      const matrix = document.getElementById('logic-matrix');
      if(matrix) matrix.style.display = '';
      
      const memoBtn = document.querySelector('.memo-toggle-btn');
      if(memoBtn) memoBtn.style.display = '';
      
      const memoPad = document.getElementById('memo-pad');
      if(memoPad) memoPad.style.display = '';
      
      const runeContainer = document.querySelector('.rune-container');
      if(runeContainer) {
          const matrixLabel = runeContainer.nextElementSibling;
          if(matrixLabel) matrixLabel.style.display = '';
      }

      const modal = document.getElementById('result-modal');
      modal.style.display = 'flex';
      document.querySelector('.seal-broken').innerText = "è§£æä¸­...";
      document.querySelector('.seal-broken').style.color = "#aaa";
      document.getElementById('final-code').innerText = "";
      document.getElementById('result-details').innerHTML = "";
      
      setTimeout(() => {
          originalAttemptUnlock(); 
          setTimeout(() => {
             alert("ãŠã‚ã§ã¨ã†ï¼\nãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯å®Œäº†ã ã€‚\nã•ã‚ã€æœ¬ç•ªã®éºè·¡ã¸æŒ‘ã‚‚ã†ï¼");
          }, 3000);
      }, 3000);
    }
  } else {
    originalAttemptUnlock();
  }
};


function nextTutorialStep() {
  tutStep++;
  const txt = document.getElementById('tut-text');
  const btn = document.getElementById('tut-btn');
  
  // ãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll('.tut-highlight').forEach(e => e.classList.remove('tut-highlight'));
  document.querySelectorAll('.tut-blink').forEach(e => e.classList.remove('tut-blink'));
  document.getElementById('tut-overlay').style.display = 'block'; 
  
  btn.style.display = 'block'; 
  btn.innerText = "æ¬¡ã¸ â–¶";

  // æ–‡å­—è‰²å®šç¾©
  const cFire = '<span style="color:#ff9999; font-weight:bold;">ç‚</span>';
  const cWater = '<span style="color:#99ccff; font-weight:bold;">æ°´</span>';
  const cWind = '<span style="color:#99ffcc; font-weight:bold;">é¢¨</span>';
  const cTrue = '<span style="color:#2ecc71;">TRUE</span>';
  const cFalse = '<span style="color:#e74c3c;">FALSE</span>';

  switch(tutStep) {
    case 1:
      txt.innerHTML = `ã‚ˆã†ã“ãã€æ¢æ±‚è€…ã‚ˆã€‚<br>
      ã¾ãšã¯ç”»é¢å³ä¸Šã‚’è¦‹ã¦ã»ã—ã„ã€‚<br>
      ã“ã“ã«ã¯ç¾åœ¨ã®<b>ã€Œãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã€</b>ãŒåˆ»ã¾ã‚Œã¦ã„ã‚‹ã€‚<br>
      ä¸€åº¦ã‚»ãƒƒãƒˆã—ãŸæ•°å­—ã¯ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ã¾ã§å¤‰æ›´ã§ããªã„ãã€‚`;
      const uiRound = document.getElementById('ui-round');
      if(uiRound && uiRound.parentNode) uiRound.parentNode.classList.add('tut-highlight', 'tut-blink');
      break;

    case 2:
      txt.innerHTML = `ãã—ã¦ãã®ä¸ŠãŒ<b>ã€ŒãƒãƒŠã€</b>ã ã€‚<br>
      çŸ³ç¢‘ã«å•ã„ã‹ã‘ã‚‹ãŸã³ã« 1 æ¶ˆè²»ã™ã‚‹ã€‚<br>
      ãƒãƒŠãŒå°½ãã‚‹ã¨ã€å›å¾©ã™ã‚‹ãŸã‚ã«æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚€ã—ã‹ãªããªã‚‹ã€‚<br>
      æ…£ã‚Œã‚‹ã¾ã§ã¯1ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒãƒŠã‚’ä½¿ã„åˆ‡ã‚‹ã®ãŒã‚ªã‚¹ã‚¹ãƒ¡ã ã€‚<br>
      æ…£ã‚Œã¦ããŸã‚‰ãªã‚‹ã¹ãå°‘ãªã„ãƒãƒŠã¨ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®ã‚¯ãƒªã‚¢ã‚’ç›®æŒ‡ãã†ã€‚`;
      const manaBar = document.querySelector('.mana-bar');
      if(manaBar) manaBar.classList.add('tut-highlight', 'tut-blink');
      break;

    case 3:
      txt.innerHTML = `ã§ã¯ã€èª¿æŸ»ã‚’å§‹ã‚ã‚ˆã†ã€‚<br>
      å›ã®ç›®çš„ã¯ã€çŸ³ç¢‘ã«<b>ã€Œè³ªå•ã€</b>ã‚’ã—ã¦æ³•å‰‡ã‚’æš´ãã€éš ã•ã‚ŒãŸ<b>ã€Œ3ã¤ã®æ•°å­—ã€</b>ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã ã€‚`;
      break;
      
    case 4:
      txt.innerHTML = `ä¸‹ã«ã‚ã‚‹ã®ãŒ<b>ã€Œäºˆè¨€ã®çŸ³ç¢‘ã€</b>ã ã€‚<br>
      ã“ã‚Œã‚‰ã¯æ­£è§£ã®æ•°å­—ã«é–¢ã™ã‚‹ã€Œã‚ã‚‹æ³•å‰‡ã€ã‚’çŸ¥ã£ã¦ã„ã‚‹ã€‚<br>ã¾ãšã¯ã“ã‚Œã‚‰ã«æ³¨ç›®ã—ã¦ã»ã—ã„ã€‚`;
      const pContainer = document.getElementById('prophecy-container');
      if(pContainer) pContainer.classList.add('tut-highlight', 'tut-blink'); 
      break;

    case 5:
      txt.innerHTML = `ä¸Šã®å…¥åŠ›æ¬„ã‚’ä½¿ã£ã¦ã€çŸ³ç¢‘ã«è³ªå•ã‚’æŠ•ã’ã‹ã‘ã‚‹ã€‚<br>
      è©¦ã—ã«<b>ã€Œ1 - 1 - 1ã€</b>ã¨ã„ã†æ•°å­—ã‚’ã‚»ãƒƒãƒˆã—ã¦ã¿ã‚ˆã†ã€‚<br>
      (${cFire}:1, ${cWater}:1, ${cWind}:1 ã¨ã„ã†æ„å‘³ã )`;
      
      const runeBox = document.querySelector('.rune-container');
      if(runeBox) runeBox.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none';
      
      setTimeout(() => {
        if (typeof typeNumber !== 'function') {
           document.getElementById('r1').value = 1; document.getElementById('r2').value = 1; document.getElementById('r3').value = 1;
           btn.style.display = 'block'; btn.innerText = "OK"; return;
        }
        typeNumber(1, 1, 1, () => {
             txt.innerHTML = `ã‚ˆã—ã€‚ã€Œ1 - 1 - 1ã€ã¨ã‚»ãƒƒãƒˆå®Œäº†ã ã€‚<br>
             ã“ã‚Œã§çŸ³ç¢‘ã«èãæº–å‚™ãŒæ•´ã£ãŸã€‚<br>å³ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã‚Œã€‚`;
             btn.style.display = 'block'; btn.innerText = "OK";
        });
      }, 500);
      break;
      
    case 6:
      txt.innerHTML = `ã€Œã‚‚ã—æ­£è§£ãŒ 1-1-1 ã ã£ãŸã‚‰ã€ãŠå‰ã®æ³•å‰‡ã‚’æº€ãŸã™ã‹ï¼Ÿã€<br>
      ä¸€ç•ªä¸Šã®<b>ã€Œäºˆè¨€ Î±ã€</b>ã«ãã†èã„ã¦ã¿ã‚ˆã†ã€‚<br>
      ã‚¿ãƒƒãƒ—ã—ã¦åˆ¤å®šã‚’è¡Œãˆã€‚`;
      const s0 = document.getElementById('stone-0');
      if(s0) s0.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none'; 
      break;

    case 7: 
      const logTrue = `
        <div class="log-entry log-true" style="margin-top:10px; text-align:left;">
          <div style="width:100%;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:bold;">R1 äºˆè¨€Î±</span> <strong>TRUE</strong>
            </div>
            <div style="font-size:0.85rem; margin:4px 0; color:#ddd; padding-left:8px; border-left:2px solid rgba(255,255,255,0.2);">
              ${colorize("ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)")}
            </div>
            <div style="text-align:right;"><span class="log-nums">1-1-1</span></div>
          </div>
        </div>`;
      txt.innerHTML = `çŸ³ç¢‘ã®åå¿œãŒã‚ã£ãŸãï¼<br>${logTrue}<br>ã€Œ1-1-1ã€ã¯æ¡ä»¶ï¼ˆ${cFire} = ${cWater}ï¼‰ã‚’æº€ãŸã—ã¦ã„ã‚‹ãŸã‚ <b>TRUE</b> ã¨ãªã£ãŸã®ã ã€‚`;
      document.getElementById('log-container').classList.add('tut-highlight');
      break;

    case 8:
      txt.innerHTML = `ã“ã‚Œã§ã€Œ${cFire}ã¨${cWater}ãŒåŒã˜ã€ã¨ã‚ã‹ã£ãŸã€‚<br>
      ã•ã¦ã€åˆ¥ã®æ•°å­—ã‚’è©¦ã—ãŸã„ã¨ã“ã‚ã ãŒâ€¦<br>
      <b>ä¸€åº¦ã‚»ãƒƒãƒˆã—ãŸæ•°å­—(1-1-1)ã¯ã€ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ä¸­ã¯å¤‰æ›´ã§ããªã„ã€‚</b>`;
      break;

    // --- â˜…ã“ã“ã‹ã‚‰æ–°è¦è¿½åŠ  (ãƒ©ã‚¦ãƒ³ãƒ‰å¤‰æ›´) ---
    case 9:
      txt.innerHTML = `æ–°ã—ã„æ•°å­—ã‚’è©¦ã™ã«ã¯ã€æ™‚é–“ã‚’é€²ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚<br>
      å³ä¸‹ã®<b>ã€Œæ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ã€</b>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã‚Œã€‚<br>
      ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ãŒé€²ã‚€ã¨ãƒãƒŠã‚‚å›å¾©ã™ã‚‹ãï¼‰`;
      const nextBtn = document.querySelector('.btn-next');
      if(nextBtn) nextBtn.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none'; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã®ã‚’å¾…ã¤
      break;

    case 10:
      txt.innerHTML = `ã‚ˆã—ï¼ <b>ãƒ©ã‚¦ãƒ³ãƒ‰2</b> ã«çªå…¥ã—ãŸã€‚<br>
      ã“ã‚Œã§å…¥åŠ›æ¬„ã®ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚Œã€å†ã³è‡ªç”±ã«æ•°å­—ã‚’ã‚»ãƒƒãƒˆã§ãã‚‹ã€‚<br>
      ã•ã‚ã€æ¤œè¨¼ã®ç¶šãã ã€‚`;
      document.getElementById('ui-round').parentNode.classList.add('tut-highlight');
      break;
    // ------------------------------------

    case 11: // å…ƒCase9
      txt.innerHTML = `æ¬¡ã¯<b>ã€Œã‚ã–ã¨é–“é•ã£ãŸæ•°å­—ã€</b>ã‚’å…¥ã‚Œã¦åå¿œã‚’è¦‹ã‚‹ã®ãŒã‚³ãƒ„ã ã€‚<br>
      åˆè¨ˆãŒã¨ã¦ã‚‚å°ã•ã„<b>ã€Œ1 - 1 - 2ã€</b>ï¼ˆåˆè¨ˆ4ï¼‰ã‚’å…¥åŠ›ã—ã‚ˆã†ã€‚`;
      const runeBox2 = document.querySelector('.rune-container');
      if(runeBox2) runeBox2.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none';
      setTimeout(() => {
        if (typeof typeNumber !== 'function') {
           document.getElementById('r1').value = 1; document.getElementById('r2').value = 1; document.getElementById('r3').value = 2;
           btn.style.display = 'block'; btn.innerText = "OK"; return;
        }
        typeNumber(1, 1, 2, () => {
             btn.style.display = 'block'; btn.innerText = "OK";
        });
      }, 500);
      break;

    case 12:
      txt.innerHTML = `çœŸã‚“ä¸­ã®<b>ã€Œäºˆè¨€ Î²ã€</b>ã‚’ã‚¿ãƒƒãƒ—ã—ã‚ã€‚<br>
      ã“ã®çŸ³ç¢‘ã¯ã€Œåˆè¨ˆã€ã«é–¢ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’æŒã£ã¦ã„ã‚‹ã‚ˆã†ã ã€‚`;
      const s1 = document.getElementById('stone-1');
      if(s1) s1.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none';
      break;

    case 13: // å…ƒCase11
      const logFalse = `
        <div class="log-entry log-false" style="margin-top:10px; text-align:left;">
          <div style="width:100%;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:bold;">R2 äºˆè¨€Î²</span> <strong>FALSE</strong>
            </div>
            <div style="font-size:0.85rem; margin:4px 0; color:#ddd; padding-left:8px; border-left:2px solid rgba(255,255,255,0.2);">
              ${colorize("åˆè¨ˆã¨10ã®é–¢ä¿‚ (<, â‰§)")}
            </div>
            <div style="text-align:right;"><span class="log-nums">1-1-2</span></div>
          </div>
        </div>`;
      txt.innerHTML = `åˆ¤å®šãŒå‡ºãŸï¼<br>${logFalse}<br><b>FALSE</b>ï¼ˆå½ã‚Šï¼‰ã ã€‚<br>åˆè¨ˆ4ã§ã¯ãƒ€ãƒ¡ã‚‰ã—ã„ã€‚ã€Œåˆè¨ˆã¯ã‚‚ã£ã¨å¤§ãã„ï¼ˆ10ä»¥ä¸Šï¼‰ã€ã¨ã„ã†ã“ã¨ã ï¼`;
      document.getElementById('log-container').classList.add('tut-highlight');
      break;

    case 14: // å…ƒCase12
      txt.innerHTML = `FALSEãŒå‡ºãŸã“ã¨ã§ã€æ­£è§£ã‚’çµã‚Šè¾¼ã‚ãŸã€‚<br>
      ã—ã‹ã—ã¾ã æƒ…å ±ãŒè¶³ã‚Šãªã„ã€‚<br>
      å¿µã®ãŸã‚ã€ä¸€ç•ªä¸‹ã®<b>ã€Œäºˆè¨€ Î³ã€</b>ã‚‚èª¿ã¹ã¦ãŠã“ã†ã€‚`;
      break;

    case 15: // å…ƒCase13
      txt.innerHTML = `å…¥åŠ›æ•°å­—ã¯ã•ã£ãã¨åŒã˜<b>ã€Œ1 - 1 - 2ã€</b>ã®ã¾ã¾ã§ã„ã„ã€‚<br>
      ä¸€ç•ªä¸‹ã®<b>ã€Œäºˆè¨€ Î³ã€</b>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦åå¿œã‚’è¦‹ã‚‹ã‚“ã ã€‚`;
      const s2 = document.getElementById('stone-2');
      if(s2) s2.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none'; 
      break;

    case 16: // å…ƒCase14
      const logGamma = `
        <div class="log-entry log-false" style="margin-top:10px; text-align:left;">
          <div style="width:100%;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:bold;">R2 äºˆè¨€Î³</span> <strong>FALSE</strong>
            </div>
            <div style="font-size:0.85rem; margin:4px 0; color:#ddd; padding-left:8px; border-left:2px solid rgba(255,255,255,0.2);">
              ${colorize("é¢¨ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)")}
            </div>
            <div style="text-align:right;"><span class="log-nums">1-1-2</span></div>
          </div>
        </div>`;
      txt.innerHTML = `çµæœã¯â€¦<br>${logGamma}<br>
      <b>FALSE</b>ã ï¼<br>
      ä»Šã®é¢¨(2)ã¯å¶æ•°ã€‚ã¤ã¾ã‚Šã€æ­£è§£ã®${cWind}ã¯<b>ã€Œå¥‡æ•°ã€</b>ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼`;
      document.getElementById('log-container').classList.add('tut-highlight');
      break;

    case 17: // å…ƒCase15
      txt.innerHTML = `ã“ã‚Œã§ã™ã¹ã¦ã®æ¡ä»¶ãŒæƒã£ãŸãã€‚<br>
      <ul style="font-size:0.85rem; padding-left:20px; color:#ddd; text-align:left;">
        <li>äºˆè¨€Î±: ${cFire}ã¨${cWater}ã¯åŒã˜</li>
        <li>äºˆè¨€Î²: åˆè¨ˆã¯10ä»¥ä¸Š</li>
        <li>äºˆè¨€Î³: ${cWind}ã¯å¥‡æ•°</li>
      </ul>
      ã“ã‚Œã‚’æº€ãŸã™çµ„ã¿åˆã‚ã›ã¯â€¦<br>
      <span style="font-size:1.2rem; color:#d4af37; font-weight:bold;">ãã†ã€ã“ã‚Œã—ã‹ãªã„ï¼</span>`;
      break;

    case 18: // å…ƒCase16
      txt.innerHTML = `å°ãå‡ºã—ãŸç­”ãˆã€<b>ã€Œ4 - 4 - 3ã€</b>ã‚’å…¥åŠ›ã›ã‚ˆï¼<br>
      (åˆè¨ˆ11ã€é¢¨ã¯å¥‡æ•°ã€ç‚=æ°´ã¨æ¡ä»¶ã‚’å…¨ã¦æº€ãŸã—ã¦ã„ã‚‹)<br>
      â€»æœ¬æ¥ã¯ã€Œæ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ãªã„ã¨æ•°å­—ã‚’å¤‰ãˆã‚‰ã‚Œãªã„ãŒã€ä»Šã¯ç‰¹åˆ¥ã«ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚ã’ã‚ˆã†`;
      const runeBox3 = document.querySelector('.rune-container');
      if(runeBox3) runeBox3.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none';
      setTimeout(() => {
        if (typeof typeNumber !== 'function') {
           document.getElementById('r1').value = 4; document.getElementById('r2').value = 4; document.getElementById('r3').value = 3;
           btn.style.display = 'block'; btn.innerText = "OK"; return;
        }
        typeNumber(4, 4, 3, () => {
             btn.style.display = 'block'; btn.innerText = "OK";
        });
      }, 500);
      break;

    case 19: // å…ƒCase17
      txt.innerHTML = `ã“ã‚ŒãŒæ­£è§£ãªã‚‰ã€ã™ã¹ã¦ã®çŸ³ç¢‘ãŒ ${cTrue} ã«ãªã‚‹ã¯ãšã ã€‚<br>
      æœ€å¾Œã«<b>ã€Œå°å°è§£é™¤ã€</b>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ç­”ãˆåˆã‚ã›ã‚’ã—ã‚ˆã†ï¼`;
      const solveBtn = document.querySelector('.btn-solve');
      if(solveBtn) solveBtn.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none'; 
      break;
  }
}

// â–¼â–¼â–¼ ã“ã®éƒ¨åˆ†ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ â–¼â–¼â–¼

// ã‚¬ã‚¤ãƒ‰ã‚’é–‰ã˜ã‚‹
function closeHelp() {
  document.getElementById('help-modal').style.display = 'none';
}

// å±¥æ­´ã‚’é–‰ã˜ã‚‹
function closeHistory() {
  document.getElementById('history-modal').style.display = 'none';
}

// IDå…¥åŠ›ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
function showInputId() {
  document.getElementById('id-modal').style.display = 'flex';
}

// IDå…¥åŠ›ç”»é¢ã‚’é–‰ã˜ã‚‹
function closeIdModal() {
  document.getElementById('id-modal').style.display = 'none';
}

</script>
</body>
</html>
