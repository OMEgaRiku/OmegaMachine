<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>OMEGA STONE</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23d4af37%22 style=%22font-family:serif; font-weight:bold;%22>Î©</text></svg>">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-color: #050505;
    --text-main: #e0d0b0;
    --accent-color: #d4af37;
  }

  body {
    font-family: 'Shippori Mincho', serif;
    background-color: var(--bg-color);
    background-image: radial-gradient(circle at 50% 50%, #1a150e 0%, #000000 100%);
    color: var(--text-main);
    text-align: center;
    padding: 20px;
    margin: 0;
    min-height: 100vh;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    transition: background-image 1s ease;
  }
  .en-font { font-family: 'Cinzel', serif; }

  /* Title Screen */
  #title-screen {
    display: flex; flex-direction: column; justify-content: center; align-items: center; height: 90vh; animation: fadeIn 2s;
  }
  .game-title {
    font-family: 'Cinzel', serif; font-size: 2.5rem; font-weight: 900; letter-spacing: 3px;
    background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; color: transparent;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.3); margin-bottom: 5px;
  }

  /* Difficulty Buttons */
  .btn {
    background: rgba(0,0,0,0.5); border: 1px solid #777; color: #ccc; padding: 18px; margin: 8px;
    font-size: 1.1rem; font-family: 'Shippori Mincho', serif; font-weight: bold; cursor: pointer;
    width: 90%; max-width: 350px; position: relative; overflow: hidden; transition: 0.3s; border-radius: 8px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .btn:active { transform: scale(0.98); }
  
  .btn-std { border-color: #3498db; color: #aed6f1; box-shadow: 0 0 10px rgba(52, 152, 219, 0.2); }
  .btn-hard { border-color: #e74c3c; color: #f5b7b1; box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }
  .btn-night { border-color: #9b59b6; color: #d7bde2; box-shadow: 0 0 10px rgba(155, 89, 182, 0.2); }
    /* Chaos Button - èŒ¶è‰²ã«å¤‰æ›´ */
  .btn-chaos { border-color: #8d6e63; color: #d7ccc8; box-shadow: 0 0 10px rgba(141, 110, 99, 0.2); 
  }
  
  /* å±¥æ­´ã®ãƒ©ãƒ™ãƒ«è‰² - èŒ¶è‰² */
  .mode-chaos { background: #4e342e; color: #d7ccc8; }

  
  /* Omega Mode Styles */
  .btn-omega { 
    border-color: #fff; color: #fff; background: #000; 
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); font-family: 'Cinzel', serif;
  }

  /* Game Screen */
  #game-screen { display: none; max-width: 600px; margin: 0 auto; animation: slideIn 0.5s ease-out; }
  @keyframes slideIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

  .hud {
    display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.2);
    padding-bottom: 10px; margin-bottom: 20px; font-family: 'Cinzel', serif;
  }
  .hud-left { display: flex; gap: 8px; }
  .hud-btn { 
    cursor: pointer; font-size: 0.85rem; color: #aaa; border: 1px solid #555; 
    padding: 6px 12px; border-radius: 4px; background: rgba(0,0,0,0.6); 
    display: flex; align-items: center; justify-content: center;
  }
  .btn-guide { border-color: #d4af37; color: #f1c40f; font-weight: bold; }
  .mana-bar { font-size: 1.1rem; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }

  /* Rune Inputs */
  .rune-container {
    display: flex; justify-content: center; gap: 12px; margin-bottom: 20px;
    background: rgba(0,0,0,0.4); padding: 20px 10px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);
  }
  .rune-wrapper { position: relative; width: 80px; }
  .rune-label { position: absolute; top: -28px; left: 0; width: 100%; font-size: 0.8rem; font-weight: bold; }
  .rune-sub { font-size: 0.6rem; color: #888; display: block; margin-top: -2px; font-family: 'Cinzel', serif; }
  
  input.rune-input {
    width: 100%; height: 75px; font-size: 2.2rem; text-align: center; background: #0f0f0f;
    border: 2px solid #333; border-radius: 8px; color: #fff; font-family: 'Cinzel', serif; transition: 0.3s;
  }
  input:focus { outline: none; border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
  
  #r1 { border-color: #8a1c1c; color: #ff9999; } /* Ignis */
  #r2 { border-color: #1c4e8a; color: #99ccff; } /* Aqua */
  #r3 { border-color: #1c8a5e; color: #99ffcc; } /* Ventus */

  /* Logic Matrix */
  .logic-grid {
    display: grid; grid-template-columns: auto repeat(5, 1fr); gap: 4px;
    margin: 10px 0 10px 0; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
  }
  .grid-header { font-family: 'Cinzel', serif; font-weight: bold; color: #888; font-size: 0.8rem; padding-bottom: 5px;}
  .grid-row-label { text-align: right; padding-right: 10px; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; justify-content: flex-end;}
  
  .grid-cell {
    background: rgba(255,255,255,0.05); border: 1px solid #333; aspect-ratio: 1; border-radius: 4px;
    cursor: pointer; display: flex; justify-content: center; align-items: center;
    font-weight: bold; font-size: 1.2rem; user-select: none; transition: 0.1s;
  }
  
  /* Shared Cell Styles */
  .cell-x, .memo-btn.is-x { background: rgba(200, 50, 50, 0.2); color: #ff5555; border-color: #552222; }
  .cell-x::after, .memo-btn.is-x::after { content: "Ã—"; }
  
  .cell-o, .memo-btn.is-o { background: rgba(50, 200, 50, 0.2); color: #55ff55; border-color: #225522; }
  .cell-o::after, .memo-btn.is-o::after { content: "â—‹"; }

  /* Memo Toggle & Area */
  .memo-toggle-btn {
    width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #444; border-radius: 6px;
    color: #aaa; font-size: 0.8rem; cursor: pointer; margin-bottom: 5px; font-weight: bold; transition: 0.2s;
  }
  .memo-toggle-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

  .memo-area {
    background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 8px;
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out; overflow: hidden;
  }
  .memo-area.closed { display: none; }

  .memo-row { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
  .memo-label { width: 100%; font-size: 0.7rem; color: #888; margin-bottom: 2px; text-align: left; padding-left: 5px;}
  .memo-btn {
    border: 1px solid #444; background: #111; color: #ccc; padding: 6px 8px; border-radius: 4px;
    font-size: 0.75rem; cursor: pointer; min-width: 45px; display: flex; align-items: center; justify-content: center; gap: 3px; user-select: none;
  }
  .memo-btn::after { margin-left: 2px; font-weight: bold; }

  /* Prophecy List */
  .prophecy-list { display: flex; flex-direction: column; gap: 10px; }
  .stone {
    background: linear-gradient(to right, rgba(30,30,30,0.9), rgba(10,10,10,0.9));
    border: 1px solid #444; padding: 10px 15px;
    border-radius: 5px; cursor: pointer; text-align: left; transition: 0.2s;
    display: flex; justify-content: space-between; align-items: center; position: relative;
    backdrop-filter: blur(5px);
  }
  .stone:hover { border-color: #aaa; transform: translateX(5px); }
  .stone::after { content: ''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: #666; }
  .stone.disabled { opacity: 0.4; pointer-events: none; }
  .stone-title { font-size: 0.75rem; color: #888; margin-bottom: 2px; }
  .stone-text { font-size: 1rem; color: #fff; font-weight: bold; letter-spacing: 0.5px; }
  .stone-id { font-family: 'Cinzel', serif; font-size: 1.4rem; color: #444; margin-left: 10px;}
  
      /* Mystery Stone (Omega) - åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼‰ */
  .stone.is-mystery {
    color: #d4af37;
    background: radial-gradient(circle, #1a1505 0%, #000 100%);
    border: 1px solid #d4af37;
    display: flex; justify-content: center; align-items: center;
    
    /* ã“ã“ã«ã‚ã£ãŸ animation ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ */
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
    transition: all 0.5s ease;
  }

  /* ç€åœ°ã—ãŸå¾Œã«è¿½åŠ ã™ã‚‹ã‚¯ãƒ©ã‚¹ï¼ˆã“ã“ã§å…‰ã‚‰ã›ã‚‹ï¼‰ */
  .stone.is-mystery.omega-pulsing {
    animation: omegaPulse 3s infinite alternate;
  }

  /* åˆ¤å®šæ¸ˆã¿ï¼ˆdisabledï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .stone.is-mystery.disabled {
    animation: none; /* å…‰ã‚’æ­¢ã‚ã‚‹ */
    border-color: #333;
    color: #333;
    background: #050505;
    box-shadow: none;
    opacity: 0.3;
    filter: grayscale(100%);
    cursor: not-allowed;
  }

  .stone.is-mystery .stone-text { 
    font-family: 'Cinzel', serif; 
    font-size: 1.5rem; 
    letter-spacing: 5px; 
    color: #d4af37;
    text-shadow: 0 0 8px rgba(212, 175, 55, 0.6);
  }
  
  .stone.is-mystery.disabled .stone-text {
    color: #333;
    text-shadow: none;
  }

  /* é»„é‡‘ã®å‘¼å¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes omegaPulse {
    0% {
      box-shadow: 0 0 5px rgba(212, 175, 55, 0.2), inset 0 0 10px rgba(0,0,0,0.8);
      border-color: #8a7326;
    }
    100% {
      box-shadow: 0 0 25px rgba(212, 175, 55, 0.5), inset 0 0 20px rgba(212, 175, 55, 0.1);
      border-color: #ffe066;
    }
  }



  /* Log */
  .log-area {
    margin-top: 20px; border-top: 1px solid #444; padding-top: 10px; max-height: 200px; overflow-y: auto; text-align: left; font-size: 0.9rem;
  }
  .log-entry { margin-bottom: 5px; padding: 8px 10px; border-radius: 4px; background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
    /* --- å¤‰æ›´ç‚¹: ãƒ­ã‚°ã®é…è‰² (æ•°å­—ã®è‰²ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«å¤‰æ›´) --- */
  /* TRUE: ç·‘â†’é‡‘ (ç¥è–ãªæ­£è§£) */
  .log-true { border-left: 3px solid #d4af37; color: #ffd700; background: rgba(212, 175, 55, 0.1); }
  /* FALSE: èµ¤â†’ç´« (è™šç„¡ãƒ»ä¸æ­£è§£) */
  .log-false { border-left: 3px solid #9b59b6; color: #d7bde2; background: rgba(155, 89, 182, 0.1); }
  
  /* æ•°å­—ã®å¼·èª¿ç”¨ã‚¯ãƒ©ã‚¹ */
  .num-fire { color: #ff9999; font-weight: bold; }
  .num-water { color: #99ccff; font-weight: bold; }
  .num-wind { color: #99ffcc; font-weight: bold; }

  /* --- å¤‰æ›´ç‚¹: ãƒ¡ãƒ¢æ¬„ã‚’ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆåŒ– --- */
  .memo-textarea {
    width: 100%;
    height: 120px;
    background: #000;
    border: 1px solid #444;
    color: #e0d0b0;
    padding: 10px;
    font-family: 'Shippori Mincho', serif;
    font-size: 0.9rem;
    resize: none;
    box-sizing: border-box;
    border-radius: 4px;
    line-height: 1.5;
    transition: 0.3s;
  }
  .memo-textarea:focus {
    outline: none;
    border-color: #d4af37;
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
    background: #111;
  }
  .memo-textarea::placeholder {
    color: #444;
    font-style: italic;
  }
  .log-nums { font-family: 'Cinzel', serif; font-weight: bold; background: #000; padding: 1px 6px; border-radius: 3px; letter-spacing: 1px; font-size: 0.8rem;}

  /* Action Bar */
  .action-bar { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
  .btn-action { flex: 1; padding: 15px; font-weight: bold; font-family: 'Shippori Mincho', serif; border: none; cursor: pointer; border-radius: 8px; font-size: 1rem; color: #fff; transition: 0.2s; }
  .btn-next { background: #333; border: 1px solid #555; }
  .btn-solve { background: #27ae60; box-shadow: 0 4px 0 #1e8449; }

  /* Chaos Bar */
  .chaos-bar { background: #c0392b; color: white; padding: 5px; font-size: 0.8rem; font-weight: bold; margin-bottom: 15px; border-radius: 4px; display: none; text-shadow: 0 0 5px #000; letter-spacing: 2px;}

  /* Modals */
  .modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 10000; flex-direction: column; justify-content: center; align-items: center;
    backdrop-filter: blur(5px);
  }
  .seal-broken { font-size: 2.5rem; color: #fff; text-shadow: 0 0 30px #fff; font-weight: bold; }
  .answer-reveal { font-size: 4rem; letter-spacing: 15px; margin: 20px; color: #fff; font-family: 'Cinzel', serif; }

  /* Help & History Styles */
  #help-content, #history-content {
    background: #111; border: 1px solid #444; padding: 20px; border-radius: 10px; width: 85%; max-width: 500px;
    max-height: 80vh; overflow-y: auto; text-align: left; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.8);
  }
  .help-section { margin-bottom: 25px; border-bottom: 1px dashed #333; padding-bottom: 15px; }
  .help-title { color: #d4af37; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;}
  .help-text { font-size: 0.9rem; line-height: 1.6; color: #ccc; }
  /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚è¿½å¾“ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ï¼‰ */
.close-help { 
  position: sticky !important; /* absolute ã‹ã‚‰ sticky ã«å¤‰æ›´ */
  top: 0; 
  float: right; /* å³ã«å¯„ã›ã‚‹ */
  font-size: 2rem; /* å°‘ã—å¤§ããã—ã¦æŠ¼ã—ã‚„ã™ã */
  cursor: pointer; 
  color: #888; 
  padding: 5px 10px;
  background: #111; /* èƒŒæ™¯ã‚’ã¤ã‘ã¦æ–‡å­—ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã« */
  border-radius: 0 0 0 8px;
  z-index: 10;
  margin-top: -10px; /* ä½ç½®å¾®èª¿æ•´ */
  margin-right: -10px;
}

  
  .diagram-box {
    background: #222; border: 1px solid #444; padding: 15px; border-radius: 6px; margin: 10px 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .d-stone {
    width: 90%; background: #333; border-left: 3px solid #666; padding: 8px; margin: 5px 0; color: #fff; font-size: 0.8rem; display: flex; justify-content: space-between;
  }
  .d-arrow { font-size: 1.5rem; color: #d4af37; margin: 5px 0; }
  .d-result { font-weight: bold; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
  .d-true { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
  .d-false { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
  
  /* Liar Styles */
  .stone.is-liar {
    border: 2px solid #e74c3c;
    background: linear-gradient(to right, rgba(231, 76, 60, 0.2), rgba(0,0,0,0.8));
  }
  .stone.is-liar::after { background: #e74c3c; }
  .stone.is-liar .stone-title::after {
    content: " (å˜˜ã¤ã)"; color: #e74c3c; font-weight: bold; margin-left: 5px;
  }
  .res-row { font-size: 0.8rem; border-bottom: 1px solid #444; padding: 5px 0; color: #ccc; }
  .res-liar-txt { color: #e74c3c; font-weight:bold; }

    /* Omega Rule List */
  #omega-rule-area {
    margin-top: 15px; padding: 10px; border: 1px solid #444; border-radius: 8px;
    background: rgba(0,0,0,0.8); display: none; text-align: left;
    
       /* â–¼â–¼â–¼ ä¿®æ­£ç‚¹: æ ã®å¤–ã‚‚è¡¨ç¤ºã•ã›ã‚‹æœ€å¼·ã®å‘ªæ–‡ â–¼â–¼â–¼ */
    position: relative;
    z-index: 15000;
    overflow: visible !important; /* â† ã“ã‚ŒãŒãªã„ã¨iPhoneã§æ¶ˆãˆã¾ã™ï¼ */
  }
  .omega-label { color: #fff; font-size: 0.9rem; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; }
  .omega-list-item {
    padding: 6px; font-size: 0.85rem; color: #ccc; cursor: pointer; border-bottom: 1px dashed #333; transition: 0.2s;
  }
  .omega-list-item:hover { color: #fff; background: rgba(255,255,255,0.1); }
  .omega-list-item.excluded {
    text-decoration: line-through; color: #555; opacity: 0.6;
  }

  /* History List Styles */
  .hist-item {
    background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 10px;
    margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
  }
  .hist-left { text-align: left; }
  .hist-mode { font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; margin-right: 5px; font-weight: bold; }
  .mode-standard { background: #1c4e8a; color: #aed6f1; }
  .mode-hard { background: #8a1c1c; color: #f5b7b1; }
  .mode-nightmare { background: #4a1c8a; color: #d7bde2; }
  .mode-chaos { background: #555; color: #ccc; }
  .mode-omega { background: #000; color: #fff; border: 1px solid #fff; }

  .hist-id { font-family: 'Cinzel', serif; color: #d4af37; font-weight: bold; letter-spacing: 1px; }
  .hist-date { font-size: 0.7rem; color: #666; margin-top: 2px; }
  .hist-result { font-weight: bold; font-size: 0.9rem; }
  .res-win { color: #2ecc71; }
  .res-lose { color: #e74c3c; }

  .btn-replay {
    background: transparent; border: 1px solid #555; color: #aaa; cursor: pointer;
    padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; transition: 0.2s;
  }
  .btn-replay:hover { background: #333; color: #fff; border-color: #fff; }
  
  /* Tutorial Styles */
  .t-container { display: flex; flex-direction: column; gap: 15px; }
  .t-step { background: #1a1a1a; border: 1px solid #444; border-radius: 8px; padding: 15px; position: relative; text-align: left; }
  .t-step-num { background: var(--accent-color); color: #000; font-weight: bold; display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 8px; }
  .t-row { display: flex; align-items: center; justify-content: space-around; margin: 10px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; }
  .t-stone-mock { border: 1px solid #666; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; color: #ccc; background: #222; }
  .t-result-mock { font-weight: bold; font-family: 'Cinzel', serif; padding: 5px 10px; border-radius: 4px; }
  .t-res-true { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
  .t-res-false { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
  .t-logic-text { font-size: 0.9rem; line-height: 1.6; color: #ddd; margin-top: 5px; }
  .t-highlight { color: #ff9999; font-weight: bold; }
  .t-highlight-b { color: #99ccff; font-weight: bold; }
  .t-conclusion { border-top: 1px dashed #444; margin-top: 10px; padding-top: 10px; font-weight: bold; color: var(--accent-color); }

  #loading-indicator { font-size: 1.2rem; color: #d4af37; margin-top: 20px; display: none; }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  
    /* --- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (æ”¹ä¿®ç‰ˆ) --- */
.title-top-right {
  position: fixed;
  top: max(20px, env(safe-area-inset-top)); 
  right: 20px; 
  left: auto;   /* â†ã‚³ãƒ¬é‡è¦ï¼å·¦å´ã¯å›ºå®šã—ãªã„ */
  width: auto;  /* â†ã‚³ãƒ¬é‡è¦ï¼å‹æ‰‹ã«ä¼¸ã³ãªã„ã‚ˆã†ã«ã™ã‚‹ */
  
  display: flex; 
  gap: 10px; 
  z-index: 20000; 
  pointer-events: auto; 
}

  .btn-tutorial {
    background: rgba(46, 204, 113, 0.2); border: 1px solid #2ecc71; color: #2ecc71;
    padding: 10px 15px; border-radius: 30px; font-weight: bold; cursor: pointer;
    font-size: 0.9rem; display: flex; align-items: center; gap: 5px;
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.2); transition: 0.2s;
  }
  .btn-tutorial:hover { background: rgba(46, 204, 113, 0.4); transform: scale(1.05); }

  /* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸BOX */
  #tut-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    /* èƒŒæ™¯ã®æš—ã•ã‚’å°‘ã—å’Œã‚‰ã’ã¾ã—ãŸ (0.7 -> 0.4) */
    background: rgba(0,0,0,0.4); z-index: 2000; display: none;
    pointer-events: auto;
  }
  
  /* ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆç©´ã‚’é–‹ã‘ã‚‹ï¼‰ */
  .tut-highlight {
    position: relative; z-index: 2001; 
    /* å‘¨ã‚Šã®æš—ã•ã‚‚å°‘ã—å’Œã‚‰ã’ã¾ã—ãŸ */
    box-shadow: 0 0 0 9999px rgba(0,0,0,0.6); 
    pointer-events: auto; 
    border-radius: 4px;
    transition: all 0.3s ease;
  }

  /* èµ¤ãç‚¹æ»…ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ³¨ç›®ï¼ï¼‰ */
  @keyframes blink-red {
    0% { border-color: #ff0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); transform: scale(1); }
    50% { border-color: #ffcccc; box-shadow: 0 0 25px rgba(255, 50, 50, 0.9); transform: scale(1.02); }
    100% { border-color: #ff0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); transform: scale(1); }
  }
  .tut-blink {
    animation: blink-red 1.2s infinite ease-in-out !important;
    border: 2px solid #ff0000 !important;
    background: rgba(0, 0, 0, 0.8) !important; /* æ–‡å­—ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«èƒŒæ™¯ã‚’æ¿ƒã */
  }
  /* --- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«BOX (å¼·åˆ¶ä½ç½®ä¿®æ­£ç‰ˆ) --- */

  .tut-msg-box {
    position: fixed !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 92% !important; /* æ¨ªå¹… */
    max-width: 500px !important;
    background: rgba(15, 15, 20, 0.95) !important;
    border: 1px solid #d4af37 !important;
    border-radius: 8px !important;
    padding: 12px 15px !important; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
    z-index: 9999 !important; /* æœ€å‰é¢ã« */
    text-align: left !important;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.9) !important;
    transition: all 0.3s ease !important;
    
    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œç”»é¢ã®ä¸€ç•ªä¸‹ã€ã«é…ç½® */
    bottom: 20px !important;
    top: auto !important;
  }

  /* ä¸Šã«è¡¨ç¤ºã™ã‚‹å ´åˆã®ã‚¯ãƒ©ã‚¹ */
  .tut-pos-top {
    top: 80px !important; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸‹ */
    bottom: auto !important;
  }

  /* ä¸‹ã«è¡¨ç¤ºã™ã‚‹å ´åˆã®ã‚¯ãƒ©ã‚¹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨åŒã˜ã ãŒå¿µã®ãŸã‚) */
  .tut-pos-bottom {
    bottom: 20px !important;
    top: auto !important;
  }

  /* ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
  .tut-text {
    color: #fff;
    line-height: 1.4;
    font-size: 0.9rem; /* æ–‡å­—ã‚’å°‘ã—å°ã•ã */
    margin-bottom: 8px;
  }

  /* ãƒœã‚¿ãƒ³èª¿æ•´ */
  .tut-next-btn {
    background: #d4af37;
    color: #000;
    border: none;
    padding: 5px 15px;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    float: right;
    font-size: 0.8rem;
  }

    
  .tut-msg-box {
    position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
    width: 90%; max-width: 500px; background: #111; border: 2px solid #d4af37;
    border-radius: 10px; padding: 20px; z-index: 2002; text-align: left;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
  }
  .tut-text { color: #fff; line-height: 1.6; font-size: 1rem; margin-bottom: 15px; }
  .tut-next-btn {
    background: #d4af37; color: #000; border: none; padding: 8px 20px;
    font-weight: bold; border-radius: 4px; cursor: pointer; float: right;
  }
  .tut-arrow {
    position: absolute; color: #d4af37; font-size: 2rem; font-weight: bold;
    animation: bounce 1s infinite; z-index: 2003; text-shadow: 0 0 5px #000;
  }
  @keyframes bounce { 0%, 100% { transform:translateY(0); } 50% { transform:translateY(-10px); } }

/* --- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ï¼ˆä¿®æ­£ç‰ˆï¼‰ --- */

/* åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ */
.tut-embedded-mode {
  position: relative !important; /* å›ºå®šé…ç½®ã‚’è§£é™¤ */
  left: auto !important;
  transform: none !important;
  bottom: auto !important;
  top: auto !important;
  
  width: 100% !important;
  max-width: 100% !important;
  margin: 0 0 20px 0 !important;
  
  /* â–¼â–¼â–¼ è¿½åŠ ä¿®æ­£: ã“ã‚ŒãŒãªã„ã¨paddingåˆ†ã ã‘è†¨ã‚‰ã‚“ã§å³ã«ã¯ã¿å‡ºã—ã¾ã™ï¼ â–¼â–¼â–¼ */
  box-sizing: border-box !important; 
  /* â–²â–²â–²â–²â–²â–² */
  
  background: rgba(20, 20, 25, 0.95) !important;
  border: 1px solid #d4af37 !important;
  border-radius: 8px !important;
  padding: 15px !important;
  box-shadow: 0 0 10px rgba(212, 175, 55, 0.3) !important;
  
  display: flex !important;
  flex-direction: column;
  justify-content: center;
  min-height: 120px; 
}

/* çŸ¢å°ã¯åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã§ã¯æ¶ˆã™ */
.tut-embedded-mode .tut-arrow {
  display: none !important;
}

/* çµæœè¡¨ç¤ºã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
.tut-result-display {
  font-family: 'Cinzel', serif;
  font-size: 1.4rem;
  font-weight: bold;
  text-align: center;
  margin: 10px 0;
  padding: 8px;
  background: rgba(0,0,0,0.5);
  border-radius: 4px;
}

/* --- Î©ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ¡ãƒ¢æ¬„ (æ”¹ä¿®ç‰ˆ) --- */
.omega-memo-box {
  margin-top: 5px;
  padding: 0 5px;
  /* Flexboxã«ã—ã¦å…¥åŠ›æ¬„ã¨ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã« */
  display: flex; 
  gap: 5px;
  align-items: center;
}

.omega-memo-input {
  /* width: 100% ã‚’å‰Šé™¤ã—ã€flex: 1 ã§æ®‹ã‚Šã®å¹…ã‚’åŸ‹ã‚ã‚‹ */
  flex: 1; 
  box-sizing: border-box;
  background: #000;
  border: 1px solid #444;
  color: #d4af37;
  font-size: 0.8rem;
  padding: 5px;
  border-radius: 4px;
  font-family: 'Shippori Mincho', serif;
  transition: 0.3s;
}
.omega-memo-input:focus {
  outline: none;
  border-color: #d4af37;
  box-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
  background: #111;
}

/* ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ */
.btn-omega-copy {
  width: 30px;
  height: 30px;
  background: #222;
  border: 1px solid #555;
  border-radius: 4px;
  color: #aaa;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 1rem;
  transition: 0.2s;
}
.btn-omega-copy:active {
  transform: scale(0.9);
  background: #444;
}
/* ã‚³ãƒ”ãƒ¼æˆåŠŸæ™‚ã®æ¼”å‡ºç”¨ã‚¯ãƒ©ã‚¹ */
.copy-success {
  border-color: #2ecc71 !important;
  color: #2ecc71 !important;
  background: rgba(46, 204, 113, 0.1) !important;
}

/* --- ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
input.rune-input:disabled {
  background: #222;       /* èƒŒæ™¯ã‚’æš—ã */
  color: #555;            /* æ–‡å­—ã‚’æš—ã */
  border-color: #444;     /* æ ç·šã‚‚ç›®ç«‹ãŸãªã */
  opacity: 0.7;
  cursor: not-allowed;
}

/* ãƒ­ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes fadeIn { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }

/* --- iPhone (iOS Safari) è¡¨ç¤ºå´©ã‚Œå¯¾ç­– --- */

/* 1. å…¥åŠ›æ¬„ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆï¼†ã‚µã‚¤ã‚ºå›ºå®š */
.rune-input {
  /* iPhoneç‰¹æœ‰ã®ä¸¸ã¿ã‚„å½±ã‚’æ¶ˆã™ */
  -webkit-appearance: none !important; 
  appearance: none !important;
  
  /* æ¨ªå¹…ã‚’å¼·åˆ¶çš„ã«åºƒã’ã‚‹ */
  width: 80px !important; 
  min-width: 80px !important; /* å¿µã®ãŸã‚æœ€å°å¹…ã‚‚æŒ‡å®š */
  
  /* ä½™è¨ˆãªéš™é–“ã‚’æ¶ˆã™ */
  margin: 0;
  border-radius: 8px; /* ãƒ‡ã‚¶ã‚¤ãƒ³ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦OK */
  box-sizing: border-box; /* æ ç·šã‚’å«ã‚ãŸã‚µã‚¤ã‚ºè¨ˆç®—ã«ã™ã‚‹ */
}

/* 2. å…¥åŠ›æ¬„ã‚’åŒ…ã‚“ã§ã„ã‚‹ç®±ãŒæ½°ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
.rune-wrapper {
  flex-shrink: 0 !important; /* ã€Œç¸®ã‚€ãªï¼ã€ã¨ã„ã†å‘½ä»¤ */
  width: auto !important;
}

/* --- ã‚²ãƒ¼ãƒˆè§£æ”¾æ¼”å‡º (å¼·åŒ–ç‰ˆ) --- */

/* ãƒ¢ãƒ€ãƒ«å…¨ä½“ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ç”¨ã‚¯ãƒ©ã‚¹ */
.gate-anim-running {
  /* å­è¦ç´ ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç™ºç«ç”¨ */
}

/* === åå­—ç·šæ¼”å‡º (ä¸­å¿ƒæ‹¡æ•£ãƒ»æ¥µç´°ç‰ˆ) === */
.lightning-svg {
  position: absolute;
  top: 0; left: 0;
  pointer-events: none;
  opacity: 0;
  transform-origin: center center; /* ä¸­å¿ƒã‚’è»¸ã«ã™ã‚‹ */
}

.lightning-path {
  fill: none;
  stroke: #fffbe0; 
  stroke-width: 0.4px; /* ã•ã‚‰ã«ç´°ãã—ã¦é‹­ã•ã‚’å‡ºã™ */
  stroke-linecap: round;
  filter: drop-shadow(0 0 1px #fff) drop-shadow(0 0 3px #d4af37) drop-shadow(0 0 6px #aa771c);
  vector-effect: non-scaling-stroke;
}

.lightning-path.main { stroke-width: 0.6px; }
.lightning-path.sub { stroke-width: 0.2px; opacity: 0.5; }

.lightning-svg.omega-mode .lightning-path {
  stroke: #ffffff !important;
  filter: drop-shadow(0 0 2px #fff) drop-shadow(0 0 8px #fff) !important;
}

.gate-anim-running .lightning-svg {
  animation: explode-discharge 2.5s cubic-bezier(0.1, 0.8, 0.3, 1) forwards;
}

/* ä¸­å¿ƒã‹ã‚‰çˆ†ç™ºçš„ã«åºƒãŒã‚Šã€éœ‡ãˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes explode-discharge {
  0% { 
    opacity: 0; 
    transform: scale(0.2); /* ä¸­å¿ƒã«å‡ç¸® */
  }
  5% { 
    opacity: 1; 
    transform: scale(1.2); /* ä¸€æ°—ã«åºƒãŒã‚‹ */
  }
  
  /* ãƒãƒãƒãƒã¨éœ‡ãˆã‚‹ãƒã‚¤ã‚º */
  10%, 30%, 50%, 70%, 90% { transform: scale(1.05) translate(2px, -1px); opacity: 1; }
  20%, 40%, 60%, 80% { transform: scale(1) translate(-2px, 1px); opacity: 0.2; }

  95% { opacity: 1; transform: scale(1.2) filter(brightness(2)); }
  100% { opacity: 0; transform: scale(2); filter: brightness(10); }
}

/* çŸ³æ¿æœ¬ä½“ (è³ªæ„Ÿã‚’å¼·åŒ–) */
.gate-stone {
  width: 180px; height: 180px; /* å°‘ã—å¤§ãã */
  /* ç‚¹ç·šã‚’ã‚„ã‚ã¦ã€ã‚´ãƒ„ã‚´ãƒ„ã—ãŸå®Ÿç·šã¨å¤šé‡å½±ã«å¤‰æ›´ */
  border: 8px solid #2a2a2a;
  border-radius: 50%;
  display: flex; justify-content: center; align-items: center;
  font-family: 'Cinzel', serif; font-size: 6rem; color: #111;
  position: relative;
  /* å²©ã£ã½ã„ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨å†…å´ã‹ã‚‰ã®å…‰ */
  background: radial-gradient(circle, #333 0%, #000 100%);
  box-shadow: 
    inset 0 0 30px #000, /* å†…å´ã®æ·±ã„å½± */
    0 0 20px rgba(212, 175, 55, 0.3); /* å¤–å´ã®å¾®ã‹ãªå…‰ */
  text-shadow: 0 0 5px rgba(212, 175, 55, 0.5); /* æ–‡å­—ã®å…‰ */
}

/* å†…å´ã®è£…é£¾ãƒªãƒ³ã‚° */
.gate-inner {
  width: 140px; height: 140px;
  border: 4px solid rgba(212, 175, 55, 0.6); /* é‡‘è‰²ã®ãƒªãƒ³ã‚° */
  border-radius: 50%;
  display: flex; justify-content: center; align-items: center;
}

/* çŸ³æ¿ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (ã‚¯ãƒ©ã‚¹ä»˜ä¸ã§é–‹å§‹) */
.gate-active {
  animation: gateOpenHeavy 2.5s cubic-bezier(0.7, 0, 0.3, 1) forwards;
}

@keyframes gateOpenHeavy {
  0% { 
    transform: rotate(0deg) scale(1);
    border-color: #2a2a2a; color: #111;
  }
  20% {
    /* èµ·å‹•: ã‚¬ã‚¬ã‚¬ãƒƒã¨å°‘ã—å›ã£ã¦æ­¢ã¾ã‚‹ */
    transform: rotate(45deg) scale(1.1);
    color: #d4af37; border-color: #d4af37;
    box-shadow: inset 0 0 50px #d4af37, 0 0 50px #d4af37;
  }
  40% {
    /*æºœã‚: ä¸€ç¬é€†å›è»¢ã—ã¦ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æºœã‚ã‚‹ */
    transform: rotate(30deg) scale(1.05);
    filter: brightness(1.5);
  }
  100% {
    /* è§£æ”¾: ä¸€æ°—ã«åŠ é€Ÿã—ã¦ãƒ›ãƒ¯ã‚¤ãƒˆã‚¢ã‚¦ãƒˆ */
    transform: rotate(1080deg) scale(15);
    opacity: 0; filter: brightness(20);
    color: #fff; border-color: #fff;
  }
}

/* --- äºˆè¨€ãƒªã‚¹ãƒˆç”»é¢ç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
#prophecy-list-content {
  background: #111; border: 1px solid #444; padding: 20px; border-radius: 10px; width: 85%; max-width: 500px;
  max-height: 80vh; overflow-y: auto; text-align: left; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.8);
}
.p-cat-title {
  margin-top: 20px; margin-bottom: 10px; font-weight: bold; border-left: 4px solid #555; padding-left: 8px; font-size: 0.95rem;
}
.p-item {
  margin-bottom: 12px; font-size: 0.9rem; line-height: 1.5; border-bottom: 1px dashed #333; padding-bottom: 8px; color: #ddd;
}
.p-ex {
  color: #888; font-size: 0.8rem; display: block; margin-top: 2px;
}

/* --- Î©ãƒ¢ãƒ¼ãƒ‰ç‰¹æ®Šæ¼”å‡º (ä¿®æ­£ç‰ˆ: å¤©ç©ºã‹ã‚‰ã®é™è‡¨) --- */

/* 1. é–‹å§‹æ™‚: äºˆè¨€ãŒç”»é¢æœ€ä¸Šéƒ¨ã‹ã‚‰é™ã£ã¦ãã‚‹ */
@keyframes dropStone {
  0% { 
    transform: translateY(-120vh); /* ç”»é¢ã®é¥ã‹ä¸Šã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ */
    opacity: 0;
  }
  10% {
    opacity: 1; /* é™ã‚Šå§‹ã‚ã§ã™ãè¦‹ãˆã‚‹ã‚ˆã†ã« */
  }
  100% { 
    transform: translateY(0); /* è‡ªåˆ†ã®å ´æ‰€ã«ç€åœ° */
    opacity: 1; 
  }
}

.stone-fall {
  /* 3ç§’ã‹ã‘ã¦ã‚†ã£ãã‚Šã€ãµã‚“ã‚ã‚Šã¨ç€åœ°ã™ã‚‹ */
  animation: dropStone 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
  opacity: 0; /* æœ€åˆã¯éš ã—ã¦ãŠã */
  
  /* é™ã£ã¦ãã‚‹é–“ã€ä»–ã®ãƒ‘ãƒ¼ãƒ„ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤ºã™ã‚‹ */
  position: relative;
  z-index: 100; 
}

/* 2. è§£é™¤æ™‚: ç™½è‰²ã®çŸ³æ¿ã‚¹ã‚¿ã‚¤ãƒ« (å¤‰æ›´ãªã—) */
.gate-stone-omega {
  border-color: #fff !important;
  color: #fff !important;
  background: radial-gradient(circle, #555 0%, #000 100%) !important;
  box-shadow: inset 0 0 50px #fff, 0 0 30px #fff !important;
  text-shadow: 0 0 20px #fff !important;
}
.gate-inner-omega {
  border-color: #fff !important;
}

/* é€šå¸¸ã®1.5å€ã®æ™‚é–“ (2.5s * 1.5 = 3.75s) */
.gate-active-omega {
  animation: gateOpenHeavy 3.75s cubic-bezier(0.7, 0, 0.3, 1) forwards !important;
}

/* 3. ã‚¯ãƒªã‚¢æ™‚: ç¥ã€…ã—ã„ãƒ•ãƒ¬ãƒ¼ãƒ  (å¤‰æ›´ãªã—) */
.divine-frame {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 20000;
  box-shadow: inset 0 0 50px #fff, inset 0 0 100px rgba(212, 175, 55, 0.5);
  border: 4px solid #fff;
  animation: divinePulse 3s infinite alternate;
}
@keyframes divinePulse {
  0% { box-shadow: inset 0 0 30px #fff, inset 0 0 80px rgba(212, 175, 55, 0.3); opacity: 0.8; }
  100% { box-shadow: inset 0 0 60px #fff, inset 0 0 150px rgba(212, 175, 55, 0.8); opacity: 1; }
}

/* æ–¬æ’ƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆæœ¬ä½“ */
.slash-effect {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 30000; display: none;
}
.slash-line {
  position: absolute; background: #fff;
  box-shadow: 0 0 20px #fff, 0 0 40px #ff0000;
  transform: rotate(-20deg);
}

/* æ•°å­—ãŒå£Šã•ã‚Œã‚‹æ™‚ã®éœ‡ãˆ */
@keyframes glitch-shake {
  0% { transform: translate(0); }
  20% { transform: translate(-5px, 5px); color: #ff0000; }
  40% { transform: translate(-5px, -5px); }
  60% { transform: translate(5px, 5px); }
  80% { transform: translate(5px, -5px); }
  100% { transform: translate(0); }
}
.glitch-active { animation: glitch-shake 0.3s linear infinite; }

/* --- ã‚«ã‚ªã‚¹ãƒ¢ãƒ¼ãƒ‰æ¼”å‡ºç”¨ --- */

/* 1. é™ã‚Šæ³¨ãç¦ã€…ã—ã„ã‚ªãƒ¼ãƒ– */
.chaos-orb {
  position: fixed;
  width: 20px; height: 20px;
  background: radial-gradient(circle, #fff 0%, #9b59b6 30%, #000 100%);
  border-radius: 50%;
  box-shadow: 0 0 10px #9b59b6, 0 0 20px #8e44ad;
  z-index: 9999;
  pointer-events: none;
  opacity: 0;
}
/* è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes chaos-fall {
  0% { transform: translateY(-100px) scale(2); opacity: 0; }
  20% { opacity: 1; }
  100% { transform: translateY(0) scale(1); opacity: 1; }
}

/* 2. çŸ³ç¢‘ãŒå‘ªã‚ã‚ŒãŸæ™‚ã®æŒ¯å‹•ã¨å¤‰è‰² */
@keyframes chaos-impact {
  0% { transform: scale(1); border-color: #777; }
  10% { transform: scale(1.1); border-color: #9b59b6; background: #2c0e3a; }
  20% { transform: translate(-3px, 3px); }
  40% { transform: translate(3px, -3px); }
  60% { transform: translate(-3px, -3px); }
  80% { transform: translate(3px, 3px); }
  100% { transform: scale(1); border-color: #9b59b6; background: rgba(0,0,0,0.6); }
}
.stone.chaos-infected {
  animation: chaos-impact 0.5s cubic-bezier(.36,.07,.19,.97) forwards;
  /* æ†‘ä¾å¾Œã¯æ ç·šã‚’ç´«è‰²ã«å›ºå®š */
  border-color: #9b59b6 !important;
  box-shadow: 0 0 15px rgba(155, 89, 182, 0.3);
}

/* è­¦å‘Šæ–‡ã®ã˜ã‚ã£ã¨è¡¨ç¤º */
.chaos-bar {
  opacity: 0;
  transition: opacity 2s ease-in; 
  
  /* ä»¥ä¸‹ã¯å¤‰æ›´ãªã— */
  background: #c0392b; color: white; padding: 5px; font-size: 0.8rem; 
  font-weight: bold; margin-bottom: 15px; border-radius: 4px; 
  display: none; text-shadow: 0 0 5px #000; letter-spacing: 2px;
}
.chaos-bar.visible {
  opacity: 1;
}

/* ã‚¿ãƒƒãƒ—æ™‚ã®é…å»¶ã‚’ç„¡åŠ¹åŒ–ã—ã¦å³æ™‚åå¿œã•ã›ã‚‹ */
button, .btn, .hud-btn, .stone, .memo-btn {
  touch-action: manipulation;
}

       /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©ï¼ˆãƒ†ã‚¹ãƒˆç”¨ã«é«˜ã•ã‚’åŠåˆ†ã«ï¼‰ */
  @keyframes dropInBounce {
    0% {
      opacity: 1; /* â˜…ãƒ†ã‚¹ãƒˆç”¨: æœ€åˆã‹ã‚‰ä¸é€æ˜ã« */
      transform: translateY(-150vh) scale(0.9); /* â˜…ãƒ†ã‚¹ãƒˆç”¨: åŠåˆ†ã®é«˜ã•ã‹ã‚‰ */
    }
    70% { opacity: 1; transform: translateY(20px) scale(1.05); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }

  /* ãƒªã‚¹ãƒˆé …ç›®ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .omega-list-item {
    opacity: 0; 
    position: relative;
    z-index: 15000; /* 9ä¸‡ã®ã¾ã¾ç¶­æŒ */
  }
  
   /* ãã®ä¸‹ã® .omega-list-item.falling ã‚’æ¢ã—ã¦ãã ã•ã„ */

/* é™ã£ã¦ãã‚‹æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.omega-list-item.falling {
  /* â–¼â–¼â–¼ ã“ã“ã‚’æ›¸ãæ›ãˆï¼èµ¤ã‚’æ¶ˆã—ã¦é»„é‡‘ã«ã™ã‚‹ â–¼â–¼â–¼ */
  
  /* è–„ã„é»„é‡‘è‰²ã®èƒŒæ™¯ï¼ˆé€æ˜åº¦25%ï¼‰ */
  background: rgba(212, 175, 55, 0.25);
  /* ã¯ã£ãã‚Šã—ãŸé‡‘ã®æ ç·š */
  border: 1px solid #ffd700;
  /* ã¼ã‚“ã‚„ã‚Šé»„é‡‘è‰²ã«å…‰ã‚‰ã›ã‚‹ */
  box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
  
  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆãã®ã¾ã¾ï¼‰ */
  animation: dropInBounce 3.0s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}




</style>
</head>
<body>
  <div id="top-tut-btn" class="title-top-right">
  <div class="btn-tutorial" onclick="startTutorial()">Tutorial</div>
</div>
  <div id="title-screen">
      <div class="game-title">OMEGA STONE</div>
    <div style="color:#aaa; margin-bottom:40px; letter-spacing:2px; font-size:0.9rem;">Logical Deduction</div>
    
<div class="btn btn-std" onclick="startGame('easy')"><span>Easy</span><span class="en-font">I</span></div>
<div class="btn btn-hard" style="border-color:#27ae60; color:#abebc6;" onclick="startGame('standard')"><span>Standard</span><span class="en-font">II</span></div>
<div class="btn btn-hard" onclick="startGame('hard')"><span>Hard</span><span class="en-font">III</span></div>
<div class="btn btn-night" onclick="startGame('nightmare')"><span>Nightmare</span><span class="en-font">IV</span></div>
<div class="btn btn-chaos" onclick="startGame('chaos')"><span>Chaos</span><span class="en-font">âˆ</span></div>
<div class="btn btn-omega" onclick="startGame('omega')"><span>Omega</span><span class="en-font">?</span></div>


    <div style="display:flex; gap:10px; width:90%; max-width:350px; margin-top:10px;">
      <div class="btn btn-std" style="font-size:0.9rem; padding:12px;" onclick="showHistory()">ğŸ“œ å±¥æ­´</div>
      <div class="btn btn-std" style="font-size:0.9rem; padding:12px; border-color:#aaa; color:#eee;" onclick="showInputId()">ğŸ”‘ IDå…¥åŠ›</div>
    </div>
    
    <div id="loading-indicator">ç”Ÿæˆä¸­...</div>
  </div>

  <div id="game-screen">
    <div class="hud">
      <div class="hud-left">
        <div class="hud-btn" onclick="openMenuModal()">MENU</div>
         <div class="hud-btn" onclick="showProphecyList()" style="margin-left:5px;">äºˆè¨€æ›¸</div>
        <div id="btn-show-result" class="hud-btn" style="display:none; border-color:#2ecc71; color:#2ecc71; font-weight:bold;" onclick="showResult()">RESULT</div>
      </div>
      <div class="mana-bar"><span style="font-size:0.8rem; color:#888;">MANA</span> <span id="ui-mana" class="en-font">0/3</span></div>
    </div>

    <div style="text-align:right; font-size:0.8rem; color:#aaa; margin-top:-15px; margin-bottom:15px; margin-right:5px;">ROUND <span id="ui-round" class="en-font" style="color:#fff; font-size:1.1rem;">1</span></div>

        <div id="chaos-warning" class="chaos-bar">âš  å¸¸ã«å˜˜ã‚’ã¤ãå½ã‚Šã®äºˆè¨€ãŒ1ã¤å«ã¾ã‚Œã¦ã„ã¾ã™</div>

    <div id="nightmare-warning" class="chaos-bar" style="background: #4a1c8a; border: 1px solid #9b59b6; box-shadow: 0 0 10px #4a1c8a;">
      âš  MANAã¯2ã«æ¸›ã‚Šã€5ãƒ©ã‚¦ãƒ³ãƒ‰ä»¥å†…ã«å°å°ã‚’è§£é™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™(å›ç­”å«ã‚€)
    </div>


        <div class="rune-container" style="flex-direction:column; gap:5px;">
      <div style="display:flex; justify-content:center; gap:12px;">
        <div class="rune-wrapper">
          <div class="rune-label" style="color:#ff9999">ç‚<span class="rune-sub">IGNIS</span></div>
          <input type="number" id="r1" class="rune-input" min="1" max="5" placeholder="-" onchange="limitInput(this)">
        </div>
        <div class="rune-wrapper">
          <div class="rune-label" style="color:#99ccff">æ°´<span class="rune-sub">AQUA</span></div>
          <input type="number" id="r2" class="rune-input" min="1" max="5" placeholder="-" onchange="limitInput(this)">
        </div>
        <div class="rune-wrapper">
          <div class="rune-label" style="color:#99ffcc">é¢¨<span class="rune-sub">VENTUS</span></div>
          <input type="number" id="r3" class="rune-input" min="1" max="5" placeholder="-" onchange="limitInput(this)">
        </div>
      </div>
      <div id="rune-lock-msg" style="display:none; color:#e74c3c; font-size:0.75rem; font-weight:bold; margin-top:5px; animation:fadeIn 0.5s;">
        ğŸ”’ï¸æ•°å­—ã¯æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¾ã§å¤‰æ›´ã§ãã¾ã›ã‚“
      </div>
    </div>


    <div style="text-align:left; color:#666; font-size:0.7rem; margin-bottom:5px; margin-left:5px;">LOGIC MATRIX & MEMO</div>
    <div class="logic-grid" id="logic-matrix"></div>
    
        <button class="memo-toggle-btn" onclick="toggleMemoArea()">ğŸ“ MEMO PAD (Show/Hide)</button>
    
    <div class="memo-area closed" id="memo-pad">
      <textarea class="memo-textarea" placeholder="æ¨ç†ãƒ¡ãƒ¢&#13;&#10;ä¾‹: ç‚ã¯å¶æ•°ã§ã¯ãªã„...&#13;&#10;åˆè¨ˆã¯10ä»¥ä¸Š..."></textarea>
    </div>

    <div id="prophecy-container" class="prophecy-list"></div>

    <div id="omega-rule-area">
      <div class="omega-label">DETECTED LAWS (Search & Destroy)</div>
      <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">â€»ã‚¯ãƒªãƒƒã‚¯ã§å–ã‚Šæ¶ˆã—ç·š (ãƒ¡ãƒ¢)</div>
      <div id="omega-list"></div>
    </div>

    <div class="action-bar">
      <button class="btn-action btn-next" onclick="nextRound()">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸</button>
      <button class="btn-action btn-solve" onclick="attemptUnlock()">å°å°è§£é™¤</button>
    </div>

    <div id="log-container" class="log-area">
      <div style="color:#666; text-align:center; font-style:italic; font-size:0.8rem;">-- è§£æã®è¨˜éŒ² --</div>
    </div>
  </div>

    <div id="result-modal" class="modal-overlay">
  <div class="seal-broken">å°å°è§£é™¤</div>

  <div id="result-mode-badge" class="en-font" style="font-size:1.5rem; letter-spacing:3px; margin-bottom:15px; font-weight:bold; text-transform:uppercase;"></div>
  <div style="color:#ccc; margin-top:10px;">çœŸå®Ÿã®ãƒ«ãƒ¼ãƒ³:</div>

    <div class="answer-reveal" id="final-code"></div>
    <div id="result-details" style="width:90%; max-width:400px; background:#222; padding:10px; border-radius:8px; margin-bottom:20px; text-align:left; max-height:30vh; overflow-y:auto; border:1px solid #444;"></div>
    
    <div style="color:#fff; margin-bottom:20px; font-size:0.9rem;">
      åˆ°é”ãƒ©ã‚¦ãƒ³ãƒ‰: <span id="final-round" class="en-font" style="font-size:1.2rem; color:#d4af37; margin-right:15px;"></span>
      ç·æ¤œè¨¼æ•°: <span id="final-checks" class="en-font" style="font-size:1.2rem; color:#d4af37;"></span>å›
    </div>

    <div style="display:flex; gap:10px; width:90%; max-width:350px;">
      <button class="btn btn-std" style="justify-content:center; flex:1;" onclick="reviewBoard()">ç›¤é¢ã‚’è¦‹ã‚‹</button>
      <button class="btn btn-std" style="justify-content:center; flex:1; background:#d4af37; color:#000; border-color:#fff;" onclick="softResetGame()">æ¬¡ã®éºè·¡ã¸</button>
    </div>
  </div>


    <div id="id-modal" class="modal-overlay">
    <div style="background:#111; padding:20px; border:1px solid #444; border-radius:10px; width:80%; max-width:300px;">
      <h3 style="color:#fff; margin-top:0;">çŸ³ç¢‘IDã‚’å…¥åŠ›</h3>
      <input type="text" id="input-seed" placeholder="ä¾‹: A1B2C" style="width:100%; padding:10px; font-size:1.2rem; text-align:center; margin-bottom:15px; background:#222; border:1px solid #555; color:#fff; font-family:'Cinzel', serif; text-transform:uppercase;">
      <div style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">é›£æ˜“åº¦ã‚’é¸æŠã—ã¦é–‹å§‹:</div>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
        <button class="btn btn-std" style="width:auto; padding:10px; font-size:0.8rem; margin:0;" onclick="startFromId('easy')">Easy</button>
        
        <button class="btn btn-hard" style="width:auto; padding:10px; font-size:0.8rem; margin:0; border-color:#27ae60; color:#abebc6;" onclick="startFromId('standard')">Standard</button>
        
        <button class="btn btn-hard" style="width:auto; padding:10px; font-size:0.8rem; margin:0;" onclick="startFromId('hard')">Hard</button>
        
        <button class="btn btn-night" style="width:auto; padding:10px; font-size:0.8rem; margin:0;" onclick="startFromId('nightmare')">Nightmare</button>
        
        <button class="btn btn-chaos" style="width:auto; padding:10px; font-size:0.8rem; margin:0;" onclick="startFromId('chaos')">Chaos</button>
        
        <button class="btn btn-omega" style="width:auto; padding:10px; font-size:0.8rem; margin:0; border:1px solid #fff;" onclick="startFromId('omega')">Î©</button>
      </div>
      
      <button class="btn btn-std" style="margin-top:15px; width:100%; border-color:#555; color:#aaa;" onclick="closeIdModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>


  <div id="history-modal" class="modal-overlay">
    <div id="history-content">
      <div class="close-help" onclick="closeHistory()">Ã—</div>
      <h3 style="color:#fff; margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">æ¢æŸ»ã®è¨˜éŒ²</h3>
      <div id="history-list"></div>
    </div>
  </div>
  <div id="tut-overlay"></div> <div id="tut-box" class="tut-msg-box" style="display:none;">
    <div id="tut-text" class="tut-text">ã“ã“ã«èª¬æ˜ãŒå…¥ã‚Šã¾ã™</div>
    <div id="tut-pointer" class="tut-arrow" style="display:none;">â¬‡</div>
    <button id="tut-btn" class="tut-next-btn" onclick="nextTutorialStep()">æ¬¡ã¸</button>
  </div>
<script>
// --- LOGIC ENGINE v7.3 (Final Balance) ---

// ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ã®çŠ¶æ…‹å¤‰æ•°
let isTutorialMode = false;
let tutStep = 0;


class SeededRandom {
  constructor(seedStr) {
    let h = 2166136261 >>> 0;
    for (let i = 0; i < seedStr.length; i++) {
      h = Math.imul(h ^ seedStr.charCodeAt(i), 16777619);
    }
    this.a = h >>> 0;
  }
  next() {
    let t = this.a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }
}
let rng = null;

// --- è¿½åŠ ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
function colorize(text) {
  if (!text) return "";
  return text
    .replace(/ç‚/g, '<span style="color:#ff9999; font-weight:bold;">ç‚</span>')
    .replace(/æ°´/g, '<span style="color:#99ccff; font-weight:bold;">æ°´</span>')
    .replace(/é¢¨/g, '<span style="color:#99ffcc; font-weight:bold;">é¢¨</span>');
}

/* diff: 1 -> ç°¡å˜ (å˜ä¸€ã®å€¤ã€å˜ç´”ãªå¶å¥‡)
  diff: 2 -> æ™®é€š (2ã¤ã®æ¯”è¼ƒã€å˜ç´”ãªåˆè¨ˆ)
  diff: 3 -> é›£ã—ã„ (3ã¤ã®é–¢ä¿‚ã€è¤‡é›‘ãªæ¡ä»¶ã€å¦å®šå½¢)
*/
const POOL = [
  { name:"ç‚ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"ç‚ = å¶æ•°", f:(i,a,v)=>i%2==0, diff:1 }, 
  { name:"ç‚ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"ç‚ = å¥‡æ•°", f:(i,a,v)=>i%2!=0, diff:1 }, 
  { name:"æ°´ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"æ°´ = å¶æ•°", f:(i,a,v)=>a%2==0, diff:1 }, 
  { name:"æ°´ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"æ°´ = å¥‡æ•°", f:(i,a,v)=>a%2!=0 , diff:1}, 
  { name:"é¢¨ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"é¢¨ = å¶æ•°", f:(i,a,v)=>v%2==0 , diff:1}, 
  { name:"é¢¨ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"é¢¨ = å¥‡æ•°", f:(i,a,v)=>v%2!=0 , diff:1},

    // ç‚ãƒ»æ°´ãƒ»é¢¨ã¨1ã€œ5ã®é–¢ä¿‚ï¼ˆ<, =, >ï¼‰
  { name:"ç‚ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"ç‚ = 1", f:(i,a,v)=>i==1 , diff:1},
  { name:"ç‚ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"ç‚ > 1", f:(i,a,v)=>i>1 , diff:1},
  { name:"æ°´ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"æ°´ = 1", f:(i,a,v)=>a==1, diff:1 },
  { name:"æ°´ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"æ°´ > 1", f:(i,a,v)=>a>1 , diff:1},
  { name:"é¢¨ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"é¢¨ = 1", f:(i,a,v)=>v==1, diff:1 },
  { name:"é¢¨ã¨1ã®é–¢ä¿‚ ( =, >)", desc:"é¢¨ > 1", f:(i,a,v)=>v>1, diff:1 },
  
  { name:"ç‚ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ = 2", f:(i,a,v)=>i==2, diff:1 },
  { name:"ç‚ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ > 2", f:(i,a,v)=>i>2 , diff:1},
  { name:"ç‚ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ < 2", f:(i,a,v)=>i<2 , diff:1},
  { name:"æ°´ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ = 2", f:(i,a,v)=>a==2, diff:1 },
  { name:"æ°´ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ > 2", f:(i,a,v)=>a>2, diff:1 },
  { name:"æ°´ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ < 2", f:(i,a,v)=>a<2 , diff:1},
  { name:"é¢¨ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ = 2", f:(i,a,v)=>v==2, diff:1 },
  { name:"é¢¨ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ > 2", f:(i,a,v)=>v>2, diff:1 },
  { name:"é¢¨ã¨2ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ < 2", f:(i,a,v)=>v<2, diff:1 },

  { name:"ç‚ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ = 3", f:(i,a,v)=>i==3 , diff:1},
  { name:"ç‚ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ > 3", f:(i,a,v)=>i>3, diff:1 },
  { name:"ç‚ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ < 3", f:(i,a,v)=>i<3, diff:1 },
  { name:"æ°´ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ = 3", f:(i,a,v)=>a==3, diff:1 },
  { name:"æ°´ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ > 3", f:(i,a,v)=>a>3 , diff:1},
  { name:"æ°´ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ < 3", f:(i,a,v)=>a<3 , diff:1},
  { name:"é¢¨ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ = 3", f:(i,a,v)=>v==3 , diff:1},
  { name:"é¢¨ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ > 3", f:(i,a,v)=>v>3 , diff:1},
  { name:"é¢¨ã¨3ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ < 3", f:(i,a,v)=>v<3 , diff:1},

  { name:"ç‚ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ = 4", f:(i,a,v)=>i==4 , diff:1},
  { name:"ç‚ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ > 4", f:(i,a,v)=>i>4 , diff:1},
  { name:"ç‚ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚ < 4", f:(i,a,v)=>i<4 , diff:1},
  { name:"æ°´ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ = 4", f:(i,a,v)=>a==4, diff:1 },
  { name:"æ°´ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ > 4", f:(i,a,v)=>a>4 , diff:1},
  { name:"æ°´ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´ < 4", f:(i,a,v)=>a<4 , diff:1},
  { name:"é¢¨ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ = 4", f:(i,a,v)=>v==4 , diff:1},
  { name:"é¢¨ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ > 4", f:(i,a,v)=>v>4 , diff:1},
  { name:"é¢¨ã¨4ã®é–¢ä¿‚ (<, =, >)", desc:"é¢¨ < 4", f:(i,a,v)=>v<4 , diff:1},

  { name:"ç‚ã¨5ã®é–¢ä¿‚ (<, = )", desc:"ç‚ = 5", f:(i,a,v)=>i==5 , diff:1},
  { name:"ç‚ã¨5ã®é–¢ä¿‚ (<, = )", desc:"ç‚ < 5", f:(i,a,v)=>i<5 , diff:1},
  { name:"æ°´ã¨5ã®é–¢ä¿‚ (<, = )", desc:"æ°´ = 5", f:(i,a,v)=>a==5, diff:1 },
  { name:"æ°´ã¨5ã®é–¢ä¿‚ (<, = )", desc:"æ°´ < 5", f:(i,a,v)=>a<5 , diff:1},
  { name:"é¢¨ã¨5ã®é–¢ä¿‚ (<, = )", desc:"é¢¨ = 5", f:(i,a,v)=>v==5, diff:1 },
  { name:"é¢¨ã¨5ã®é–¢ä¿‚ (<, = )", desc:"é¢¨ < 5", f:(i,a,v)=>v<5, diff:1 },

  { name:"ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ > æ°´", f:(i,a,v)=>i>a, diff:2 }, 
  { name:"ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ < æ°´", f:(i,a,v)=>i<a, diff:2 }, 
  { name:"ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ = æ°´", f:(i,a,v)=>i==a, diff:2 },
  { name:"æ°´ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"æ°´ > é¢¨", f:(i,a,v)=>a>v , diff:2}, 
  { name:"æ°´ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"æ°´ < é¢¨", f:(i,a,v)=>a<v , diff:2}, 
  { name:"æ°´ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"æ°´ = é¢¨", f:(i,a,v)=>a==v , diff:2},
  { name:"ç‚ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ > é¢¨", f:(i,a,v)=>i>v, diff:2 }, 
  { name:"ç‚ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ < é¢¨", f:(i,a,v)=>i<v , diff:2}, 
  { name:"ç‚ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ = é¢¨", f:(i,a,v)=>i==v, diff:2 },

  { name:"æœ€å¤§å€¤ã®æ‰€åœ¨ (â‰§)", desc:"ç‚ãŒæœ€å¤§ (ä»–ä»¥ä¸Š)", f:(i,a,v)=>i>=a && i>=v, diff:2 }, 
  { name:"æœ€å¤§å€¤ã®æ‰€åœ¨ (â‰§)", desc:"æ°´ãŒæœ€å¤§ (ä»–ä»¥ä¸Š)", f:(i,a,v)=>a>=i && a>=v , diff:2}, 
  { name:"æœ€å¤§å€¤ã®æ‰€åœ¨ (â‰§)", desc:"é¢¨ãŒæœ€å¤§ (ä»–ä»¥ä¸Š)", f:(i,a,v)=>v>=i && v>=a, diff:2 }, 
  { name:"æœ€å°å€¤ã®æ‰€åœ¨ (â‰¦)", desc:"ç‚ãŒæœ€å° (ä»–ä»¥ä¸‹)", f:(i,a,v)=>i<=a && i<=v, diff:2 }, 
  { name:"æœ€å°å€¤ã®æ‰€åœ¨ (â‰¦)", desc:"æ°´ãŒæœ€å° (ä»–ä»¥ä¸‹)", f:(i,a,v)=>a<=i && a<=v, diff:2 }, 
  { name:"æœ€å°å€¤ã®æ‰€åœ¨ (â‰¦)", desc:"é¢¨ãŒæœ€å° (ä»–ä»¥ä¸‹)", f:(i,a,v)=>v<=i && v<=a , diff:2}, 

  { name:"åˆè¨ˆã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"åˆè¨ˆ = å¶æ•°", f:(i,a,v)=>(i+a+v)%2==0 , diff:2},
  { name:"åˆè¨ˆã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"åˆè¨ˆ = å¥‡æ•°", f:(i,a,v)=>(i+a+v)%2!=0 , diff:2},
  { name:"åˆè¨ˆã¨6ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ < 6", f:(i,a,v)=>(i+a+v)<6 , diff:2},
  { name:"åˆè¨ˆã¨6ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ â‰§ 6", f:(i,a,v)=>(i+a+v)>=6 , diff:2},
  { name:"åˆè¨ˆã¨10ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ < 10", f:(i,a,v)=>(i+a+v)<10 , diff:2},
  { name:"åˆè¨ˆã¨10ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ â‰§ 10", f:(i,a,v)=>(i+a+v)>=10, diff:2 },

  { name:"ç´ æ•°ã®æœ‰ç„¡ (ã‚ã‚Š, ãªã—)", desc:"ç´ æ•°ã‚’å«ã‚€", f:(i,a,v)=>[i,a,v].some(n=>[2,3,5].includes(n)), diff:2 },
  { name:"ç´ æ•°ã®æœ‰ç„¡ (ã‚ã‚Š, ãªã—)", desc:"ç´ æ•°ã‚’å«ã¾ãªã„", f:(i,a,v)=>![i,a,v].some(n=>[2,3,5].includes(n)), diff:2 },

  { name:"ç‚+æ°´ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+æ°´ > 5", f:(i,a,v)=>(i+a)>5 , diff:3},
  { name:"ç‚+æ°´ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+æ°´ < 5", f:(i,a,v)=>(i+a)<5  , diff:3},
  { name:"ç‚+æ°´ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+æ°´ = 5", f:(i,a,v)=>(i+a)==5  , diff:3},
  { name:"æ°´+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´+é¢¨ > 5", f:(i,a,v)=>(a+v)>5 , diff:3 },
  { name:"æ°´+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´+é¢¨ < 5", f:(i,a,v)=>(a+v)<5  , diff:3},
  { name:"æ°´+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´+é¢¨ = 5", f:(i,a,v)=>(a+v)==5 , diff:3 },
  { name:"ç‚+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+é¢¨ > 5", f:(i,a,v)=>(i+v)>5  , diff:3},
  { name:"ç‚+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+é¢¨ < 5", f:(i,a,v)=>(i+v)<5  , diff:3},
  { name:"ç‚+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+é¢¨ = 5", f:(i,a,v)=>(i+v)==5  , diff:3},

  { name:"å¶æ•°ã®æ•° (0, 1, 2)", desc:"å¶æ•°ãŒ0å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n%2==0).length==0  , diff:3},
  { name:"å¶æ•°ã®æ•° (0, 1, 2)", desc:"å¶æ•°ãŒ1å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n%2==0).length==1 , diff:3 },
  { name:"å¶æ•°ã®æ•° (0, 1, 2)", desc:"å¶æ•°ãŒ2å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n%2==0).length==2 , diff:3 },
  { name:"1ã®æ•° (0, 1, 2, 3)", desc:"1ã‚’å«ã¾ãªã„", f:(i,a,v)=>[i,a,v].filter(n=>n==1).length==0  , diff:3},
  { name:"1ã®æ•° (0, 1, 2, 3)", desc:"1ãŒ1å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==1).length==1  , diff:3},
  { name:"1ã®æ•° (0, 1, 2, 3)", desc:"1ãŒ2å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==1).length==2 , diff:3 },
  { name:"1ã®æ•° (0, 1, 2, 3)", desc:"1ãŒ3å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==1).length==3 , diff:3 },
  { name:"3ã®æ•° (0, 1, 2, 3)", desc:"3ã‚’å«ã¾ãªã„", f:(i,a,v)=>[i,a,v].filter(n=>n==3).length==0 , diff:3 },
  { name:"3ã®æ•° (0, 1, 2, 3)", desc:"3ãŒ1å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==3).length==1  , diff:3},
  { name:"3ã®æ•° (0, 1, 2, 3)", desc:"3ãŒ2å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==3).length==2 , diff:3 },
  { name:"3ã®æ•° (0, 1, 2, 3)", desc:"3ãŒ3å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==3).length==3  , diff:3},
  
  
  { name:"é †åºã®æ³•å‰‡ (æ˜‡é †, é™é †, é †ä¸åŒ)", desc:"æ˜‡é † (ç‚ < æ°´ < é¢¨)", f:(i,a,v)=> (i < a && a < v)  , diff:3},
  { name:"é †åºã®æ³•å‰‡ (æ˜‡é †, é™é †, é †ä¸åŒ)", desc:"é™é † (ç‚ > æ°´ > é¢¨)", f:(i,a,v)=> (i > a && a > v)  , diff:3},
  { name:"é †åºã®æ³•å‰‡ (æ˜‡é †, é™é †, é †ä¸åŒ)", desc:"é †ä¸åŒ (ãƒãƒ©ãƒãƒ©)", f:(i,a,v)=> !((i < a && a < v) || (i > a && a > v))  , diff:3},


  { name:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(0 , 1 , 2)", desc:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(0ç®‡æ‰€)", f:(i,a,v)=> {
      let c = 0;
      if(Math.abs(i-a) === 1) c++;
      if(Math.abs(a-v) === 1) c++;
      return c === 0;
  } , diff:3},
  { name:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(0 , 1 , 2)", desc:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(1ç®‡æ‰€)", f:(i,a,v)=> {
      let c = 0;
      if(Math.abs(i-a) === 1) c++;
      if(Math.abs(a-v) === 1) c++;
      return c === 1;
  } , diff:3},
  { name:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(0 , 1 , 2)", desc:"éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(å®Œå…¨é€£çµ)", f:(i,a,v)=> {
      let c = 0;
      if(Math.abs(i-a) === 1) c++;
      if(Math.abs(a-v) === 1) c++;
      return c === 2;
  } , diff:3},
  { name:"2ã¤ã®åŒã˜æ•°å­— (ãªã—, 1çµ„)", desc:"2ã¤ã®åŒã˜æ•°å­—ã¯ãªã„ (ã™ã¹ã¦ç•°ãªã‚‹)", f:(i,a,v)=> (i!=a && a!=v && i!=v) },
  { name:"2ã¤ã®åŒã˜æ•°å­— (ãªã—, 1çµ„)", desc:"åŒã˜æ•°å­—ãŒå«ã¾ã‚Œã‚‹ (ãƒšã‚¢ or ãƒˆãƒªã‚ª)", f:(i,a,v)=> {
      return (i===a || a===v || i===v);
  } , diff:3},
  { name:"æœ€å¤§ã¨æœ€å°ã®å·®(0 ,1 ,2 ,3 ,4)", desc:"æœ€å¤§ã¨æœ€å°ã®å·®ãŒ 0 (ã™ã¹ã¦åŒã˜)", f:(i,a,v)=> (Math.max(i,a,v) - Math.min(i,a,v)) === 0 , diff:3 },
  { name:"æœ€å¤§ã¨æœ€å°ã®å·®(0 ,1 ,2 ,3 ,4)", desc:"æœ€å¤§ã¨æœ€å°ã®å·®ãŒ 1 ", f:(i,a,v)=> (Math.max(i,a,v) - Math.min(i,a,v)) === 1 , diff:3 },
  { name:"æœ€å¤§ã¨æœ€å°ã®å·®(0 ,1 ,2 ,3 ,4)", desc:"æœ€å¤§ã¨æœ€å°ã®å·®ãŒ 2 ", f:(i,a,v)=> (Math.max(i,a,v) - Math.min(i,a,v)) === 2 , diff:3 },
  { name:"æœ€å¤§ã¨æœ€å°ã®å·®(0 ,1 ,2 ,3 ,4)", desc:"æœ€å¤§ã¨æœ€å°ã®å·®ãŒ 3 ", f:(i,a,v)=> (Math.max(i,a,v) - Math.min(i,a,v)) === 3 , diff:3 },
  { name:"æœ€å¤§ã¨æœ€å°ã®å·®(0 ,1 ,2 ,3 ,4)", desc:"æœ€å¤§ã¨æœ€å°ã®å·®ãŒ 4 ", f:(i,a,v)=> (Math.max(i,a,v) - Math.min(i,a,v)) === 4 , diff:3 },

  { name:"åˆè¨ˆãŒç‰¹å®šã®å€æ•°(2, 3, 5)", desc:"åˆè¨ˆãŒ 2ã®å€æ•° ", f:(i,a,v)=> (i+a+v)%2 === 0 , diff:3 },
  { name:"åˆè¨ˆãŒç‰¹å®šã®å€æ•°(2, 3, 5)", desc:"åˆè¨ˆãŒ 3ã®å€æ•°", f:(i,a,v)=> (i+a+v)%3 === 0  , diff:3},
  { name:"åˆè¨ˆãŒç‰¹å®šã®å€æ•°(2, 3, 5)", desc:"åˆè¨ˆãŒ 5ã®å€æ•°", f:(i,a,v)=> (i+a+v)%5 === 0 , diff:3 },

  { name:"åˆè¨ˆå€¤ãŒç´ æ•°ã‹ã©ã†ã‹", desc:"åˆè¨ˆãŒç´ æ•° (3,5,7,11,13)", f:(i,a,v)=> {
      const sum = i+a+v;
      return [3, 5, 7, 11, 13].includes(sum);
  } , diff:3},
  { name:"åˆè¨ˆå€¤ãŒç´ æ•°ã‹ã©ã†ã‹", desc:"åˆè¨ˆãŒç´ æ•°ã§ã¯ãªã„", f:(i,a,v)=> {
      const sum = i+a+v;
      return ![3, 5, 7, 11, 13].includes(sum);
  } , diff:3},


];

let state = { 
  ans:{i:0,a:0,v:0}, rules:[], round:1, mana:0, maxMana:3, 
  liarIndex:-1, stoneCount:5, isOmega:false,
  currentSeed: "", currentMode: "",
  doomLimit: 0 // ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶é™(0ã¯ç„¡åˆ¶é™)
};

function generateSeed(length) {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

function limitInput(el) {
  if(el.value < 1) el.value = 1;
  if(el.value > 5) el.value = 5;
}

function initMatrix() {
  const grid = document.getElementById('logic-matrix');
  grid.innerHTML = '<div></div>'; 
  for(let n=1; n<=5; n++) grid.innerHTML += `<div class="grid-header">${n}</div>`;
  const rows = [
    {label:"ç‚", color:"#ff9999", id:"m-i"},
    {label:"æ°´", color:"#99ccff", id:"m-a"},
    {label:"é¢¨", color:"#99ffcc", id:"m-v"}
  ];
  rows.forEach(r => {
    grid.innerHTML += `<div class="grid-row-label" style="color:${r.color}">${r.label}</div>`;
    for(let n=1; n<=5; n++) {
      grid.innerHTML += `<div class="grid-cell" id="${r.id}-${n}" onclick="toggleCell(this)"></div>`;
    }
  });
  document.querySelectorAll('.memo-btn').forEach(btn => {
    btn.classList.remove('is-o');
    btn.classList.remove('is-x');
  });
}
function toggleCell(el) {
  if(el.classList.contains('cell-x')) {
    el.classList.remove('cell-x'); el.classList.add('cell-o');
  } else if(el.classList.contains('cell-o')) {
    el.classList.remove('cell-o');
  } else { el.classList.add('cell-x'); }
}
function toggleMemo(el) {
  if(el.classList.contains('is-x')) {
    el.classList.remove('is-x');
  } else if(el.classList.contains('is-o')) {
    el.classList.remove('is-o'); el.classList.add('is-x');
  } else { el.classList.add('is-o'); }
}
function toggleMemoArea() {
  document.getElementById('memo-pad').classList.toggle('closed');
}

function setBackground(mode) {
    const body = document.body;
    switch(mode) {
        case 'easy':
            // Easy: é™å¯‚ã®é’
            body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #1a252e 0%, #05080a 100%)"; 
            break;
        case 'standard':
            // Standard: æ·±ã„æ£®ã®ç·‘ (ãƒœã‚¿ãƒ³ã®è‰²ã«åˆã‚ã›ã‚‹)
            body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #152e1a 0%, #050a05 100%)"; 
            break;
        case 'hard':
            // Hard: å±é™ºãªèµ¤
            body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #3e1a1a 0%, #0a0505 100%)"; 
            break;
        case 'nightmare':
            // Nightmare: æ‚ªå¤¢ã®ç´«
            body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #2c1a3e 0%, #08050a 100%)"; 
            break;
        case 'chaos':
            // Chaos: è’å»ƒã—ãŸèŒ¶è‰²
            body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #3e2723 0%, #000000 100%)"; 
            break;
        case 'omega':
            // Omega: æ¼†é»’ã¨å¾®ã‹ãªé‡‘
            body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #1a1505 0%, #000000 100%)"; 
            break;
        default:
            // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ãªã©
            body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #1a150e 0%, #000000 100%)";
    }
}


 function startGame(mode) {
  isTutorialMode = false; // â˜…è¿½åŠ : é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤º
  const newSeed = generateSeed(5);
  initGame(mode, newSeed);
}

function startFromId(mode) {
  const input = document.getElementById('input-seed');
  const seed = input.value.trim().toUpperCase();
  if(!seed) { alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  closeIdModal();
  initGame(mode, seed);
}

function initGame(mode, seed) {
  document.getElementById('loading-indicator').style.display = 'block';

  // UIåˆæœŸåŒ–ç³»
  document.querySelectorAll('.btn-action').forEach(b => b.style.display = '');

  const manaBar = document.querySelector('.mana-bar');
  if(manaBar) {
    manaBar.style.color = '';
    manaBar.style.textShadow = '';
    manaBar.classList.remove('glitch-active');
  }
  const roundDisplay = document.getElementById('ui-round');
  if(roundDisplay && roundDisplay.parentNode) {
      roundDisplay.parentNode.classList.remove('glitch-active');
  }

  const oldFrame = document.querySelector('.divine-frame');
  if(oldFrame) oldFrame.remove();
  
  rng = new SeededRandom(seed);
  state.currentSeed = seed;
  state.currentMode = mode;
  
  setTimeout(() => {
    state.round = 1;
    state.mana = 0;
    state.totalChecks = 0;
    
    // --- â˜…é›£æ˜“åº¦åˆ¥ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š ---
    switch(mode) {
      case 'easy':      // æ—§Standard (ç°¡å˜)
        state.maxMana = 3;
        state.stoneCount = 4; 
        state.doomLimit = 0;
        break;
      case 'standard':  // æ—§Hard (æ¨™æº–)
        state.maxMana = 3;
        state.stoneCount = 5; 
        state.doomLimit = 0;
        break;
      case 'hard':      // â˜…æ–°è¨­ (é›£ã—ã„)
        state.maxMana = 3;
        state.stoneCount = 5;
        state.doomLimit = 0;
        break;
      case 'nightmare': // â˜…å¼·åŒ– (ãƒãƒŠæ¸›+æ­»ã®å®£å‘Š)
        state.maxMana = 2; 
        state.stoneCount = 5;
        state.doomLimit = 5; 
        break;
      case 'chaos':
        state.maxMana = 3;
        state.stoneCount = 5;
        state.doomLimit = 0;
        break;
      case 'omega':
        state.maxMana = 3;
        state.stoneCount = 5;
        state.doomLimit = 0;
        break;
    }
    state.isOmega = (mode === 'omega');

    const resultBtn = document.getElementById('btn-show-result');
    if(resultBtn) resultBtn.style.display = 'none';
    
    let success = false;
    let attempts = 0;
    const maxAttempts = 20000; 
    
    while(!success && attempts < maxAttempts) {
      attempts++;
      state.ans = {
        i: Math.floor(rng.next()*5)+1,
        a: Math.floor(rng.next()*5)+1,
        v: Math.floor(rng.next()*5)+1
      };
      
      // --- â˜…é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ---
      let minDiff = 1;
      let maxDiff = 3;

      if (mode === 'easy') {
        maxDiff = 2; // Easy: é›£ã—ã„å•é¡Œ(Lv3)ã‚’å‡ºã•ãªã„
      } else if (mode === 'hard' || mode === 'nightmare') {
        minDiff = 2; // Hardä»¥ä¸Š: ç°¡å˜ãªå•é¡Œ(Lv1)ã‚’å‡ºã•ãªã„
      }

      // æ¡ä»¶ã«åˆã†ãƒ«ãƒ¼ãƒ«ã‚’æŠ½å‡º
      let validRules = POOL.filter(r => {
        // 1. æ­£è§£ã¨æ•´åˆã—ã¦ã„ã‚‹ã‹
        if(r.f(state.ans.i, state.ans.a, state.ans.v) !== true) return false;
        
        // 2. é›£æ˜“åº¦ãŒç¯„å›²å†…ã‹ (diffæœªå®šç¾©ãªã‚‰1ã¨ã¿ãªã™)
        let d = r.diff || 1; 
        if(d < minDiff || d > maxDiff) return false;
        
        return true;
      });

      if(validRules.length < state.stoneCount) continue;

      // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦é¸å‡º
      let temp = [...validRules];
      for (let i = temp.length - 1; i > 0; i--) {
          const j = Math.floor(rng.next() * (i + 1));
          [temp[i], temp[j]] = [temp[j], temp[i]];
      }

      let picked = [];
      for(let r of temp) {
        if(picked.some(p => p.name === r.name)) continue; 
        if(isConflict(picked, r)) continue; 
        picked.push(r);
        if(picked.length === state.stoneCount) break;
      }

      // è¶³ã‚Šãªã‘ã‚Œã°è£œå…… (é‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ã)
      if(picked.length < state.stoneCount) {
        for(let r of temp) {
          if(picked.length === state.stoneCount) break;
          if(!picked.some(p => p.name === r.name)) {
            picked.push(r);
          }
        }
      }
      if(picked.length < state.stoneCount) continue;

      // è§£ã®ä¸€æ„æ€§æ¤œè¨¼
      let matches = 0;
      for(let i=1; i<=5; i++) {
        for(let a=1; a<=5; a++) {
          for(let v=1; v<=5; v++) {
             if(picked.every(rule => rule.f(i,a,v))) matches++;
          }
        }
      }

      if(matches === 1) {
        // Chaosãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
        if(mode === 'chaos') {
          const trueLiar = Math.floor(rng.next() * state.stoneCount);
          let solutionsForTrueLiar = countSolutionsWithLiar(picked, trueLiar);

          if(solutionsForTrueLiar === 1) {
            let isAmbiguous = false;
            for(let otherLiar = 0; otherLiar < state.stoneCount; otherLiar++) {
              if(otherLiar === trueLiar) continue; 
              let solutionsForOther = countSolutionsWithLiar(picked, otherLiar);
              if(solutionsForOther === 1) {
                isAmbiguous = true;
                break; 
              }
            }
            if(!isAmbiguous) {
              state.rules = picked;
              state.liarIndex = trueLiar;
              success = true;
            }
          }
        } else {
          // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
          state.rules = picked;
          state.liarIndex = -1;
          success = true;
        }
      }
    }

    document.getElementById('loading-indicator').style.display = 'none';

    if(!success) {
      alert("ç”Ÿæˆå¤±æ•—: æ¡ä»¶ã«åˆã†ãƒ‘ã‚ºãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å†è©¦è¡Œã—ã¾ã™ã€‚");
      // å¤±æ•—æ™‚ã¯å†å¸°ã›ãšã€ã‚·ãƒ¼ãƒ‰ã‚’å¤‰ãˆã¦ãƒªãƒˆãƒ©ã‚¤ã•ã›ã‚‹ç­‰ã®å‡¦ç†ãŒç†æƒ³ã§ã™ãŒ
      // ç°¡æ˜“çš„ã«ã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿ã¨ã—ã¾ã™
    } else {
      // æˆåŠŸæ™‚ã®ç”»é¢é·ç§»
      document.getElementById('title-screen').style.display = 'none';
      const tutBtn = document.getElementById('top-tut-btn');
      if(tutBtn) tutBtn.style.display = 'none';

      document.getElementById('game-screen').style.display = 'block';
      setBackground(mode);
      updateHUD();
      document.getElementById('log-container').innerHTML = '';
      
      const hud = document.querySelector('.hud');
      const oldId = document.getElementById('current-id-display');
      if(oldId) oldId.remove();
      
      hud.insertAdjacentHTML('afterend', 
        `<div id="current-id-display" style="text-align:center; color:#555; font-size:0.7rem; margin-top:-10px;">ID: <span style="font-family:'Cinzel',serif; color:#777;">${state.currentSeed}</span></div>`
      );

      document.getElementById('omega-rule-area').style.display = state.isOmega ? 'block' : 'none';

      initMatrix();
      renderProphecies();

      // ã‚«ã‚ªã‚¹æ¼”å‡º
      const chaosWarn = document.getElementById('chaos-warning');
      if (mode === 'chaos') {
        if(chaosWarn) {
            chaosWarn.style.display = 'none'; 
            chaosWarn.classList.remove('visible');
        }
        executeChaosIntro();
      } else {
        if(chaosWarn) chaosWarn.style.display = 'none';
      }

      // â–¼â–¼â–¼ â˜…è¿½åŠ : Nightmareè­¦å‘Šã®åˆæœŸåŒ– â–¼â–¼â–¼
      const nmWarn = document.getElementById('nightmare-warning');
      if(nmWarn) {
        nmWarn.style.display = 'none';
        nmWarn.classList.remove('visible');
      }
      // â–²â–²â–²â–²â–²â–²

      // ãƒŠã‚¤ãƒˆãƒ¡ã‚¢æ¼”å‡º
      if (mode === 'nightmare') {
        executeNightmareIntro();
      }

    }
  }, 100);
}


// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: æŒ‡å®šã—ãŸçŸ³ç¢‘ãŒå˜˜ã¤ãã ã¨ä»®å®šã—ãŸå ´åˆã®è§£ã®å€‹æ•°ã‚’æ•°ãˆã‚‹
function countSolutionsWithLiar(rules, liarIdx) {
  let count = 0;
  for(let i=1; i<=5; i++) {
    for(let a=1; a<=5; a++) {
      for(let v=1; v<=5; v++) {
         let validCount = 0;
         rules.forEach((r, idx) => {
           let res = r.f(i, a, v);
           if(idx === liarIdx) res = !res; // ã“ã„ã¤ãŒå˜˜ã¤ãã ã¨åè»¢
           if(res) validCount++;
         });
         // å…¨ã¦ã®ãƒ«ãƒ¼ãƒ«ã‚’æº€ãŸã™ãªã‚‰ã‚«ã‚¦ãƒ³ãƒˆ
         if(validCount === rules.length) count++;
      }
    }
  }
  return count;
}


// â–¼â–¼â–¼ initGameã®å¤–ã«å‡ºã—ãŸæ¼”å‡ºç”¨é–¢æ•° â–¼â–¼â–¼

async function executeNightmareIntro() {
  const slash = document.getElementById('nightmare-slash');
  const manaBar = document.querySelector('.mana-bar');
  const roundDisplay = document.getElementById('ui-round').parentNode;

  // 1. ä¸€ç¬ã®é™å¯‚ã¨æš—è»¢
  document.body.style.filter = "brightness(0.5)";
  
  // 2. æ–¬æ’ƒï¼ï¼
  if(slash) {
    slash.style.display = 'block';
    setTimeout(() => { 
        slash.style.display = 'none'; 
        document.body.style.filter = ""; 
    }, 200);
  }

  // 3. ãƒãƒŠã¨ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ã€Œç ´å£Šã€ã—ã¦æ›¸ãæ›ãˆã‚‹
  if(manaBar) manaBar.classList.add('glitch-active');
  if(roundDisplay) roundDisplay.classList.add('glitch-active');

  setTimeout(() => {
    // ãƒãƒŠã‚’3ã‹ã‚‰2ã¸å¼·åˆ¶æ”¹å¤‰ã™ã‚‹è¦–è¦šæ¼”å‡º
    const uiMana = document.getElementById('ui-mana');
    const uiRound = document.getElementById('ui-round');

    if(uiMana) uiMana.innerHTML = '<span style="text-decoration:line-through; color:#555;">3</span> 0/2';
    if(uiRound) uiRound.innerText = "1 / 5";
    
    // 4. æ¼”å‡ºçµ‚äº†ã€è‰²ã‚’ç¦ã€…ã—ã
    setTimeout(() => {
      if(manaBar) {
          manaBar.classList.remove('glitch-active');
          manaBar.style.color = "#ff0000";
          manaBar.style.textShadow = "0 0 10px #ff0000";
      }
      if(roundDisplay) roundDisplay.classList.remove('glitch-active');
      
      // â–¼â–¼â–¼ â˜…è¿½åŠ : è­¦å‘Šæ–‡ã‚’ã˜ã‚ã£ã¨å‡ºã™å‡¦ç† â–¼â–¼â–¼
      const nmWarn = document.getElementById('nightmare-warning');
      if(nmWarn) {
        nmWarn.style.display = 'block'; // ã¾ãšæ ã‚’ä½œã‚‹
        setTimeout(() => {
           nmWarn.classList.add('visible'); // ã˜ã‚ã£ã¨ä¸é€æ˜åº¦ã‚’ä¸Šã’ã‚‹
        }, 100);
      }
      // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    }, 1000);
  }, 500);
}


function executeChaosIntro() {
  const stones = document.querySelectorAll('.stone');
  const warningBar = document.getElementById('chaos-warning');
  
  // è­¦å‘Šæ–‡ã‚’ä¸€æ—¦éš ã™ï¼ˆå¿µã®ãŸã‚ï¼‰
  if(warningBar) warningBar.classList.remove('visible');

  stones.forEach((stone, index) => {
    // çŸ³ç¢‘ã®ä½ç½®ã‚’å–å¾—
    const rect = stone.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const topY = rect.top + window.scrollY; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è€ƒæ…®

    // å‘ªã„ã®ã‚ªãƒ¼ãƒ–ã‚’ç”Ÿæˆ
    const orb = document.createElement('div');
    orb.className = 'chaos-orb';
    document.body.appendChild(orb);

    // ã‚ªãƒ¼ãƒ–ã®é–‹å§‹ä½ç½®ï¼ˆç”»é¢ä¸Šéƒ¨ï¼‰ã¨çµ‚äº†ä½ç½®ã‚’è¨­å®š
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§åˆ¶å¾¡ã™ã‚‹ãŸã‚ã€CSSå¤‰æ•°ã§è½å·®ã‚’æ¸¡ã™æ‰‹ã‚‚ã‚ã‚Šã¾ã™ãŒã€
    // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«Web Animations APIã‚’ä½¿ã„ã¾ã™
    
    orb.style.left = (centerX - 10) + 'px'; // -10ã¯ã‚ªãƒ¼ãƒ–ã®åŠå¾„
    orb.style.top = (topY - 500) + 'px'; // ã‹ãªã‚Šä¸Šã‹ã‚‰

    // è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    // ãƒ©ãƒ³ãƒ€ãƒ ãªé…å»¶ã‚’å…¥ã‚Œã¦ãƒãƒ©ãƒãƒ©è½ã¡ã¦ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    const delay = index * 200; 
    const duration = 800;

    const animation = orb.animate([
      { transform: 'translateY(0) scale(1.5)', opacity: 0 },
      { transform: 'translateY(500px) scale(1)', opacity: 1 } // 500pxè½ä¸‹ã—ã¦ç€å¼¾
    ], {
      duration: duration,
      delay: delay,
      easing: 'cubic-bezier(0.5, 0, 1, 1)', // åŠ é€Ÿã—ãªãŒã‚‰è½ã¡ã‚‹
      fill: 'forwards'
    });

    // ç€å¼¾æ™‚ã®å‡¦ç†
    setTimeout(() => {
      orb.remove(); // ã‚ªãƒ¼ãƒ–æ¶ˆæ»…
      stone.classList.add('chaos-infected'); // çŸ³ç¢‘ãŒæ„ŸæŸ“ï¼
      
      // SEãŒã‚ã‚Œã°ã“ã“ã§å†ç”Ÿ
    }, delay + duration);
  });

  // å…¨ã¦ãŒç€å¼¾ã—ãŸå¾Œã«ã€è­¦å‘Šæ–‡ã‚’ã˜ã‚ã£ã¨è¡¨ç¤º
  setTimeout(() => {
    if(warningBar) {
      // 1. ã¾ãšã€Œé€æ˜ãªçŠ¶æ…‹ã§ã€ç®±ã‚’å‡ºç¾ã•ã›ã‚‹
      warningBar.style.display = 'block'; 
      
      // 2. ãƒ–ãƒ©ã‚¦ã‚¶ãŒç®±ã‚’æç”»ã™ã‚‹ã®ã‚’ã»ã‚“ã®å°‘ã—(0.1ç§’)å¾…ã¤
      setTimeout(() => {
        // 3. ãã®å¾Œã€ã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ã¦ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³é–‹å§‹ï¼
        warningBar.classList.add('visible');
      }, 100); 
    }
  }, 1500); // ç€å¼¾å¾…ã¡æ™‚é–“
}


// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°: ç¾åœ¨é¸æŠä¸­ã®ãƒ¡ãƒ¢æ¬„ã‚’è¨˜æ†¶ã™ã‚‹
let activeOmegaInput = null;

function renderProphecies() {
  const c = document.getElementById('prophecy-container');
  c.innerHTML = '';
  const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
  
  // --- 1. Omegaãƒ¢ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆè¡¨ç¤ºéƒ¨åˆ† ---
  if (state.isOmega) {
    const listContainer = document.getElementById('omega-list');
    listContainer.innerHTML = '';
    
    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¡¨ç¤º
    let displayRules = [...state.rules];
    displayRules.sort(() => Math.random() - 0.5); 

    displayRules.forEach((r,idx) => {
      const item = document.createElement('div');
      item.className = 'omega-list-item';
      item.innerHTML = colorize(r.name);
      
      const delay = 3000 + (idx * 100); 
      item.classList.add('falling');
      item.style.animationDelay = `${delay}ms`;
      
      setTimeout(() => {
        item.style.animation = 'none'; 
        item.style.opacity = '1'; 
        item.style.transform = 'translateY(0) scale(1)';
      }, delay + 3500);
      
      item.onmousedown = (e) => {
        if(activeOmegaInput) {
          e.preventDefault(); 
        }
      };

      item.onclick = () => {
        if (activeOmegaInput) {
          const currentText = activeOmegaInput.value;
          const newText = r.name.split(' (')[0]; 
          if(currentText) {
             activeOmegaInput.value = currentText + ", " + newText;
          } else {
             activeOmegaInput.value = newText;
          }
        } else {
          item.classList.toggle('excluded'); 
        }
      };
      listContainer.appendChild(item);
    });
  }

  // --- 2. çŸ³ç¢‘ã®ç”Ÿæˆéƒ¨åˆ† ---
  state.rules.forEach((r, idx) => {
    // ãƒ©ãƒƒãƒ‘ãƒ¼ä½œæˆ
    let wrapper = document.createElement('div');
    let div = document.createElement('div');
    
    if (state.isOmega) {
      div.className = 'stone is-mystery';
      div.classList.add('stone-fall'); 
      div.style.animationDelay = `${idx * 0.2}s`; 
      div.style.justifyContent = "space-between"; 
      
      // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: è½ä¸‹ãŒçµ‚ã‚ã£ãŸã‚‰ã€è½ä¸‹ã‚¯ãƒ©ã‚¹ã‚’æ¶ˆã—ã¦ã€Œå…‰ã‚‹ã‚¯ãƒ©ã‚¹ã€ã‚’ã¤ã‘ã‚‹ï¼
      div.onanimationend = () => {
        div.classList.remove('stone-fall');
        div.classList.add('omega-pulsing'); // â† ã“ã‚Œã§å…‰ã‚Šå§‹ã‚ã¾ã™ï¼
        div.style.opacity = 1; 
        div.style.transform = 'translateY(0)';
      };
      
      div.id = `stone-${idx}`;
      div.innerHTML = `
        <div class="stone-content">
          <div class="stone-title" style="display:block; color:#888;">äºˆè¨€ ${names[idx]}</div>
          <div class="stone-text" style="font-size:1.8rem; letter-spacing:3px;">???</div>
        </div>
        <div class="stone-id" style="color:#444;">${names[idx]}</div>
      `;
    } else {
      div.className = 'stone';
      div.id = `stone-${idx}`;
      div.innerHTML = `
        <div class="stone-content">
          <div class="stone-title">äºˆè¨€ ${names[idx]}</div>
          <div class="stone-text">${colorize(r.name)}</div> 
        </div>
        <div class="stone-id">${names[idx]}</div>
      `;
    }

    div.onclick = () => checkProphecy(idx, r, div);
    wrapper.appendChild(div);

    // Î©ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ãƒ¡ãƒ¢æ¬„ã¨ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    if (state.isOmega) {
      const memoBox = document.createElement('div');
      memoBox.className = 'omega-memo-box';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'omega-memo-input';
      input.placeholder = `äºˆè¨€${names[idx]} ã®ãƒ¡ãƒ¢`;
      
      input.onfocus = () => { activeOmegaInput = input; };
      input.onblur = () => { 
        setTimeout(() => {
          if(activeOmegaInput === input) activeOmegaInput = null;
        }, 200);
      };
      
      const copyBtn = document.createElement('div');
      copyBtn.className = 'btn-omega-copy';
      copyBtn.innerHTML = 'ğŸ“‹ï¸'; 
      copyBtn.title = "å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼";
      
      copyBtn.onclick = () => {
        if(!input.value) return;
        navigator.clipboard.writeText(input.value).then(() => {
          const originalIcon = copyBtn.innerHTML;
          copyBtn.innerHTML = 'âœ”';
          copyBtn.classList.add('copy-success');
          setTimeout(() => {
            copyBtn.innerHTML = originalIcon;
            copyBtn.classList.remove('copy-success');
          }, 1500);
        });
      };

      memoBox.appendChild(input);
      memoBox.appendChild(copyBtn);
      wrapper.appendChild(memoBox);
    }

    c.appendChild(wrapper);
  });
}


// â–¼â–¼â–¼ é«˜é€ŸåŒ–ä¿®æ­£: æ­£è¦è¡¨ç¾ã‚’å®šæ•°ã¨ã—ã¦å¤–ã«å‡ºã™ â–¼â–¼â–¼
const CONFLICT_REGEX = /^(.+)ã¨\d+ã®é–¢ä¿‚/;

function isConflict(pickedList, newRule) {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸæ­£è¦è¡¨ç¾ã‚’ä½¿ã†ï¼ˆã“ã“ãŒé«˜é€ŸåŒ–ã®è‚ï¼ï¼‰
  const matchNew = newRule.name.match(CONFLICT_REGEX);
  if(matchNew) {
    const key = matchNew[1]; 
    return pickedList.some(p => {
       const matchP = p.name.match(CONFLICT_REGEX);
       return matchP && matchP[1] === key;
    });
  }
  return false;
}


function checkProphecy(idx, rule, el) {
  // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«åˆ¶å¾¡
  if(isTutorialMode && tutStep !== 6 && tutStep !== 12 && tutStep !== 15 && tutStep !== 18) return;
  
  // ãƒãƒŠåˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
  if(state.mana >= state.maxMana) return;
  
  // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
  const i = +document.getElementById('r1').value;
  const a = +document.getElementById('r2').value;
  const v = +document.getElementById('r3').value;
  if(!i || !a || !v) return;
  
  // æœ€åˆã®åˆ¤å®šæ™‚ã«ãƒ­ãƒƒã‚¯ï¼†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  if(state.mana === 0) {
    document.getElementById('r1').disabled = true;
    document.getElementById('r2').disabled = true;
    document.getElementById('r3').disabled = true;
    const msg = document.getElementById('rune-lock-msg');
    if(msg) msg.style.display = 'block';
  }

  // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
  let isTrue = rule.f(i, a, v);
  if(idx === state.liarIndex) isTrue = !isTrue;

  // ãƒãƒŠæ¶ˆè²»ã¨æ›´æ–°
  state.mana++;
  state.totalChecks++; 
  updateHUD();
  
  // â˜…â˜…â˜… ã“ã“ã«è¿½åŠ ï¼ (æŠ¼ã—ãŸçŸ³ç¢‘ã‚’å³åº§ã«ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼†ã‚¯ãƒªãƒƒã‚¯ç¦æ­¢) â˜…â˜…â˜…
  if(el) el.classList.add('disabled'); 
  // â–²â–²â–²â–²â–²â–²

  // ãƒ­ã‚°å‡ºåŠ›
  const log = document.getElementById('log-container');
  const entry = document.createElement('div');
  const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
  
   // ã‚¯ãƒ©ã‚¹ã«ã‚ˆã‚‹é…è‰²ã¯CSSå´ã§åˆ¶å¾¡ (TRUE=é‡‘, FALSE=ç´«)
  entry.className = isTrue ? 'log-entry log-true' : 'log-entry log-false';
  
  // æ•°å­—ã®è‰²åˆ†ã‘ç”¨HTMLç”Ÿæˆ
  const numsHtml = `
    <span class="num-fire">${i}</span>-<span class="num-water">${a}</span>-<span class="num-wind">${v}</span>
  `;

  entry.innerHTML = `
    <div style="width:100%;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:bold;">R${state.round} äºˆè¨€${names[idx]}</span>
        <strong>${isTrue ? "TRUE" : "FALSE"}</strong>
      </div>
      <div style="font-size:0.85rem; margin:4px 0; color:rgba(255,255,255,0.7); padding-left:8px; border-left:2px solid rgba(255,255,255,0.1);">
        ${state.isOmega ? "???" : colorize(rule.name)}
      </div>
      <div style="text-align:right;">
        <span class="log-nums" style="background:#000; padding:2px 8px; border-radius:4px; font-family:'Cinzel',serif;">${numsHtml}</span>
      </div>
    </div>
  `;
  log.prepend(entry);

  if(state.mana >= state.maxMana) {
    document.querySelectorAll('.stone').forEach(s => s.classList.add('disabled'));
  }
}

function nextRound() {
  // ãƒãƒŠãŒæ®‹ã£ã¦ã„ã‚‹ã®ã«æŠ¼ã—ãŸå ´åˆï¼ˆé€šå¸¸æ™‚ã®ã¿ç„¡åŠ¹åŒ–ï¼‰
  if(state.mana === 0 && !isTutorialMode) return;
  
  // --- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ä¸­ã®ç‰¹åˆ¥å‡¦ç† ---
  if(isTutorialMode) {
    // ã‚¹ãƒ†ãƒƒãƒ—9ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†æŒ‡ç¤ºï¼‰ã®æ™‚ã ã‘è¨±å¯
    if(tutStep === 9) {
      state.round++;
      state.mana = 0;
      updateHUD();
      
      // â–¼â–¼â–¼ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã‚‚ã—ã£ã‹ã‚ŠãŠæƒé™¤ â–¼â–¼â–¼
      performRoundReset();
      
      nextTutorialStep(); // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
    }
    return;
  }

  // --- é€šå¸¸æ™‚ã®å‡¦ç† ---
  
  // ãƒŠã‚¤ãƒˆãƒ¡ã‚¢ãƒ¢ãƒ¼ãƒ‰ç­‰ã®ã€Œæ­»ã®å®£å‘Šã€ãƒã‚§ãƒƒã‚¯
  if(state.doomLimit > 0 && state.round >= state.doomLimit) {
    finishGame(false, "éºè·¡å´©å£Š");
    return;
  }
  
  state.round++;
  state.mana = 0;
  updateHUD();

  // â–¼â–¼â–¼ é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã—ã£ã‹ã‚ŠãŠæƒé™¤ â–¼â–¼â–¼
  performRoundReset();
}

// â˜…æ–°è¦è¿½åŠ : ãƒ©ã‚¦ãƒ³ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ã€ŒãŠæƒé™¤ã€
function performRoundReset() {
  const r1 = document.getElementById('r1');
  const r2 = document.getElementById('r2');
  const r3 = document.getElementById('r3');
  
  // 1. å…¥åŠ›ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
  r1.disabled = false;
  r2.disabled = false;
  r3.disabled = false;
  
  // 3. ã€Œãƒ­ãƒƒã‚¯ä¸­ã€ã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™ï¼
  const msg = document.getElementById('rune-lock-msg');
  if(msg) msg.style.display = 'none'; 

  // 4. çŸ³ç¢‘ã®ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã‚’è§£é™¤
  document.querySelectorAll('.stone').forEach(s => s.classList.remove('disabled'));
  
  // 5. ã™ãå…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã€Œç‚ã€ã«åˆã‚ã›ã‚‹
   if (!isTutorialMode) {
    r1.focus();
  }
}

function attemptUnlock() {
  const i = +document.getElementById('r1').value;
  const a = +document.getElementById('r2').value;
  const v = +document.getElementById('r3').value;
  const isCorrect = (i === state.ans.i && a === state.ans.a && v === state.ans.v);
  
  finishGame(isCorrect);
}

// çµ‚äº†å‡¦ç†
function finishGame(isWin, titleOverride) {
// â–¼â–¼â–¼ è¿½åŠ : ãƒªã‚¶ãƒ«ãƒˆç”»é¢ã®é‚ªé­”ã«ãªã‚‹ã®ã§Omegaãƒªã‚¹ãƒˆã‚’éš ã™ â–¼â–¼â–¼
  const omegaArea = document.getElementById('omega-rule-area');
  if(omegaArea) omegaArea.style.display = 'none';
  // â–²â–²â–²â–²â–²â–²
  const modal = document.getElementById('result-modal');
  modal.style.display = 'flex';
  
   const modeBadge = document.getElementById('result-mode-badge');
  if(modeBadge) {
    // ãƒ¢ãƒ¼ãƒ‰åã‚’è¡¨ç¤º (å¤§æ–‡å­—ã«å¤‰æ›)
    modeBadge.innerText = state.currentMode.toUpperCase();

    // ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®è‰²è¨­å®š
    let mColor = "#fff"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    let mGlow = "#fff";
    
        switch(state.currentMode) {
      case 'easy':     mColor = "#3498db"; mGlow = "#2980b9"; break; // é’
      case 'standard': mColor = "#27ae60"; mGlow = "#2ecc71"; break; // ç·‘
      case 'hard':     mColor = "#e74c3c"; mGlow = "#c0392b"; break; // èµ¤
      case 'nightmare':mColor = "#9b59b6"; mGlow = "#8e44ad"; break; // ç´«
      case 'chaos':    mColor = "#d35400"; mGlow = "#a04000"; break; // â˜…å¤‰æ›´: èŒ¶è‰²/ç„¦ã’èŒ¶
      case 'omega':    mColor = "#fff";    mGlow = "#d4af37"; break; // ç™½ï¼†é‡‘
    }

    modeBadge.style.color = mColor;
    modeBadge.style.textShadow = `0 0 15px ${mGlow}`;
  }
  
  // â˜…è¿½åŠ : Î©ãƒ¢ãƒ¼ãƒ‰ã‚¯ãƒªã‚¢æ™‚ã®ç¥æ¼”å‡º
  if (isWin && state.isOmega) {
    const frame = document.createElement('div');
    frame.className = 'divine-frame';
    document.body.appendChild(frame);
  }
  const title = document.querySelector('.seal-broken');
  if(isWin) {
    title.innerText = "å°å°è§£é™¤";
    title.style.color = "#fff";
  } else {
    title.innerText = titleOverride || "è§£é™¤å¤±æ•—";
    title.style.color = "#c0392b";
  }
  
  document.getElementById('final-code').innerText = `${state.ans.i} ${state.ans.a} ${state.ans.v}`;
  document.getElementById('final-round').innerText = state.round;
  
  // â˜…è¿½åŠ : æ¤œè¨¼å›æ•°ã‚’è¡¨ç¤º (å­˜åœ¨ãƒã‚§ãƒƒã‚¯ä»˜ã)
  const checksEl = document.getElementById('final-checks');
  if(checksEl) checksEl.innerText = state.totalChecks;

  saveHistory(isWin);

  const detailBox = document.getElementById('result-details');
  let html = '';
  const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
  state.rules.forEach((r, idx) => {
      const isLiar = (idx === state.liarIndex);
      const liarTag = isLiar ? '<span class="res-liar-txt">[å˜˜ã¤ã]</span> ' : '';
      html += `<div class="res-row">
        <div><strong>äºˆè¨€${names[idx]}</strong>: ${liarTag}${r.name}</div>
        <div style="color:#d4af37; padding-left:10px; font-size:0.85rem;">
           ğŸ‘‰ æ­£è§£ã®æ³•å‰‡: <strong>${r.desc}</strong>
        </div>
      </div>`;
  });
  detailBox.innerHTML = html;
}

function saveHistory(isWin) {
  // â˜…å¤‰æ›´: ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ä¿å­˜ã›ãšã«çµ‚äº†
  if (isTutorialMode) return;

  const historyItem = {
    seed: state.currentSeed,
    mode: state.currentMode,
    round: state.round,
    win: isWin,
    date: new Date().toLocaleString()
  };
  let history = JSON.parse(localStorage.getItem('omega_history') || '[]');
  history.unshift(historyItem);
  if(history.length > 30) history.pop();
  localStorage.setItem('omega_history', JSON.stringify(history));
}

// --- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
function showHistory() {
  // iPhoneå¯¾ç­–: å³ä¸Šã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒœã‚¿ãƒ³ã‚’éš ã™
  const tutBtn = document.getElementById('top-tut-btn');
  if(tutBtn) tutBtn.style.display = 'none';

  const modal = document.getElementById('history-modal');
  const list = document.getElementById('history-list');
  const history = JSON.parse(localStorage.getItem('omega_history') || '[]');
  
  modal.style.display = 'flex';
  list.innerHTML = '';
  
  if(history.length === 0) {
    list.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">è¨˜éŒ²ãªã—</div>';
    return;
  }

  history.forEach(h => {
    const item = document.createElement('div');
    item.className = 'hist-item';
    let modeLabel = h.mode.toUpperCase();
    if(h.mode==='standard') modeLabel = 'STD';
    if(h.mode==='nightmare') modeLabel = 'NIGHT';
    
    item.innerHTML = `
      <div class="hist-left">
        <span class="hist-mode mode-${h.mode}">${modeLabel}</span>
        <span class="hist-id">#${h.seed}</span>
        <div class="hist-date">${h.date} - R${h.round}</div>
      </div>
      <div style="display:flex; align-items:center;">
        <span class="hist-result ${h.win ? 'res-win':'res-lose'}">${h.win ? 'WIN':'LOSE'}</span>
        <button class="btn-replay" onclick="startFromHistory('${h.mode}', '${h.seed}')">å†æŒ‘æˆ¦</button>
      </div>
    `;
    list.appendChild(item);
  });
}

function startFromHistory(mode, seed) {
  closeHistory();
  initGame(mode, seed);
}

function reviewBoard() {
  document.getElementById('result-modal').style.display = 'none';
  const resultBtn = document.getElementById('btn-show-result');
  if(resultBtn) resultBtn.style.display = 'flex';
  
  document.getElementById('r1').disabled = true;
  document.getElementById('r2').disabled = true;
  document.getElementById('r3').disabled = true;
  document.querySelectorAll('.stone').forEach(s => s.classList.add('disabled'));
  document.querySelectorAll('.btn-action').forEach(b => b.style.display = 'none');

  if(state.liarIndex !== -1) {
      const liarStone = document.getElementById(`stone-${state.liarIndex}`);
      if(liarStone) liarStone.classList.add('is-liar');
  }
  
  if(state.isOmega) {
      const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
      state.rules.forEach((r, idx) => {
          const s = document.getElementById(`stone-${idx}`);
          if(s) {
              s.innerHTML = `
                <div style="font-size:0.7rem; color:#aaa;">${names[idx]}</div>
                <div style="font-size:0.9rem; color:#fff;">${r.name}</div>
              `;
              s.style.background = "#222";
              s.style.border = "1px solid #777";
          }
      });
  }
}

function showResult() { document.getElementById('result-modal').style.display = 'flex'; }
function updateHUD() {
  // åˆ¶é™ãŒã‚ã‚‹å ´åˆ "1 / 5" ã®ã‚ˆã†ã«è¡¨ç¤º
  const roundText = (state.doomLimit > 0) ? `${state.round} / ${state.doomLimit}` : state.round;
  document.getElementById('ui-round').innerText = roundText;
  document.getElementById('ui-mana').innerText = `${state.mana}/${state.maxMana}`;
}
// ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºé–¢æ•°ï¼ˆÃ—ãƒœã‚¿ãƒ³å‰Šé™¤ãƒ»ç†è§£ã—ãŸãƒœã‚¿ãƒ³ç‰ˆï¼‰
function showHelp() {
  const modal = document.getElementById('help-modal');
  modal.style.display = 'flex';
  
  // HTMLç”Ÿæˆç”¨ã®å¤‰æ•°
  let difficultyHtml = '';
  const mode = state.currentMode || 'standard';

  // --- 1. é›£æ˜“åº¦åˆ¥ã®ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ« ---
  if (mode === 'nightmare') {
    difficultyHtml = `
      <div class="help-section" style="border-color:#9b59b6; background:rgba(44, 26, 62, 0.4);">
        <div class="help-title" style="color:#d7bde2;">â˜… NIGHTMAREã®ãƒ«ãƒ¼ãƒ«</div>
        <div class="help-text">
          <ul>
            <li><strong>æ­»ã®å®£å‘Š:</strong> <span style="color:#ff5555;">å°å°è§£é™¤ã‚’å«ã‚ã¦5ãƒ©ã‚¦ãƒ³ãƒ‰</span>çµŒéã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã€‚</li>
            <li><strong>é­”åŠ›æ¯æ¸‡:</strong> 1ãƒ©ã‚¦ãƒ³ãƒ‰ã®ãƒãƒŠã¯ <span style="color:#ff5555;">2ã¤</span> ã®ã¿ã€‚</li>
          </ul>
        </div>
      </div>`;
  } else if (mode === 'chaos') {
    difficultyHtml = `
      <div class="help-section" style="border-color:#95a5a6; background:rgba(50,50,50,0.4);">
        <div class="help-title" style="color:#ccc;">â˜… CHAOS (æ··æ²Œ) ã®ãƒ«ãƒ¼ãƒ«</div>
        <div class="help-text">
          <ul>
            <li><strong>å˜˜ã¤ã:</strong> çŸ³ç¢‘ã®ä¸­ã«1ã¤ã ã‘<span style="color:#ff5555;">ã€Œåˆ¤å®šã‚’é€†ã«ã™ã‚‹å˜˜ã¤ãã€</span>ãŒæ··ã–ã£ã¦ã„ã¾ã™ã€‚</li>
            <li>çŸ›ç›¾ã‚’è¦‹æŠœã„ã¦ã€å˜˜ã¤ãã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚</li>
          </ul>
        </div>
      </div>`;
  } else if (mode === 'omega') {
    difficultyHtml = `
      <div class="help-section" style="border-color:#fff; background:rgba(0,0,0,0.6);">
        <div class="help-title" style="color:#fff;">â˜… OMEGA (Î©) ã®ãƒ«ãƒ¼ãƒ«</div>
        <div class="help-text">
          <ul>
            <li><strong>ä¸å¯è¦–:</strong> å…¨ã¦ã®äºˆè¨€ã®å†…å®¹ãŒ <span style="color:#fff;">???</span> ã§ã™ã€‚</li>
            <li>å³ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰ã€é©ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’æ¨ç†ã—ã¦ãã ã•ã„ã€‚</li>
          </ul>
        </div>
      </div>`;
  } else if (mode === 'hard') {
     difficultyHtml = `
      <div class="help-section" style="border-color:#e74c3c; background:rgba(62, 26, 26, 0.4);">
        <div class="help-title" style="color:#f5b7b1;">â˜… HARD (é«˜é›£åº¦) ã®ãƒ«ãƒ¼ãƒ«</div>
        <div class="help-text">
          ã€Œç‚=1ã€ã®ã‚ˆã†ãªå˜ç´”ãªãƒ’ãƒ³ãƒˆãŒå‡ºç¾ã«ããã€<br>
          è¨ˆç®—ã‚„æ¯”è¼ƒãŒå¿…è¦ãªã€æ‰‹ã”ã‚ã„äºˆè¨€ãŒç™»å ´ã—ã‚„ã™ã„ã§ã™ã€‚
        </div>
      </div>`;
  }

  // --- 2. å…±é€šã‚¬ã‚¤ãƒ‰ ---
  const contentHtml = `
    <h2 style="text-align:center; margin-top:0; color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">éºè·¡è§£æãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h2>
    
    ${difficultyHtml}

    <div class="help-section">
      <div class="help-title">1. ã‚²ãƒ¼ãƒ ã®ç›®çš„</div>
      <div class="help-text">
        éš ã•ã‚ŒãŸæ­£è§£ã®æ•°å­—ï¼ˆ<span style="color:#ff9999">ç‚</span>ãƒ»<span style="color:#99ccff">æ°´</span>ãƒ»<span style="color:#99ffcc">é¢¨</span> ãã‚Œãã‚Œ1ã€œ5ï¼‰ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã§ã™ã€‚<br>
        ã„ããªã‚Šå½“ã¦ã‚‹ã®ã¯ç„¡ç†ãªã®ã§ã€<strong>ã€Œäºˆè¨€ã®çŸ³ç¢‘ã€</strong>ã«è³ªå•ã‚’ã—ã¦ã€å°‘ã—ãšã¤çµã‚Šè¾¼ã¿ã¾ã™ã€‚
      </div>
    </div>

    <div class="help-section">
      <div class="help-title">2. è§£æã®æµã‚Œ (å›³è§£)</div>
      <div class="help-text">
        ä¾‹ãˆã°ã€ã‚ã‚‹çŸ³ç¢‘ã«<strong>ã€Œåˆè¨ˆã¨10ã®é–¢ä¿‚ã€</strong>ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ãŒæ›¸ã‹ã‚Œã¦ã„ãŸã¨ã—ã¾ã™ã€‚
      </div>

      <div class="diagram-box">
        <div style="width:100%; text-align:left; font-size:0.8rem; color:#aaa; margin-bottom:5px;">â–¼ STEP 1: ä»®ã®æ•°å­—ã‚’ã‚»ãƒƒãƒˆ</div>
        <div style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;">
          <div style="border:1px solid #8a1c1c; color:#ff9999; padding:5px 10px; border-radius:4px;">ç‚: 4</div>
          <div style="border:1px solid #1c4e8a; color:#99ccff; padding:5px 10px; border-radius:4px;">æ°´: 5</div>
          <div style="border:1px solid #1c8a5e; color:#99ffcc; padding:5px 10px; border-radius:4px;">é¢¨: 2</div>
        </div>
        <div style="font-size:0.8rem; color:#fff;">åˆè¨ˆ = <strong>11</strong> ã®çŠ¶æ…‹ã§ã™ã€‚</div>
      </div>

      <div style="text-align:center; font-size:1.5rem; color:#d4af37; margin:-10px 0;">â¬‡</div>

      <div class="diagram-box">
        <div style="width:100%; text-align:left; font-size:0.8rem; color:#aaa; margin-bottom:5px;">â–¼ STEP 2: çŸ³ç¢‘ã«åˆ¤å®šã•ã›ã‚‹</div>
        <div class="d-stone" style="width:95%;">
          <span>äºˆè¨€Î²: åˆè¨ˆã¨10ã®é–¢ä¿‚</span>
          <span style="font-weight:bold;">åˆ¤å®š â–¶</span>
        </div>
        <div style="margin:5px 0;">ã‚‚ã—ã€çµæœãŒã“ã†å‡ºãŸã‚‰â€¦ï¼Ÿ</div>
        <div class="d-result d-true" style="padding:10px; width:80%; text-align:center;">TRUE (çœŸå®Ÿ)</div>
      </div>

      <div class="diagram-box" style="border-color:#d4af37; background:rgba(212, 175, 55, 0.1);">
        <div style="width:100%; text-align:left; font-size:0.8rem; color:#d4af37; font-weight:bold; margin-bottom:5px;">â–¼ STEP 3: æ¨ç†</div>
        <div class="help-text" style="font-size:0.85rem;">
          ã€Œåˆè¨ˆ11ã€ã§ã€ŒTRUEã€ãŒå‡ºãŸã€‚<br>
          â†’ ã¤ã¾ã‚Šã“ã®çŸ³ç¢‘ã¯<strong>ã€Œåˆè¨ˆ â‰§ 10ã€</strong>ã®ãƒ«ãƒ¼ãƒ«ã ã¨æ¨æ¸¬ã§ãã¾ã™ã€‚<br>
          (ã‚‚ã—ã€Œåˆè¨ˆï¼œ10ã€ãªã‚‰FALSEã«ãªã‚‹ã¯ãšã ã‹ã‚‰ã§ã™)
        </div>
      </div>
    </div>

    <div class="help-section" style="border-bottom:none;">
      <div class="help-title">3. ãƒ¡ãƒ¢ã‚’æ´»ç”¨ã›ã‚ˆ</div>
      <div class="help-text">
        ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ¡ãƒ¢ã‚’å–ã‚Šã€å¯èƒ½æ€§ã‚’çµã‚Šè¾¼ã‚“ã§ã„ãã¾ã—ã‚‡ã†ã€‚
      </div>
    </div>

    <button class="btn btn-std" style="width:100%; box-sizing:border-box; margin-top:10px; padding:15px; font-weight:bold; font-size:1.1rem; border-color:#d4af37; color:#d4af37;" onclick="closeHelp()">ç†è§£ã—ãŸï¼</button>
  `;

  const contentDiv = document.getElementById('help-content');
  contentDiv.innerHTML = contentHtml;
}

  // --- TUTORIAL LOGIC v2 ---
function startTutorial() {
  if (typeof colorize !== 'function') {
    window.colorize = function(t) { return t; };
  }

  isTutorialMode = true;
  tutStep = 0;
  
  const tutBtn = document.getElementById('top-tut-btn');
  if(tutBtn) tutBtn.style.display = 'none';
  
  const loader = document.getElementById('loading-indicator');
  if(loader) loader.style.display = 'block';
  
  document.getElementById('title-screen').style.display = 'none';
  document.getElementById('game-screen').style.display = 'block';
  
  // --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´ & QUITãƒœã‚¿ãƒ³è¿½åŠ  ---
  try {
    const txt = document.getElementById('tut-text');
    if(txt) txt.innerHTML = '<div style="text-align:center; color:#888;">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>';

    // QUITãƒœã‚¿ãƒ³ã®å­˜åœ¨ç¢ºèªã¨ä½œæˆ
    let quitBtn = document.getElementById('tut-quit-btn');
    const tutBox = document.getElementById('tut-box');
    if (tutBox && !quitBtn) {
      quitBtn = document.createElement('button');
      quitBtn.id = 'tut-quit-btn';
      quitBtn.innerText = "ä¸­æ–­ã™ã‚‹";
      quitBtn.style.cssText = "position:absolute; top:10px; right:10px; background:transparent; border:1px solid #555; color:#888; font-size:0.7rem; padding:4px 8px; border-radius:4px; cursor:pointer;";
      quitBtn.onclick = quitTutorial;
      tutBox.appendChild(quitBtn);
    }
    if(quitBtn) quitBtn.style.display = 'block';

    // ãƒãƒˆãƒªã‚¯ã‚¹éè¡¨ç¤ºãªã©ã¯æ—¢å­˜é€šã‚Š
    const matrix = document.getElementById('logic-matrix');
    if(matrix) matrix.style.display = 'none';
    const memoBtn = document.querySelector('.memo-toggle-btn');
    if(memoBtn) memoBtn.style.display = 'none';
    const memoPad = document.getElementById('memo-pad');
    if(memoPad) memoPad.style.display = 'none';
    const runeContainer = document.querySelector('.rune-container');
    if(runeContainer) {
       const matrixLabel = runeContainer.nextElementSibling;
       if(matrixLabel && matrixLabel.innerText && matrixLabel.innerText.includes('LOGIC')) {
          matrixLabel.style.display = 'none';
       }
    }

    // BOXç§»å‹•
    const gameScreen = document.getElementById('game-screen');
    const prophecyContainer = document.getElementById('prophecy-container');
    if (gameScreen && tutBox && prophecyContainer) {
      gameScreen.insertBefore(tutBox, prophecyContainer);
      tutBox.classList.add('tut-embedded-mode');
      tutBox.style.display = 'flex';
    }
  } catch(e) { console.error("Layout Setup Error:", e); }
  
  setTimeout(() => {
    try {
      state.round = 1;
      state.mana = 0;
      state.totalChecks = 0;
      state.maxMana = 3; 
      state.stoneCount = 4; // â˜…å¤‰æ›´: 4ã¤ã«ã™ã‚‹
      
      // â˜…å¤‰æ›´: æ­£è§£ã‚’ 4-4-5 ã«è¨­å®š (é¢¨=5ã®ãƒ«ãƒ¼ãƒ«ã¨æ•´åˆã•ã›ã‚‹ãŸã‚)
      state.ans = { i:4, a:4, v:5 }; 
      
      state.liarIndex = -1;
      state.isOmega = false;
      
      // â˜…å¤‰æ›´: ãƒ«ãƒ¼ãƒ«ã‚»ãƒƒãƒˆã‚’å¼·åŒ–
      state.rules = [
        { name:"ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ = æ°´", f:(i,a,v)=>i==a },
        { name:"åˆè¨ˆã¨10ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ â‰§ 10", f:(i,a,v)=>(i+a+v)>=10 },
        { name:"é¢¨ã¨5ã®é–¢ä¿‚ (<, = )", desc:"é¢¨ = 5", f:(i,a,v)=>v==5 }, // â˜…å¤‰æ›´
        { name:"å¶æ•°ã®æ•° (0, 1, 2)", desc:"å¶æ•°ãŒ2å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n%2==0).length==2 } // â˜…è¿½åŠ 
      ];
      
      setBackground('standard');
      updateHUD();
      
      const logContainer = document.getElementById('log-container');
      if(logContainer) logContainer.innerHTML = '';
      
      const chaosWarn = document.getElementById('chaos-warning');
      if(chaosWarn) chaosWarn.style.display = 'none';
      const omegaArea = document.getElementById('omega-rule-area');
      if(omegaArea) omegaArea.style.display = 'none';
      
      initMatrix();
      const matrix = document.getElementById('logic-matrix');
      if(matrix) matrix.style.display = 'none';
      
      const c = document.getElementById('prophecy-container');
      if(c) {
        c.innerHTML = '';
        const names = ["Î±", "Î²", "Î³", "Î´"]; // Î´ã‚’è¿½åŠ 
        state.rules.forEach((r, idx) => {
          let div = document.createElement('div');
          div.className = 'stone';
          div.id = `stone-${idx}`;
          div.innerHTML = `
            <div class="stone-content">
              <div class="stone-title">äºˆè¨€ ${names[idx]}</div>
              <div class="stone-text">${colorize(r.name)}</div>
            </div>
            <div class="stone-id">${names[idx]}</div>
          `;
          div.onclick = () => { if(isTutorialMode) handleTutClick('stone', idx); };
          c.appendChild(div);
        });
      }

      document.getElementById('r1').value = "";
      document.getElementById('r2').value = "";
      document.getElementById('r3').value = "";

      nextTutorialStep(); 
    } catch(e) {
      alert("Tutorial Error: " + e);
    } finally {
      if(loader) loader.style.display = 'none';
    }
  }, 500);
}

// æ•°å­—ã‚’é †ç•ªã«å…¥åŠ›ã™ã‚‹æ¼”å‡ºé–¢æ•°
function typeNumber(n1, n2, n3, callback) {
  const r1 = document.getElementById('r1');
  const r2 = document.getElementById('r2');
  const r3 = document.getElementById('r3');
  
  // å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼å›é¿
  if(!r1 || !r2 || !r3) {
    console.error("ã‚¨ãƒ©ãƒ¼: å…¥åŠ›æ¬„(r1, r2, r3)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    if(callback) callback(); // ç„¡ç†ã‚„ã‚Šæ¬¡ã¸é€²ã‚ã‚‹
    return;
  }
  
  // å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
  r1.value = ""; r2.value = ""; r3.value = "";
  
  // ãƒªã‚ºãƒ ã‚ˆãå…¥åŠ› (0.7ç§’, 1.2ç§’, 1.6ç§’å¾Œ)
  setTimeout(() => { r1.value = n1; }, 700);
  setTimeout(() => { r2.value = n2; }, 1200);
  setTimeout(() => { r3.value = n3; }, 1600);
  
  // å…¨ã¦çµ‚ã‚ã£ãŸå¾Œã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œ (3ç§’å¾Œ)
  setTimeout(() => {
    if(callback) callback();
  }, 3000);
}

function handleTutClick(type, idx) {
  // ã‚¹ãƒ†ãƒƒãƒ—6: çŸ³ç¢‘Î±
  if(tutStep === 6 && type === 'stone' && idx === 0) {
    checkProphecy(0, state.rules[0], document.getElementById('stone-0'));
    nextTutorialStep(); 
  }
  // ã‚¹ãƒ†ãƒƒãƒ—12: çŸ³ç¢‘Î²
  if(tutStep === 12 && type === 'stone' && idx === 1) {
    checkProphecy(1, state.rules[1], document.getElementById('stone-1'));
    nextTutorialStep(); 
  }
  // ã‚¹ãƒ†ãƒƒãƒ—15: çŸ³ç¢‘Î³
  if(tutStep === 15 && type === 'stone' && idx === 2) {
    checkProphecy(2, state.rules[2], document.getElementById('stone-2'));
    nextTutorialStep(); 
  }
  // â˜…è¿½åŠ  ã‚¹ãƒ†ãƒƒãƒ—18: çŸ³ç¢‘Î´
  if(tutStep === 18 && type === 'stone' && idx === 3) {
    checkProphecy(3, state.rules[3], document.getElementById('stone-3'));
    nextTutorialStep(); 
  }
}


const originalAttemptUnlock = attemptUnlock;
// â˜…ä¿®æ­£: ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†æ™‚ã«æœ¬ç•ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹
attemptUnlock = function() {
  if(isTutorialMode) {
    // çµ‚äº†ã‚¹ãƒ†ãƒƒãƒ— 22
    if(tutStep === 22) {
      // 1. ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«è¡¨ç¤ºã®ãŠæƒé™¤
      document.querySelectorAll('.tut-highlight').forEach(e => e.classList.remove('tut-highlight'));
      document.querySelectorAll('.tut-blink').forEach(e => e.classList.remove('tut-blink'));
      
      const quitBtn = document.getElementById('tut-quit-btn');
      if(quitBtn) quitBtn.style.display = 'none';

      const tutBox = document.getElementById('tut-box');
      if(tutBox) {
        tutBox.style.display = 'none';
        tutBox.classList.remove('tut-embedded-mode');
        document.body.appendChild(tutBox); 
      }
      document.getElementById('tut-overlay').style.display = 'none';
      
      // UIå¾©å¸° (ãƒãƒˆãƒªã‚¯ã‚¹ãªã©ã‚’å†è¡¨ç¤º)
      const matrix = document.getElementById('logic-matrix');
      if(matrix) matrix.style.display = '';
      const memoBtn = document.querySelector('.memo-toggle-btn');
      if(memoBtn) memoBtn.style.display = '';
      const memoPad = document.getElementById('memo-pad');
      if(memoPad) memoPad.style.display = '';
      const runeContainer = document.querySelector('.rune-container');
      if(runeContainer) {
          const matrixLabel = runeContainer.nextElementSibling;
          if(matrixLabel) matrixLabel.style.display = '';
      }

      // 2. â˜…ã“ã“ã‚’å¤‰æ›´: ã„ããªã‚Šæœ¬ç•ªç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã‚’å‘¼ã¶ï¼
      // (é€šå¸¸ã¯ç¢ºèªç”»é¢ã‹ã‚‰å‘¼ã°ã‚Œã¾ã™ãŒã€ç›´æ¥å‘¼ã‚“ã§ã‚‚å‹•ãã¾ã™)
      executeUnlock();

      // 3. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³(ç´„2.3ç§’)ãŒçµ‚ã‚ã£ã¦ãƒªã‚¶ãƒ«ãƒˆãŒå‡ºãŸé ƒã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
      setTimeout(() => {
         alert("ãŠã‚ã§ã¨ã†ï¼\nãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯å®Œäº†ã ã€‚\nã•ã‚ã€æœ¬ç•ªã®éºè·¡ã¸æŒ‘ã‚‚ã†ï¼");
         // ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é–‰ã˜ãŸã‚‰çµ‚äº†å‡¦ç†
         quitTutorial();
      }, 3000);
    }
  } else {
    // --- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ (å¤‰æ›´ãªã—) ---
    const i = document.getElementById('r1').value;
    const a = document.getElementById('r2').value;
    const v = document.getElementById('r3').value;
    
    const omegaArea = document.getElementById('omega-rule-area');
    if(omegaArea) omegaArea.style.display = 'none';

    if(!i || !a || !v) {
      alert("æ•°å­—ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼");
      if(state.isOmega && omegaArea) omegaArea.style.display = 'block';
      return;
    }

    document.getElementById('confirm-nums').innerText = `${i} - ${a} - ${v}`;
    document.getElementById('confirm-modal').style.display = 'flex';
  }
};



function nextTutorialStep() {
  tutStep++;
  const txt = document.getElementById('tut-text');
  const btn = document.getElementById('tut-btn');
  
  // ãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll('.tut-highlight').forEach(e => e.classList.remove('tut-highlight'));
  document.querySelectorAll('.tut-blink').forEach(e => e.classList.remove('tut-blink'));
  document.getElementById('tut-overlay').style.display = 'block'; 
  
  btn.style.display = 'block'; 
  btn.innerText = "æ¬¡ã¸ â–¶";

  const cFire = '<span style="color:#ff9999; font-weight:bold;">ç‚</span>';
  const cWater = '<span style="color:#99ccff; font-weight:bold;">æ°´</span>';
  const cWind = '<span style="color:#99ffcc; font-weight:bold;">é¢¨</span>';

  switch(tutStep) {
    case 1:
      txt.innerHTML = `ã‚ˆã†ã“ãã€æ¢æ±‚è€…ã‚ˆã€‚<br>
      ã¾ãšã¯ç”»é¢å³ä¸Šã‚’è¦‹ã¦ã»ã—ã„ã€‚<br>
      ã“ã“ã«ã¯ç¾åœ¨ã®<b>ã€Œãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã€</b>ãŒåˆ»ã¾ã‚Œã¦ã„ã‚‹ã€‚<br>
      ä¸€åº¦ã‚»ãƒƒãƒˆã—ãŸæ•°å­—ã¯ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ã¾ã§å¤‰æ›´ã§ããªã„ãã€‚`;
      const uiRound = document.getElementById('ui-round');
      if(uiRound && uiRound.parentNode) uiRound.parentNode.classList.add('tut-highlight', 'tut-blink');
      break;

    case 2:
      txt.innerHTML = `ãã—ã¦ãã®ä¸ŠãŒ<b>ã€ŒãƒãƒŠã€</b>ã ã€‚<br>
      çŸ³ç¢‘ã«å•ã„ã‹ã‘ã‚‹ãŸã³ã« 1 æ¶ˆè²»ã™ã‚‹ã€‚<br>
      ãƒãƒŠãŒå°½ãã‚‹ã¨ã€å›å¾©ã™ã‚‹ãŸã‚ã«æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚€ã—ã‹ãªããªã‚‹ã€‚`;
      const manaBar = document.querySelector('.mana-bar');
      if(manaBar) manaBar.classList.add('tut-highlight', 'tut-blink');
      break;

    case 3:
      txt.innerHTML = `ã§ã¯ã€èª¿æŸ»ã‚’å§‹ã‚ã‚ˆã†ã€‚<br>
      å›ã®ç›®çš„ã¯ã€çŸ³ç¢‘ã«<b>ã€Œè³ªå•ã€</b>ã‚’ã—ã¦æ³•å‰‡ã‚’æš´ãã€éš ã•ã‚ŒãŸ<b>ã€Œ3ã¤ã®æ•°å­—ã€</b>ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã ã€‚`;
      break;
      
    case 4:
      txt.innerHTML = `ä¸‹ã«ã‚ã‚‹ã®ãŒ<b>ã€Œäºˆè¨€ã®çŸ³ç¢‘ã€</b>ã ã€‚<br>
      ã“ã‚Œã‚‰ã¯æ­£è§£ã®æ•°å­—ã«é–¢ã™ã‚‹ã€Œã‚ã‚‹æ³•å‰‡ã€ã‚’çŸ¥ã£ã¦ã„ã‚‹ã€‚<br>ã¾ãšã¯ã“ã‚Œã‚‰ã«æ³¨ç›®ã—ã¦ã»ã—ã„ã€‚`;
      const pContainer = document.getElementById('prophecy-container');
      if(pContainer) pContainer.classList.add('tut-highlight', 'tut-blink'); 
      break;

    case 5:
      txt.innerHTML = `ä¸Šã®å…¥åŠ›æ¬„ã‚’ä½¿ã£ã¦ã€çŸ³ç¢‘ã«è³ªå•ã‚’æŠ•ã’ã‹ã‘ã‚‹ã€‚<br>
      è©¦ã—ã«<b>ã€Œ1 - 1 - 1ã€</b>ã¨ã„ã†æ•°å­—ã‚’ã‚»ãƒƒãƒˆã—ã¦ã¿ã‚ˆã†ã€‚<br>
      (${cFire}:1, ${cWater}:1, ${cWind}:1 ã¨ã„ã†æ„å‘³ã )`;
      
      const runeBox = document.querySelector('.rune-container');
      if(runeBox) runeBox.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none';
      
      setTimeout(() => {
        if (typeof typeNumber !== 'function') {
           document.getElementById('r1').value = 1; document.getElementById('r2').value = 1; document.getElementById('r3').value = 1;
           btn.style.display = 'block'; btn.innerText = "OK"; return;
        }
        typeNumber(1, 1, 1, () => {
             txt.innerHTML = `ã‚ˆã—ã€‚ã€Œ1 - 1 - 1ã€ã¨ã‚»ãƒƒãƒˆå®Œäº†ã ã€‚<br>
             ã“ã‚Œã§çŸ³ç¢‘ã«èãæº–å‚™ãŒæ•´ã£ãŸã€‚<br>å³ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã‚Œã€‚`;
             btn.style.display = 'block'; btn.innerText = "OK";
        });
      }, 500);
      break;
      
    case 6:
      txt.innerHTML = `ã€Œã‚‚ã—æ­£è§£ãŒ 1-1-1 ã ã£ãŸã‚‰ã€ãŠå‰ã®æ³•å‰‡ã‚’æº€ãŸã™ã‹ï¼Ÿã€<br>
      ä¸€ç•ªä¸Šã®<b>ã€Œäºˆè¨€ Î±ã€</b>ã«ãã†èã„ã¦ã¿ã‚ˆã†ã€‚<br>
      ã‚¿ãƒƒãƒ—ã—ã¦åˆ¤å®šã‚’è¡Œãˆã€‚`;
      const s0 = document.getElementById('stone-0');
      if(s0) s0.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none'; 
      break;

    case 7: 
      const logTrue = `
        <div class="log-entry log-true" style="margin-top:10px; text-align:left;">
          <div style="width:100%;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:bold;">R1 äºˆè¨€Î±</span> <strong>TRUE</strong>
            </div>
            <div style="font-size:0.85rem; margin:4px 0; color:#ddd; padding-left:8px; border-left:2px solid rgba(255,255,255,0.2);">
              ${colorize("ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)")}
            </div>
            <div style="text-align:right;"><span class="log-nums">1-1-1</span></div>
          </div>
        </div>`;
      txt.innerHTML = `çŸ³ç¢‘ã®åå¿œãŒã‚ã£ãŸãï¼<br>${logTrue}<br>ã€Œ1-1-1ã€ã¯æ¡ä»¶ï¼ˆ${cFire} = ${cWater}ï¼‰ã‚’æº€ãŸã—ã¦ã„ã‚‹ãŸã‚ <b>TRUE</b> ã¨ãªã£ãŸã®ã ã€‚`;
      document.getElementById('log-container').classList.add('tut-highlight');
      break;

    case 8:
      txt.innerHTML = `ã“ã‚Œã§ã€Œ${cFire}ã¨${cWater}ãŒåŒã˜ã€ã¨ã‚ã‹ã£ãŸã€‚<br>
      ã•ã¦ã€åˆ¥ã®æ•°å­—ã‚’è©¦ã—ãŸã„ã¨ã“ã‚ã ãŒâ€¦<br>
      <b>ä¸€åº¦ã‚»ãƒƒãƒˆã—ãŸæ•°å­—(1-1-1)ã¯ã€ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ä¸­ã¯å¤‰æ›´ã§ããªã„ã€‚</b>`;
      break;

    case 9:
      txt.innerHTML = `æ–°ã—ã„æ•°å­—ã‚’è©¦ã™ã«ã¯ã€æ™‚é–“ã‚’é€²ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚<br>
      å³ä¸‹ã®<b>ã€Œæ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ã€</b>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã‚Œã€‚<br>
      ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ãŒé€²ã‚€ã¨ãƒãƒŠã‚‚å›å¾©ã™ã‚‹ãï¼‰`;
      const nextBtn = document.querySelector('.btn-next');
      if(nextBtn) nextBtn.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none'; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã®ã‚’å¾…ã¤
      break;

    case 10:
      txt.innerHTML = `ã‚ˆã—ï¼ <b>ãƒ©ã‚¦ãƒ³ãƒ‰2</b> ã«çªå…¥ã—ãŸã€‚<br>
      ã“ã‚Œã§å…¥åŠ›æ¬„ã®ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚Œã€å†ã³è‡ªç”±ã«æ•°å­—ã‚’ã‚»ãƒƒãƒˆã§ãã‚‹ã€‚<br>
      ã•ã‚ã€æ¤œè¨¼ã®ç¶šãã ã€‚`;
      document.getElementById('ui-round').parentNode.classList.add('tut-highlight');
      break;

    case 11:
      txt.innerHTML = `æ¬¡ã¯<b>ã€Œã‚ã–ã¨é–“é•ã£ãŸæ•°å­—ã€</b>ã‚’å…¥ã‚Œã¦åå¿œã‚’è¦‹ã‚‹ã®ãŒã‚³ãƒ„ã ã€‚<br>
      åˆè¨ˆãŒã¨ã¦ã‚‚å°ã•ã„<b>ã€Œ1 - 1 - 2ã€</b>ï¼ˆåˆè¨ˆ4ï¼‰ã‚’å…¥åŠ›ã—ã‚ˆã†ã€‚`;
      const runeBox2 = document.querySelector('.rune-container');
      if(runeBox2) runeBox2.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none';
      setTimeout(() => {
        if (typeof typeNumber !== 'function') {
           document.getElementById('r1').value = 1; document.getElementById('r2').value = 1; document.getElementById('r3').value = 2;
           btn.style.display = 'block'; btn.innerText = "OK"; return;
        }
        typeNumber(1, 1, 2, () => {
             btn.style.display = 'block'; btn.innerText = "OK";
        });
      }, 500);
      break;

    case 12:
      txt.innerHTML = `çœŸã‚“ä¸­ã®<b>ã€Œäºˆè¨€ Î²ã€</b>ã‚’ã‚¿ãƒƒãƒ—ã—ã‚ã€‚<br>
      ã“ã®çŸ³ç¢‘ã¯ã€Œåˆè¨ˆã€ã«é–¢ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’æŒã£ã¦ã„ã‚‹ã‚ˆã†ã ã€‚`;
      const s1 = document.getElementById('stone-1');
      if(s1) s1.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none';
      break;

    case 13:
      const logFalse = `
        <div class="log-entry log-false" style="margin-top:10px; text-align:left;">
          <div style="width:100%;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:bold;">R2 äºˆè¨€Î²</span> <strong>FALSE</strong>
            </div>
            <div style="font-size:0.85rem; margin:4px 0; color:#ddd; padding-left:8px; border-left:2px solid rgba(255,255,255,0.2);">
              ${colorize("åˆè¨ˆã¨10ã®é–¢ä¿‚ (<, â‰§)")}
            </div>
            <div style="text-align:right;"><span class="log-nums">1-1-2</span></div>
          </div>
        </div>`;
      txt.innerHTML = `åˆ¤å®šãŒå‡ºãŸï¼<br>${logFalse}<br><b>FALSE</b>ï¼ˆå½ã‚Šï¼‰ã ã€‚<br>åˆè¨ˆ4ã§ã¯ãƒ€ãƒ¡ã‚‰ã—ã„ã€‚ã€Œåˆè¨ˆã¯ã‚‚ã£ã¨å¤§ãã„ï¼ˆ10ä»¥ä¸Šï¼‰ã€ã¨ã„ã†ã“ã¨ã ï¼`;
      document.getElementById('log-container').classList.add('tut-highlight');
      break;

    case 14:
      txt.innerHTML = `FALSEãŒå‡ºãŸã“ã¨ã§ã€æ­£è§£ã‚’çµã‚Šè¾¼ã‚ãŸã€‚<br>
      ã—ã‹ã—ã¾ã æƒ…å ±ãŒè¶³ã‚Šãªã„ã€‚<br>
      ç¶šã„ã¦<b>ã€Œäºˆè¨€ Î³ã€</b>ã‚‚èª¿ã¹ã¦ãŠã“ã†ã€‚`;
      break;

    case 15:
      txt.innerHTML = `å…¥åŠ›æ•°å­—ã¯<b>ã€Œ1 - 1 - 2ã€</b>ã®ã¾ã¾ã§ã„ã„ã€‚<br>
      <b>ã€Œäºˆè¨€ Î³ã€</b>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦åå¿œã‚’è¦‹ã‚‹ã‚“ã ã€‚`;
      const s2 = document.getElementById('stone-2');
      if(s2) s2.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none'; 
      break;

    case 16:
      const logGamma = `
        <div class="log-entry log-false" style="margin-top:10px; text-align:left;">
          <div style="width:100%;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:bold;">R2 äºˆè¨€Î³</span> <strong>FALSE</strong>
            </div>
            <div style="font-size:0.85rem; margin:4px 0; color:#ddd; padding-left:8px; border-left:2px solid rgba(255,255,255,0.2);">
              ${colorize("é¢¨ã¨5ã®é–¢ä¿‚ (<, = )")}
            </div>
            <div style="text-align:right;"><span class="log-nums">1-1-2</span></div>
          </div>
        </div>`;
      txt.innerHTML = `çµæœã¯â€¦<br>${logGamma}<br>
      <b>FALSE</b>ã ï¼<br>
      å…¥åŠ›ã—ãŸ${cWind}(2)ã§ã¯ãƒ€ãƒ¡ã ã¨è¨€ã£ã¦ã„ã‚‹ã€‚<br>
      ã¤ã¾ã‚Šã€æ­£è§£ã®${cWind}ã¯<b>ã€Œ5ã€</b>ã§ç¢ºå®šã™ã‚‹ï¼`;
      document.getElementById('log-container').classList.add('tut-highlight');
      break;

    // â˜…è¿½åŠ : çŸ³ç¢‘Î´ã®ãƒ•ãƒ­ãƒ¼
    case 17:
      txt.innerHTML = `ã¾ã çµ‚ã‚ã‚Šã§ã¯ãªã„ã€‚æœ€å¾Œã®çŸ³ç¢‘ãŒã‚ã‚‹ã€‚<br>
      <b>ã€Œäºˆè¨€ Î´ã€</b>ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€å¶æ•°ã«é–¢ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã‚ˆã†ã€‚`;
      break;

    case 18:
      txt.innerHTML = `<b>ã€Œäºˆè¨€ Î´ã€</b>ã‚’ã‚¿ãƒƒãƒ—ã›ã‚ˆã€‚<br>
      å…¥åŠ›ã¯ã¾ã ã€Œ1 - 1 - 2ã€ã®ã¾ã¾ã ã€‚`;
      const s3 = document.getElementById('stone-3');
      if(s3) s3.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none';
      break;

    case 19:
      const logDelta = `
        <div class="log-entry log-false" style="margin-top:10px; text-align:left;">
          <div style="width:100%;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:bold;">R2 äºˆè¨€Î´</span> <strong>FALSE</strong>
            </div>
            <div style="font-size:0.85rem; margin:4px 0; color:#ddd; padding-left:8px; border-left:2px solid rgba(255,255,255,0.2);">
              ${colorize("å¶æ•°ã®æ•° (0, 1, 2)")}
            </div>
            <div style="text-align:right;"><span class="log-nums">1-1-2</span></div>
          </div>
        </div>`;
      txt.innerHTML = `çµæœã¯â€¦<br>${logDelta}<br>
      ã¾ãŸã—ã¦ã‚‚<b>FALSE</b>ã€‚<br>
      ã€Œ1-1-2ã€ã«ã¯å¶æ•°ãŒ1å€‹ã—ã‹ãªã„ã€‚ã“ã‚ŒãŒé–“é•ã„ãªã‚‰ã€æ­£è§£ã«ã¯<b>ã€Œå¶æ•°ãŒ2å€‹ã€</b>å«ã¾ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã ï¼`;
      document.getElementById('log-container').classList.add('tut-highlight');
      break;

    case 20:
      txt.innerHTML = `ã“ã‚Œã§ã™ã¹ã¦ã®æ¡ä»¶ãŒæƒã£ãŸã€‚<br>
      <ul style="font-size:0.85rem; padding-left:20px; color:#ddd; text-align:left;">
        <li>äºˆè¨€Î±: ${cFire} = ${cWater}</li>
        <li>äºˆè¨€Î²: åˆè¨ˆ â‰§ 10</li>
        <li>äºˆè¨€Î³: ${cWind} = 5</li>
        <li>äºˆè¨€Î´: å¶æ•°ãŒ2å€‹</li>
      </ul>
      é¢¨ã¯5(å¥‡æ•°)ã§ç¢ºå®šã€‚æ®‹ã‚Š2ã¤ã¯å¶æ•°ã§ã€åˆè¨ˆ10ä»¥ä¸Šâ€¦<br>
      ã“ã®æ¡ä»¶ã‚’æº€ãŸã™è§£ã¯ä¸€ã¤ã—ã‹ãªã„ï¼`;
      break;

    case 21:
      txt.innerHTML = `å°ãå‡ºã—ãŸç­”ãˆã€<b>ã€Œ4 - 4 - 5ã€</b>ã‚’å…¥åŠ›ã›ã‚ˆï¼<br>
      (åˆè¨ˆ13ã€é¢¨ã¯5ã€å¶æ•°ã¯4ã¨4ã®2å€‹ã€‚å®Œç’§ã )<br>
      â€»ä»Šå›ã¯ç‰¹åˆ¥ã«æ•°å­—ã‚’æ›¸ãæ›ãˆã¦ã‚ã’ã‚ˆã†ã€‚`;
      const runeBox3 = document.querySelector('.rune-container');
      if(runeBox3) runeBox3.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none';
      setTimeout(() => {
        if (typeof typeNumber !== 'function') {
           document.getElementById('r1').value = 4; document.getElementById('r2').value = 4; document.getElementById('r3').value = 5;
           btn.style.display = 'block'; btn.innerText = "OK"; return;
        }
        typeNumber(4, 4, 5, () => {
             btn.style.display = 'block'; btn.innerText = "OK";
        });
      }, 500);
      break;

    case 22:
      txt.innerHTML = `ã“ã‚ŒãŒæ­£è§£ãªã‚‰ã€ã™ã¹ã¦ã®çŸ³ç¢‘ãŒ <b>TRUE</b> ã«ãªã‚‹ã¯ãšã ã€‚<br>
      æœ€å¾Œã«<b>ã€Œå°å°è§£é™¤ã€</b>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ç­”ãˆåˆã‚ã›ã‚’ã—ã‚ˆã†ï¼`;
      const solveBtn = document.querySelector('.btn-solve');
      if(solveBtn) solveBtn.classList.add('tut-highlight', 'tut-blink');
      btn.style.display = 'none'; 
      break;
  }
}


// â–¼â–¼â–¼ ã“ã®éƒ¨åˆ†ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ â–¼â–¼â–¼

// ã‚¬ã‚¤ãƒ‰ã‚’é–‰ã˜ã‚‹
function closeHelp() {
  document.getElementById('help-modal').style.display = 'none';
}

function closeHistory() {
  document.getElementById('history-modal').style.display = 'none';
  // é–‰ã˜ãŸã¨ãã«ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒœã‚¿ãƒ³ã‚’å¾©æ´»ã•ã›ã‚‹
  const tutBtn = document.getElementById('top-tut-btn');
  if(tutBtn) tutBtn.style.display = 'flex';
}

// --- IDå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
function showInputId() {
  // iPhoneå¯¾ç­–: éš ã™
  const tutBtn = document.getElementById('top-tut-btn');
  if(tutBtn) tutBtn.style.display = 'none';
  
  document.getElementById('id-modal').style.display = 'flex';
}

function closeIdModal() {
  document.getElementById('id-modal').style.display = 'none';
  // å¾©æ´»ã•ã›ã‚‹
  const tutBtn = document.getElementById('top-tut-btn');
  if(tutBtn) tutBtn.style.display = 'flex';
}

// --- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ  (å°å°è§£é™¤ã®æ¼”å‡ºç”¨) â–¼â–¼â–¼ ---

// 1. ç¢ºèªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
function closeConfirm() {
  document.getElementById('confirm-modal').style.display = 'none';
  
  // â–¼â–¼â–¼ ã€Œå†è€ƒã™ã‚‹ã€ã®å ´åˆã®ã¿ãƒªã‚¹ãƒˆã‚’å¾©æ´»ã•ã›ã‚‹ â–¼â–¼â–¼
  if (state.isOmega) {
    const omegaArea = document.getElementById('omega-rule-area');
    if (omegaArea) {
      omegaArea.style.display = 'block';
      // renderPropheciesã§fallingã‚¯ãƒ©ã‚¹ã‚’æ¶ˆã—ã¦ã„ã‚‹ã®ã§ã€
      // ã“ã“ã§blockã«ã—ã¦ã‚‚å†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã—ã¾ã›ã‚“ã€‚
    }
  }
}


// 2. æ¼”å‡ºã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰çµæœç”»é¢ã¸ (Î©å¯¾å¿œç‰ˆ)
// 2. æ¼”å‡ºã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰çµæœç”»é¢ã¸ (ä¿®æ­£ç‰ˆ)
function executeUnlock() {
  // â–¼â–¼â–¼ ä¿®æ­£: closeConfirm() ã‚’å‘¼ã°ãšã«ã€æ‰‹å‹•ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã ã‘é–‰ã˜ã‚‹ â–¼â–¼â–¼
  // closeConfirmã‚’å‘¼ã¶ã¨Omegaãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã€ãã‚Œã‚’é˜²ãã¾ã™ã€‚
  document.getElementById('confirm-modal').style.display = 'none';
  // â–²â–²â–²â–²â–²â–²

  const animModal = document.getElementById('gate-anim-modal');
  const gateObj = document.getElementById('gate-circle');
  const gateInner = document.querySelector('.gate-inner'); 
  
  animModal.style.display = 'flex';
  animModal.classList.add('gate-anim-running');
  
  // åå­—ç·šã®è‰²åˆ‡ã‚Šæ›¿ãˆ
  const lightningSvg = document.querySelector('.lightning-svg');
  if (state.isOmega) {
    lightningSvg.classList.add('omega-mode'); 
  } else {
    lightningSvg.classList.remove('omega-mode'); 
  }

  // ãƒªã‚»ãƒƒãƒˆ
  gateObj.classList.remove('gate-active');
  gateObj.classList.remove('gate-active-omega'); 
  gateObj.classList.remove('gate-stone-omega');  
  gateInner.classList.remove('gate-inner-omega');

  void gateObj.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ†å²
  let animTime = 2300; 

  if (state.isOmega) {
    // Î©ãƒ¢ãƒ¼ãƒ‰
    gateObj.classList.add('gate-stone-omega');
    gateInner.classList.add('gate-inner-omega');
    gateObj.classList.add('gate-active-omega'); 
    animTime = 3800; 
  } else {
    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
    gateObj.classList.add('gate-active');
  }

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œ
  setTimeout(() => {
    animModal.style.display = 'none';
    animModal.classList.remove('gate-anim-running');
    gateObj.classList.remove('gate-active');
    gateObj.classList.remove('gate-active-omega'); 
    
    // åˆ¤å®š
    const i = +document.getElementById('r1').value;
    const a = +document.getElementById('r2').value;
    const v = +document.getElementById('r3').value;
    const isCorrect = (i === state.ans.i && a === state.ans.a && v === state.ans.v);
    
    finishGame(isCorrect);
    
  }, animTime); 
}

// --- äºˆè¨€ãƒªã‚¹ãƒˆã®é–‹é–‰ ---
function showProphecyList() {
  document.getElementById('prophecy-list-modal').style.display = 'flex';
}
function closeProphecyList() {
  document.getElementById('prophecy-list-modal').style.display = 'none';
}

// ã‚²ãƒ¼ãƒ ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã›ãšã«åˆæœŸåŒ–ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã™é–¢æ•°
function softResetGame() {
  // 1. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚„æ¼”å‡ºã‚’æ¶ˆã™
  document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
  const frame = document.querySelector('.divine-frame');
  if(frame) frame.remove();
  
   // â–¼â–¼â–¼ è¿½åŠ ä¿®æ­£: ãƒã‚°â‘¡ èƒŒæ™¯è‰²ã‚’ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ï¼ˆCSSã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã«æˆ»ã™ â–¼â–¼â–¼
  document.body.style.backgroundImage = ""; 
  // â–²â–²â–²â–²â–²â–²

  // 2. ç”»é¢åˆ‡ã‚Šæ›¿ãˆï¼ˆã‚²ãƒ¼ãƒ ç”»é¢ã‚’éš ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’å‡ºã™ï¼‰
  document.getElementById('game-screen').style.display = 'none';
  document.getElementById('title-screen').style.display = 'flex'; 
  
  // â–¼â–¼â–¼ ã“ã‚Œã‚’è¿½åŠ ï¼(ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã£ãŸã‚‰è¡¨ç¤º) â–¼â–¼â–¼
  const tutBtn = document.getElementById('top-tut-btn');
  if(tutBtn) tutBtn.style.display = 'flex';
  // â–²â–²â–²â–²â–²â–²
  
  // â–¼â–¼â–¼ â˜…è¿½åŠ ä¿®æ­£: ã“ã“ã§ã€Œè­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã‚’ç¢ºå®Ÿã«æ¶ˆã™ï¼ â–¼â–¼â–¼
  const lockMsg = document.getElementById('rune-lock-msg');
  if(lockMsg) lockMsg.style.display = 'none';
  // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

  // 3. ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('r1').value = '';
  document.getElementById('r2').value = '';
  document.getElementById('r3').value = '';
  document.getElementById('r1').disabled = false;
  document.getElementById('r2').disabled = false;
  document.getElementById('r3').disabled = false;
  
  document.getElementById('log-container').innerHTML = '';
  document.getElementById('prophecy-container').innerHTML = '';
  // â–¼â–¼â–¼ ä¿®æ­£: ä¸­èº«ã ã‘ã§ãªãã€æ ã”ã¨æ¶ˆã—å»ã‚‹ï¼ â–¼â–¼â–¼
  const omegaList = document.getElementById('omega-list');
  if(omegaList) omegaList.innerHTML = ''; 
  
  // â˜…ã“ã‚Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„
  const omegaArea = document.getElementById('omega-rule-area');
  if(omegaArea) omegaArea.style.display = 'none';
  
  initMatrix(); 
  const memoPad = document.getElementById('memo-pad');
  if(memoPad) memoPad.classList.add('closed');

  // ã‚«ã‚ªã‚¹è­¦å‘Šã®ãƒªã‚»ãƒƒãƒˆ
  const chaosWarn = document.getElementById('chaos-warning');
  if(chaosWarn) {
    chaosWarn.style.display = 'none';
    chaosWarn.classList.remove('visible');
  }

  // â–¼â–¼â–¼ â˜…è¿½åŠ : Nightmareè­¦å‘Šã®ãƒªã‚»ãƒƒãƒˆ â–¼â–¼â–¼
  const nmWarn = document.getElementById('nightmare-warning');
  if(nmWarn) {
    nmWarn.style.display = 'none';
    nmWarn.classList.remove('visible');
  }
}


// MENUãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
function openMenuModal() {
  document.getElementById('menu-modal').style.display = 'flex';
}

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’æŠ¼ã—ãŸã¨ã
function closeMenuModal() {
  document.getElementById('menu-modal').style.display = 'none';
}

// çµ‚äº†ã™ã‚‹ã‚’æŠ¼ã—ãŸã¨ãï¼ˆã•ã£ãä½œã£ãŸãƒªã‚»ãƒƒãƒˆé–¢æ•°ã‚’å†åˆ©ç”¨ï¼ï¼‰
function executeBackToTitle() {
  closeMenuModal();
  softResetGame(); // ã‚¹ãƒ†ãƒƒãƒ—2ã§ä½œã£ãŸé–¢æ•°ã‚’å‘¼ã³å‡ºã™ã ã‘ã§OK
}

// â˜…æ–°è¦: ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ä¸­æ–­ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
function quitTutorial() {
  isTutorialMode = false;
  
  // æ¼”å‡ºç”¨ã‚¯ãƒ©ã‚¹ã®é™¤å»
  document.querySelectorAll('.tut-highlight').forEach(e => e.classList.remove('tut-highlight'));
  document.querySelectorAll('.tut-blink').forEach(e => e.classList.remove('tut-blink'));
  
  // BOXã‚’éš ã™
  const tutBox = document.getElementById('tut-box');
  if(tutBox) {
    tutBox.style.display = 'none';
    tutBox.classList.remove('tut-embedded-mode');
    document.body.appendChild(tutBox); // DOMä½ç½®ãƒªã‚»ãƒƒãƒˆ
  }
  document.getElementById('tut-overlay').style.display = 'none';
  
  // UIã®å¾©å…ƒ
  const matrix = document.getElementById('logic-matrix');
  if(matrix) matrix.style.display = '';
  const memoBtn = document.querySelector('.memo-toggle-btn');
  if(memoBtn) memoBtn.style.display = '';
  const memoPad = document.getElementById('memo-pad');
  if(memoPad) memoPad.style.display = '';
  const runeContainer = document.querySelector('.rune-container');
  if(runeContainer) {
      const matrixLabel = runeContainer.nextElementSibling;
      if(matrixLabel) matrixLabel.style.display = '';
  }

  // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸
  softResetGame();
}


</script>
<div id="confirm-modal" class="modal-overlay">
  <div style="background:#111; padding:25px; border:1px solid #d4af37; border-radius:10px; width:85%; max-width:350px; text-align:center; box-shadow:0 0 30px rgba(212, 175, 55, 0.2);">
    <h3 style="color:#ccc; margin-top:0; font-size:1rem;">å°å°ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
    
    <div style="font-family:'Cinzel', serif; font-size:2.5rem; color:#d4af37; margin:15px 0; letter-spacing:5px; font-weight:bold; text-shadow:0 0 10px rgba(212, 175, 55, 0.5);">
      <span id="confirm-nums">???</span>
    </div>
    
    <div style="font-size:0.8rem; color:#888; margin-bottom:20px;">
      ä¸€åº¦è§£é™¤ã™ã‚‹ã¨ã€ã‚„ã‚Šç›´ã—ã¯ã§ãã¾ã›ã‚“ã€‚<br>
      ã“ã®ã‚³ãƒ¼ãƒ‰ã§ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ
    </div>

    <div style="display:flex; gap:10px;">
      <button class="btn btn-std" style="border-color:#555; color:#aaa;" onclick="closeConfirm()">å†è€ƒã™ã‚‹</button>
      <button class="btn btn-std" style="background:#d4af37; color:#000; border-color:#fff; font-weight:bold;" onclick="executeUnlock()">è§£é™¤ï¼ï¼</button>
    </div>
  </div>
</div>

<div id="gate-anim-modal" class="modal-overlay" style="background:#000; z-index:11000;">
  
  <svg class="lightning-svg" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
  <defs>
    <filter id="glow-gold" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="0.5" result="blur1" />
      <feMerge>
        <feMergeNode in="blur1" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
  </defs>
  
  <g class="cross-line-group">
    <path class="lightning-path main" d="M50,50 L50,0 M50,50 L50,100 M50,50 L0,50 M50,50 L100,50" />
    <path class="lightning-path sub" d="M50,50 L20,20 M50,50 L80,20 M50,50 L20,80 M50,50 L80,80" />
    <path class="lightning-path sub" d="M50,50 L40,10 L50,50 L90,40 L50,50 L60,90 L50,50 L10,60" />
  </g>
</svg>

  <div id="gate-circle" class="gate-stone">
    <div class="gate-inner">Î©</div>
  </div>
</div>

<div id="menu-modal" class="modal-overlay">
  <div style="background:#111; padding:25px; border:1px solid #555; border-radius:10px; width:85%; max-width:300px; text-align:center; box-shadow:0 0 20px rgba(0,0,0,0.8);">
    <h3 style="color:#fff; margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">MENU</h3>
    <div style="color:#ccc; margin:20px 0; font-size:0.95rem;">
      ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ<br>
      <span style="font-size:0.8rem; color:#888;">(é€²è¡ŒçŠ¶æ³ã¯å¤±ã‚ã‚Œã¾ã™)</span>
    </div>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button class="btn btn-std" style="flex:1; padding:10px; border-color:#777; color:#ccc;" onclick="closeMenuModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-std" style="flex:1; padding:10px; border-color:#e74c3c; color:#e74c3c; font-weight:bold;" onclick="executeBackToTitle()">çµ‚äº†ã™ã‚‹</button>
    </div>
  </div>
</div>


<div id="prophecy-list-modal" class="modal-overlay">
  <div id="prophecy-list-content">
    <div class="close-help" onclick="closeProphecyList()">Ã—</div>
    <h3 style="color:#d4af37; margin-top:0; border-bottom:1px solid #333; padding-bottom:10px; text-align:center;">äºˆè¨€ã®è§£èª­æ›¸</h3>
    
    <div class="p-cat-title" style="color:#ff9999;">â–  åŸºæœ¬ãƒ»æ¯”è¼ƒ</div>
    
    <div class="p-item">
      <strong>[å±æ€§]ã¨[æ•°å­—]ã®é–¢ä¿‚ ( <, =, > )</strong><br>
      ä¾‹: ã€Œç‚ã¨3ã®é–¢ä¿‚ã€ãªã©ã€‚<br>
      ãã®ãƒ«ãƒ¼ãƒ³ãŒæŒ‡å®šã•ã‚ŒãŸæ•°å­—ã‚ˆã‚Šå¤§ãã„ã‹å°ã•ã„ã‹ åŒä¸€ã‹ã€‚<br>
      <span class="p-ex">åˆ¤å®š: ç‚ãŒ4ã§TRUEãªã‚‰ã€Œç‚ > 3ã€</span>
    </div>

    <div class="p-item">
      <strong>[å±æ€§]ã¨[å±æ€§]ã®æ¯”è¼ƒ ( <, =, > )</strong><br>
      ä¾‹: ã€Œç‚ã¨æ°´ã®æ¯”è¼ƒã€ãªã©ã€‚<br>
      2ã¤ã®ãƒ«ãƒ¼ãƒ³ã®å¤§ãã•ã‚’æ¯”ã¹ã‚‹ã€‚<br>
      <span class="p-ex">åˆ¤å®š: ç‚4ãƒ»æ°´2ã§TRUEãªã‚‰ã€Œç‚ > æ°´ã€</span>
    </div>

    <div class="p-item">
      <strong>é †åºã®æ³•å‰‡ (æ˜‡é †, é™é †, é †ä¸åŒ)</strong><br>
      3ã¤ã®æ•°å­—ã®ä¸¦ã³æ–¹ã€‚<br>
      <span class="p-ex">
        æ˜‡é †: 1-2-5 (å¢—ãˆã¦ã„ã)<br>
        é™é †: 5-3-2 (æ¸›ã£ã¦ã„ã)<br>
        é †ä¸åŒ: 1-5-5 (ãƒãƒ©ãƒãƒ©)
      </span>
    </div>

    <div class="p-item">
      <strong>æœ€å¤§å€¤ã®æ‰€åœ¨ (â‰§) / æœ€å°å€¤ã®æ‰€åœ¨ (â‰¦)</strong><br>
      èª°ãŒä¸€ç•ªå¤§ãã„(ã¾ãŸã¯å°ã•ã„)ã‹ã€‚<br>
      <span class="p-ex">åˆ¤å®š: 5-2-2ã§TRUEãªã‚‰ã€Œç‚ãŒæœ€å¤§ã€</span>
    </div>


    <div class="p-cat-title" style="color:#99ccff;">â–  æ•°å­¦ãƒ»åˆè¨ˆ</div>

    <div class="p-item">
      <strong>[å±æ€§]ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)</strong><br>
      ãã®æ•°å­—ãŒ2ã§å‰²ã‚Šåˆ‡ã‚Œã‚‹ã‹ã©ã†ã‹ã€‚<br>
      <span class="p-ex">åˆ¤å®š: ç‚ãŒ4ã§TRUEãªã‚‰ã€Œç‚=å¶æ•°ã€</span>
    </div>

    <div class="p-item">
      <strong>åˆè¨ˆã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)</strong><br>
      3ã¤ã®åˆè¨ˆå€¤ãŒå¶æ•°ã‹å¥‡æ•°ã‹ã€‚<br>
      <span class="p-ex">åˆ¤å®š: 1+2+4=7 ã§TRUEãªã‚‰ã€Œåˆè¨ˆã¯å¥‡æ•°ã€</span>
    </div>

    <div class="p-item">
      <strong>åˆè¨ˆã¨[æ•°å­—]ã®é–¢ä¿‚ ( <, â‰§ )</strong><br>
      ä¾‹: ã€Œåˆè¨ˆã¨10ã®é–¢ä¿‚ã€ãªã©ã€‚<br>
      3ã¤ã®åˆè¨ˆãŒåŸºæº–(6ã‚„10)ã‚ˆã‚Šå¤§ãã„ã‹å°ã•ã„ã‹ã€‚<br>
      <span class="p-ex">åˆ¤å®š: åˆè¨ˆ11ã§TRUEãªã‚‰ã€Œåˆè¨ˆ â‰§ 10ã€</span>
    </div>

    <div class="p-item">
      <strong>åˆè¨ˆãŒç‰¹å®šã®å€æ•°(2, 3, 5)</strong><br>
      åˆè¨ˆå€¤ãŒãã®æ•°ã§å‰²ã‚Šåˆ‡ã‚Œã‚‹ã‹ã€‚<br>
      <span class="p-ex">åˆ¤å®š: åˆè¨ˆ10ã§TRUEãªã‚‰ã€Œ5ã®å€æ•°ã€ã€Œ2ã®å€æ•°ã€</span>
    </div>
    
    <div class="p-item">
      <strong>[å±æ€§]+[å±æ€§]ã¨5ã®é–¢ä¿‚ ( <, =, > )</strong><br>
      ä¾‹: ã€Œç‚+æ°´ã¨5ã®é–¢ä¿‚ã€ãªã©ã€‚<br>
      æŒ‡å®šã•ã‚ŒãŸ2ã¤ã®å’ŒãŒ5ã‚ˆã‚Šå¤§ãã„ã‹å°ã•ã„ã‹ã€‚<br>
      <span class="p-ex">åˆ¤å®š: 3+3=6ã§TRUEãªã‚‰ã€Œç‚+æ°´ > 5ã€</span>
    </div>

    <div class="p-item">
      <strong>åˆè¨ˆå€¤ãŒç´ æ•°ã‹ã©ã†ã‹</strong><br>
      åˆè¨ˆãŒ 3, 5, 7, 11, 13 ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã€‚<br>
      <span class="p-ex">åˆ¤å®š: åˆè¨ˆ5ã§TRUEãªã‚‰ã€Œåˆè¨ˆã¯ç´ æ•°ã€</span>
    </div>

    <div class="p-item">
      <strong>ç´ æ•°ã®æœ‰ç„¡ (ã‚ã‚Š, ãªã—)</strong><br>
      æ•°å­—ã®ä¸­ã«ç´ æ•°(2, 3, 5)ãŒ1ã¤ã§ã‚‚å«ã¾ã‚Œã‚‹ã‹ã€‚<br>
      <span class="p-ex">åˆ¤å®š: 1-1-4 (ãªã—) / 1-1-2 (ã‚ã‚Š)</span>
    </div>


    <div class="p-cat-title" style="color:#99ffcc;">â–  æ§‹é€ ãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³</div>

    <div class="p-item">
      <strong>[æ•°å­—]ã®æ•° (0, 1, 2, 3)</strong><br>
      ä¾‹: ã€Œå¶æ•°ã®æ•°ã€ã€Œ1ã®æ•°ã€ãªã©ã€‚<br>
      æ¡ä»¶ã«åˆã†æ•°å­—ãŒã„ãã¤ã‚ã‚‹ã‹ã€‚<br>
      <span class="p-ex">åˆ¤å®š: 2-3-5 ã§TRUEãªã‚‰ã€Œå¶æ•°ãŒ1å€‹ã€</span>
    </div>

    <div class="p-item">
      <strong>éš£æ¥ã™ã‚‹é€£ç•ªã®æ•°(0 , 1 , 2)</strong><br>
      éš£ã‚Šåˆã†æ•°å­—ã®å·®ãŒã€Œ1ã€ã§ã‚ã‚‹ç®‡æ‰€ã®æ•°ã€‚<br>
      <span class="p-ex">
        4-5-1 (4ã¨5) â†’ 1ç®‡æ‰€<br>
        1-2-3 (1ã¨2, 2ã¨3) â†’ 2ç®‡æ‰€<br>
        1-3-5 (ç¹‹ãŒã‚Šãªã—) â†’ 0ç®‡æ‰€
      </span>
    </div>

    <div class="p-item">
      <strong>2ã¤ã®åŒã˜æ•°å­— (ãªã—, 1çµ„)</strong><br>
      ãƒšã‚¢ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ (ãƒ¯ãƒ³ãƒšã‚¢)ã€‚<br>
      <span class="p-ex">åˆ¤å®š: 2-2-5 (1çµ„) / 1-2-3 (ãªã—)<br>
 â€»1çµ„ã®å ´åˆ2-2-2ã‚’å…¥ã‚Œã¦ã‚‚TRUEã‚’è¿”ã—ã¾ã™ã€‚</span>
    </div>

    <div class="p-item">
      <strong>æœ€å¤§ã¨æœ€å°ã®å·®(0 ,1 ,2 ,3 ,4)</strong><br>
      ä¸€ç•ªå¤§ãã„æ•° - ä¸€ç•ªå°ã•ã„æ•°ã€‚<br>
      <span class="p-ex">åˆ¤å®š: 2-5-5ã§TRUEãªã‚‰ 5-2=3 ãªã®ã§ã€Œå·®ãŒ3ã€</span>
    </div>

    <button class="btn btn-std" onclick="closeProphecyList()" style="width:100%; margin-top:20px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="nightmare-slash" class="slash-effect">
  <div class="slash-line" style="top: 15%; left: -10%; width: 120%; height: 4px;"></div>
  <div class="slash-line" style="top: 25%; left: -10%; width: 120%; height: 2px;"></div>
</div>



</body>
</html>
