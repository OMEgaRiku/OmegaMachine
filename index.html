<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>OMEGA STONE</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-color: #050505;
    --text-main: #e0d0b0;
    --accent-color: #d4af37;
  }

  body {
    font-family: 'Shippori Mincho', serif;
    background-color: var(--bg-color);
    background-image: radial-gradient(circle at 50% 50%, #1a150e 0%, #000000 100%);
    color: var(--text-main);
    text-align: center;
    padding: 20px;
    margin: 0;
    min-height: 100vh;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    transition: background-image 1s ease;
  }
  .en-font { font-family: 'Cinzel', serif; }

  /* Title Screen */
  #title-screen {
    display: flex; flex-direction: column; justify-content: center; align-items: center; height: 90vh; animation: fadeIn 2s;
  }
  .game-title {
    font-family: 'Cinzel', serif; font-size: 2.5rem; font-weight: 900; letter-spacing: 3px;
    background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; color: transparent;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.3); margin-bottom: 5px;
  }

  /* Difficulty Buttons */
  .btn {
    background: rgba(0,0,0,0.5); border: 1px solid #777; color: #ccc; padding: 18px; margin: 8px;
    font-size: 1.1rem; font-family: 'Shippori Mincho', serif; font-weight: bold; cursor: pointer;
    width: 90%; max-width: 350px; position: relative; overflow: hidden; transition: 0.3s; border-radius: 8px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .btn:active { transform: scale(0.98); }
  
  .btn-std { border-color: #3498db; color: #aed6f1; box-shadow: 0 0 10px rgba(52, 152, 219, 0.2); }
  .btn-hard { border-color: #e74c3c; color: #f5b7b1; box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }
  .btn-night { border-color: #9b59b6; color: #d7bde2; box-shadow: 0 0 10px rgba(155, 89, 182, 0.2); }
  .btn-chaos { border-color: #95a5a6; color: #d0d0d0; box-shadow: 0 0 10px rgba(255, 255, 255, 0.1); border-style: dashed;}
  
  /* Omega Mode Styles */
  .btn-omega { 
    border-color: #fff; color: #fff; background: #000; 
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); font-family: 'Cinzel', serif;
  }

  /* Game Screen */
  #game-screen { display: none; max-width: 600px; margin: 0 auto; animation: slideIn 0.5s ease-out; }
  @keyframes slideIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

  .hud {
    display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.2);
    padding-bottom: 10px; margin-bottom: 20px; font-family: 'Cinzel', serif;
  }
  .hud-left { display: flex; gap: 8px; }
  .hud-btn { 
    cursor: pointer; font-size: 0.85rem; color: #aaa; border: 1px solid #555; 
    padding: 6px 12px; border-radius: 4px; background: rgba(0,0,0,0.6); 
    display: flex; align-items: center; justify-content: center;
  }
  .btn-guide { border-color: #d4af37; color: #f1c40f; font-weight: bold; }
  .mana-bar { font-size: 1.1rem; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }

  /* Rune Inputs */
  .rune-container {
    display: flex; justify-content: center; gap: 12px; margin-bottom: 20px;
    background: rgba(0,0,0,0.4); padding: 20px 10px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);
  }
  .rune-wrapper { position: relative; width: 80px; }
  .rune-label { position: absolute; top: -28px; left: 0; width: 100%; font-size: 0.8rem; font-weight: bold; }
  .rune-sub { font-size: 0.6rem; color: #888; display: block; margin-top: -2px; font-family: 'Cinzel', serif; }
  
  input.rune-input {
    width: 100%; height: 75px; font-size: 2.2rem; text-align: center; background: #0f0f0f;
    border: 2px solid #333; border-radius: 8px; color: #fff; font-family: 'Cinzel', serif; transition: 0.3s;
  }
  input:focus { outline: none; border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
  
  #r1 { border-color: #8a1c1c; color: #ff9999; } /* Ignis */
  #r2 { border-color: #1c4e8a; color: #99ccff; } /* Aqua */
  #r3 { border-color: #1c8a5e; color: #99ffcc; } /* Ventus */

  /* Logic Matrix */
  .logic-grid {
    display: grid; grid-template-columns: auto repeat(5, 1fr); gap: 4px;
    margin: 10px 0 10px 0; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
  }
  .grid-header { font-family: 'Cinzel', serif; font-weight: bold; color: #888; font-size: 0.8rem; padding-bottom: 5px;}
  .grid-row-label { text-align: right; padding-right: 10px; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; justify-content: flex-end;}
  
  .grid-cell {
    background: rgba(255,255,255,0.05); border: 1px solid #333; aspect-ratio: 1; border-radius: 4px;
    cursor: pointer; display: flex; justify-content: center; align-items: center;
    font-weight: bold; font-size: 1.2rem; user-select: none; transition: 0.1s;
  }
  
  /* Shared Cell Styles */
  .cell-x, .memo-btn.is-x { background: rgba(200, 50, 50, 0.2); color: #ff5555; border-color: #552222; }
  .cell-x::after, .memo-btn.is-x::after { content: "Ã—"; }
  
  .cell-o, .memo-btn.is-o { background: rgba(50, 200, 50, 0.2); color: #55ff55; border-color: #225522; }
  .cell-o::after, .memo-btn.is-o::after { content: "â—‹"; }

  /* Memo Toggle & Area */
  .memo-toggle-btn {
    width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #444; border-radius: 6px;
    color: #aaa; font-size: 0.8rem; cursor: pointer; margin-bottom: 5px; font-weight: bold; transition: 0.2s;
  }
  .memo-toggle-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

  .memo-area {
    background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 8px;
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out; overflow: hidden;
  }
  .memo-area.closed { display: none; }

  .memo-row { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
  .memo-label { width: 100%; font-size: 0.7rem; color: #888; margin-bottom: 2px; text-align: left; padding-left: 5px;}
  .memo-btn {
    border: 1px solid #444; background: #111; color: #ccc; padding: 6px 8px; border-radius: 4px;
    font-size: 0.75rem; cursor: pointer; min-width: 45px; display: flex; align-items: center; justify-content: center; gap: 3px; user-select: none;
  }
  .memo-btn::after { margin-left: 2px; font-weight: bold; }

  /* Prophecy List */
  .prophecy-list { display: flex; flex-direction: column; gap: 10px; }
  .stone {
    background: linear-gradient(to right, rgba(30,30,30,0.9), rgba(10,10,10,0.9));
    border: 1px solid #444; padding: 10px 15px;
    border-radius: 5px; cursor: pointer; text-align: left; transition: 0.2s;
    display: flex; justify-content: space-between; align-items: center; position: relative;
    backdrop-filter: blur(5px);
  }
  .stone:hover { border-color: #aaa; transform: translateX(5px); }
  .stone::after { content: ''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: #666; }
  .stone.disabled { opacity: 0.4; pointer-events: none; }
  .stone-title { font-size: 0.75rem; color: #888; margin-bottom: 2px; }
  .stone-text { font-size: 1rem; color: #fff; font-weight: bold; letter-spacing: 0.5px; }
  .stone-id { font-family: 'Cinzel', serif; font-size: 1.4rem; color: #444; margin-left: 10px;}
  
  /* Mystery Stone (Omega) */
  .stone.is-mystery {
    color: #fff; background: #000; border: 1px solid #555;
    display: flex; justify-content: center; align-items: center;
  }
  .stone.is-mystery .stone-title { display: none; }
  .stone.is-mystery .stone-text { 
    font-family: 'Cinzel', serif; font-size: 1.5rem; letter-spacing: 5px; color: #888; 
  }

  /* Log */
  .log-area {
    margin-top: 20px; border-top: 1px solid #444; padding-top: 10px; max-height: 200px; overflow-y: auto; text-align: left; font-size: 0.9rem;
  }
  .log-entry { margin-bottom: 5px; padding: 8px 10px; border-radius: 4px; background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
  .log-true { border-left: 3px solid #2ecc71; color: #aaffaa; }
  .log-false { border-left: 3px solid #e74c3c; color: #ffaaaa; }
  .log-nums { font-family: 'Cinzel', serif; font-weight: bold; background: #000; padding: 1px 6px; border-radius: 3px; letter-spacing: 1px; font-size: 0.8rem;}

  /* Action Bar */
  .action-bar { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
  .btn-action { flex: 1; padding: 15px; font-weight: bold; font-family: 'Shippori Mincho', serif; border: none; cursor: pointer; border-radius: 8px; font-size: 1rem; color: #fff; transition: 0.2s; }
  .btn-next { background: #333; border: 1px solid #555; }
  .btn-solve { background: #27ae60; box-shadow: 0 4px 0 #1e8449; }

  /* Chaos Bar */
  .chaos-bar { background: #c0392b; color: white; padding: 5px; font-size: 0.8rem; font-weight: bold; margin-bottom: 15px; border-radius: 4px; display: none; text-shadow: 0 0 5px #000; letter-spacing: 2px;}

  /* Modals */
  .modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; justify-content: center; align-items: center;
    backdrop-filter: blur(5px);
  }
  .seal-broken { font-size: 2.5rem; color: #fff; text-shadow: 0 0 30px #fff; font-weight: bold; }
  .answer-reveal { font-size: 4rem; letter-spacing: 15px; margin: 20px; color: #fff; font-family: 'Cinzel', serif; }

  /* Help & History Styles */
  #help-content, #history-content {
    background: #111; border: 1px solid #444; padding: 20px; border-radius: 10px; width: 85%; max-width: 500px;
    max-height: 80vh; overflow-y: auto; text-align: left; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.8);
  }
  .help-section { margin-bottom: 25px; border-bottom: 1px dashed #333; padding-bottom: 15px; }
  .help-title { color: #d4af37; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;}
  .help-text { font-size: 0.9rem; line-height: 1.6; color: #ccc; }
  .close-help { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #888; padding: 5px;}
  
  .diagram-box {
    background: #222; border: 1px solid #444; padding: 15px; border-radius: 6px; margin: 10px 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .d-stone {
    width: 90%; background: #333; border-left: 3px solid #666; padding: 8px; margin: 5px 0; color: #fff; font-size: 0.8rem; display: flex; justify-content: space-between;
  }
  .d-arrow { font-size: 1.5rem; color: #d4af37; margin: 5px 0; }
  .d-result { font-weight: bold; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
  .d-true { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
  .d-false { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
  
  /* Liar Styles */
  .stone.is-liar {
    border: 2px solid #e74c3c;
    background: linear-gradient(to right, rgba(231, 76, 60, 0.2), rgba(0,0,0,0.8));
  }
  .stone.is-liar::after { background: #e74c3c; }
  .stone.is-liar .stone-title::after {
    content: " (å˜˜ã¤ã)"; color: #e74c3c; font-weight: bold; margin-left: 5px;
  }
  .res-row { font-size: 0.8rem; border-bottom: 1px solid #444; padding: 5px 0; color: #ccc; }
  .res-liar-txt { color: #e74c3c; font-weight:bold; }

  /* Omega Rule List */
  #omega-rule-area {
    margin-top: 15px; padding: 10px; border: 1px solid #444; border-radius: 8px;
    background: rgba(0,0,0,0.8); display: none; text-align: left;
  }
  .omega-label { color: #fff; font-size: 0.9rem; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; }
  .omega-list-item {
    padding: 6px; font-size: 0.85rem; color: #ccc; cursor: pointer; border-bottom: 1px dashed #333; transition: 0.2s;
  }
  .omega-list-item:hover { color: #fff; background: rgba(255,255,255,0.1); }
  .omega-list-item.excluded {
    text-decoration: line-through; color: #555; opacity: 0.6;
  }

  /* History List Styles */
  .hist-item {
    background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 10px;
    margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
  }
  .hist-left { text-align: left; }
  .hist-mode { font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; margin-right: 5px; font-weight: bold; }
  .mode-standard { background: #1c4e8a; color: #aed6f1; }
  .mode-hard { background: #8a1c1c; color: #f5b7b1; }
  .mode-nightmare { background: #4a1c8a; color: #d7bde2; }
  .mode-chaos { background: #555; color: #ccc; }
  .mode-omega { background: #000; color: #fff; border: 1px solid #fff; }

  .hist-id { font-family: 'Cinzel', serif; color: #d4af37; font-weight: bold; letter-spacing: 1px; }
  .hist-date { font-size: 0.7rem; color: #666; margin-top: 2px; }
  .hist-result { font-weight: bold; font-size: 0.9rem; }
  .res-win { color: #2ecc71; }
  .res-lose { color: #e74c3c; }

  .btn-replay {
    background: transparent; border: 1px solid #555; color: #aaa; cursor: pointer;
    padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; transition: 0.2s;
  }
  .btn-replay:hover { background: #333; color: #fff; border-color: #fff; }
  
  /* Tutorial Styles */
  .t-container { display: flex; flex-direction: column; gap: 15px; }
  .t-step { background: #1a1a1a; border: 1px solid #444; border-radius: 8px; padding: 15px; position: relative; text-align: left; }
  .t-step-num { background: var(--accent-color); color: #000; font-weight: bold; display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 8px; }
  .t-row { display: flex; align-items: center; justify-content: space-around; margin: 10px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; }
  .t-stone-mock { border: 1px solid #666; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; color: #ccc; background: #222; }
  .t-result-mock { font-weight: bold; font-family: 'Cinzel', serif; padding: 5px 10px; border-radius: 4px; }
  .t-res-true { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
  .t-res-false { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
  .t-logic-text { font-size: 0.9rem; line-height: 1.6; color: #ddd; margin-top: 5px; }
  .t-highlight { color: #ff9999; font-weight: bold; }
  .t-highlight-b { color: #99ccff; font-weight: bold; }
  .t-conclusion { border-top: 1px dashed #444; margin-top: 10px; padding-top: 10px; font-weight: bold; color: var(--accent-color); }

  #loading-indicator { font-size: 1.2rem; color: #d4af37; margin-top: 20px; display: none; }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

</style>
</head>
<body>
  <div id="title-screen">
    <div class="game-title">OMEGA STONE</div>
    <div style="color:#aaa; margin-bottom:40px; letter-spacing:2px; font-size:0.9rem;">Logical Deduction RPG</div>
    
    <div class="btn btn-std" onclick="startGame('standard')"><span>åŸºæœ¬ (Standard)</span><span class="en-font">I</span></div>
    <div class="btn btn-hard" onclick="startGame('hard')"><span>é«˜é›£åº¦ (Hard)</span><span class="en-font">II</span></div>
    <div class="btn btn-night" onclick="startGame('nightmare')"><span>æ‚ªå¤¢ (Nightmare)</span><span class="en-font">III</span></div>
    <div class="btn btn-chaos" onclick="startGame('chaos')"><span>æ··æ²Œ (Chaos)</span><span class="en-font">âˆ</span></div>
    <div class="btn btn-omega" onclick="startGame('omega')"><span>Î© (Omega)</span><span class="en-font">?</span></div>

    <div style="display:flex; gap:10px; width:90%; max-width:350px; margin-top:10px;">
      <div class="btn btn-std" style="font-size:0.9rem; padding:12px;" onclick="showHistory()">ğŸ“œ å±¥æ­´</div>
      <div class="btn btn-std" style="font-size:0.9rem; padding:12px; border-color:#aaa; color:#eee;" onclick="showInputId()">ğŸ”‘ IDå…¥åŠ›</div>
    </div>
    
    <div id="loading-indicator">ç”Ÿæˆä¸­...</div>
  </div>

  <div id="game-screen">
    <div class="hud">
      <div class="hud-left">
        <div class="hud-btn" onclick="location.reload()">MENU</div>
        <div class="hud-btn btn-guide" onclick="showHelp()">GUIDE ?</div>
        <div id="btn-show-result" class="hud-btn" style="display:none; border-color:#2ecc71; color:#2ecc71; font-weight:bold;" onclick="showResult()">â˜… RESULT</div>
      </div>
      <div class="mana-bar"><span style="font-size:0.8rem; color:#888;">MANA</span> <span id="ui-mana" class="en-font">0/3</span></div>
    </div>

    <div style="text-align:right; font-size:0.8rem; color:#aaa; margin-top:-15px; margin-bottom:15px; margin-right:5px;">ROUND <span id="ui-round" class="en-font" style="color:#fff; font-size:1.1rem;">1</span></div>

    <div id="chaos-warning" class="chaos-bar">âš  å½ã‚Šã®çŸ³ç¢‘ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ (ONE LIAR)</div>

    <div class="rune-container">
      <div class="rune-wrapper">
        <div class="rune-label" style="color:#ff9999">ç‚<span class="rune-sub">IGNIS</span></div>
        <input type="number" id="r1" class="rune-input" min="1" max="5" placeholder="-" onchange="limitInput(this)">
      </div>
      <div class="rune-wrapper">
        <div class="rune-label" style="color:#99ccff">æ°´<span class="rune-sub">AQUA</span></div>
        <input type="number" id="r2" class="rune-input" min="1" max="5" placeholder="-" onchange="limitInput(this)">
      </div>
      <div class="rune-wrapper">
        <div class="rune-label" style="color:#99ffcc">é¢¨<span class="rune-sub">VENTUS</span></div>
        <input type="number" id="r3" class="rune-input" min="1" max="5" placeholder="-" onchange="limitInput(this)">
      </div>
    </div>

    <div style="text-align:left; color:#666; font-size:0.7rem; margin-bottom:5px; margin-left:5px;">LOGIC MATRIX & MEMO</div>
    <div class="logic-grid" id="logic-matrix"></div>

    <button class="memo-toggle-btn" onclick="toggleMemoArea()">ğŸ“ MEMO PAD (Show/Hide)</button>
    
    <div class="memo-area closed" id="memo-pad">
      <div class="memo-label">åˆè¨ˆãƒ¡ãƒ¢</div>
      <div class="memo-row">
        <div class="memo-btn" onclick="toggleMemo(this)">å¶æ•°</div>
        <div class="memo-btn" onclick="toggleMemo(this)">å¥‡æ•°</div>
        <div class="memo-btn" onclick="toggleMemo(this)">&lt; 6</div>
        <div class="memo-btn" onclick="toggleMemo(this)">â‰§ 6</div>
        <div class="memo-btn" onclick="toggleMemo(this)">&lt; 10</div>
        <div class="memo-btn" onclick="toggleMemo(this)">â‰§ 10</div>
      </div>
      <div class="memo-label">å¤§å°ãƒ¡ãƒ¢ (å€¤ â‰§ ä»–)</div>
      <div class="memo-row">
        <div class="memo-btn" onclick="toggleMemo(this)">Max<span style="color:#ff9999">ç‚</span></div>
        <div class="memo-btn" onclick="toggleMemo(this)">Max<span style="color:#99ccff">æ°´</span></div>
        <div class="memo-btn" onclick="toggleMemo(this)">Max<span style="color:#99ffcc">é¢¨</span></div>
        <div class="memo-btn" onclick="toggleMemo(this)">Min<span style="color:#ff9999">ç‚</span></div>
        <div class="memo-btn" onclick="toggleMemo(this)">Min<span style="color:#99ccff">æ°´</span></div>
        <div class="memo-btn" onclick="toggleMemo(this)">Min<span style="color:#99ffcc">é¢¨</span></div>
      </div>
    </div>
    <div id="prophecy-container" class="prophecy-list"></div>

    <div id="omega-rule-area">
      <div class="omega-label">DETECTED LAWS (Search & Destroy)</div>
      <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">â€»ã‚¯ãƒªãƒƒã‚¯ã§å–ã‚Šæ¶ˆã—ç·š (ãƒ¡ãƒ¢)</div>
      <div id="omega-list"></div>
    </div>

    <div class="action-bar">
      <button class="btn-action btn-next" onclick="nextRound()">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸</button>
      <button class="btn-action btn-solve" onclick="attemptUnlock()">å°å°è§£é™¤</button>
    </div>

    <div id="log-container" class="log-area">
      <div style="color:#666; text-align:center; font-style:italic; font-size:0.8rem;">-- è§£æã®è¨˜éŒ² --</div>
    </div>
  </div>

  <div id="help-modal" class="modal-overlay">
    <div id="help-content">
      <div class="close-help" onclick="closeHelp()">Ã—</div>
      <h2 style="text-align:center; margin-top:0; color:#fff; border-bottom:1px solid #333; padding-bottom:15px;">éºè·¡è§£æã‚¬ã‚¤ãƒ‰</h2>
      <div class="help-section">
        <div class="help-title">1. ã“ã®ã‚²ãƒ¼ãƒ ã®ç›®çš„</div>
        <div class="help-text">
          ã‚ãªãŸã®ç›®çš„ã¯ã€3ã¤ã®ãƒ«ãƒ¼ãƒ³ï¼ˆ<span class="t-highlight">ç‚</span>ãƒ»<span class="t-highlight-b">æ°´</span>ãƒ»<span style="color:#99ffcc; font-weight:bold;">é¢¨</span>ï¼‰ã«è¨­å®šã•ã‚ŒãŸ<strong>ã€Œæ­£è§£ã®æ•°å­— (1ã€œ5)ã€</strong>ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã§ã™ã€‚<br><br>
          ã—ã‹ã—ã€ã„ããªã‚Šæ•°å­—ã‚’å½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚<br>
          ã¾ãšã¯çŸ³ç¢‘ã«è³ªå•ã‚’ã—ã¦<strong>ã€Œéš ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã€</strong>ã‚’æš´ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
        </div>
      </div>
      <div class="help-section">
        <div class="help-title">2. ä¾‹é¡Œã§ã‚ã‹ã‚‹ã€Œè§£æã€ã®æµã‚Œ</div>
        <div class="help-text" style="margin-bottom:15px;">
          ã‚ã‚‹çŸ³ç¢‘ã«<strong>ã€Œç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)ã€</strong>ã¨æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚<br>
          ã“ã‚Œã¯ã€ã€Œç‚ãŒå¤§ãã„ã€ã®ã‹ã€ŒåŒã˜ã€ãªã®ã‹ã€Œæ°´ãŒå¤§ãã„ã€ã®ã‹ã€<strong>ãƒ«ãƒ¼ãƒ«ãŒã¾ã ä¸æ˜</strong>ãªçŠ¶æ…‹ã§ã™ã€‚<br>
          ã“ã‚Œã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€æ•°å­—ã‚’å…¥åŠ›ã—ã¦çŸ³ç¢‘ã®åå¿œã‚’è¦‹ã¾ã™ã€‚
        </div>
        <div class="t-container">
          <div class="t-step">
            <div class="t-step-num">STEP 1 : è©¦ã—ã«å…¥åŠ›ã—ã¦ã¿ã‚‹</div>
            <div class="t-logic-text">
              ã‚ãªãŸã¯ã€Œç‚(4)ã€ã¨ã€Œæ°´(1)ã€ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚
            </div>
            <div class="t-row">
              <div style="text-align:center;">
                <span class="t-highlight">ç‚:4</span> <span class="t-arrow">></span> <span class="t-highlight-b">æ°´:1</span>
              </div>
            </div>
          </div>
          <div class="t-step">
            <div class="t-step-num">STEP 2 : çŸ³ç¢‘ã«å•ã†</div>
            <div class="t-logic-text">
              çŸ³ç¢‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åˆ¤å®šã—ã¾ã™ã€‚<br>
              ã‚‚ã—ã€çµæœãŒ <span class="t-result-mock t-res-true">TRUE</span> ã ã£ãŸã‚‰â€¦ï¼Ÿ
            </div>
            <div class="t-row">
              <div class="t-stone-mock">çŸ³ç¢‘: ç‚ã¨æ°´</div>
              <div class="t-arrow">â†’</div>
              <div class="t-result-mock t-res-true">TRUE (çœŸå®Ÿ)</div>
            </div>
            <div class="t-logic-text">
              çŸ³ç¢‘ã¯<strong>ã€ŒãŠå‰ã®å…¥åŠ›ã—ãŸã€ç‚ > æ°´ã€ã¨ã„ã†é–¢ä¿‚æ€§ã¯æ­£ã—ã„ãã€</strong>ã¨è¨€ã£ã¦ã„ã¾ã™ã€‚
            </div>
          </div>
          <div class="t-step" style="border-color: #d4af37;">
            <div class="t-step-num" style="background:#d4af37; color:#000;">STEP 3 : ãƒ«ãƒ¼ãƒ«ç¢ºå®šï¼</div>
            <div class="t-logic-text">
              å…¥åŠ›ã—ãŸé–¢ä¿‚æ€§(4>1)ãŒè‚¯å®šã•ã‚ŒãŸã®ã§ã€ã“ã®çŸ³ç¢‘ã®æ­£ä½“ã¯<strong>ã€Œç‚ > æ°´ã€ã®ãƒ«ãƒ¼ãƒ«</strong>ã ã¨ç¢ºå®šã—ã¾ã™ï¼
            </div>
            <div class="t-conclusion">
              â˜…æ¨ç†å®Œäº†<br>
              æ­£è§£ã®ã‚³ãƒ¼ãƒ‰ã‚‚å¿…ãšã€Œç‚ > æ°´ã€ã«ãªã£ã¦ã„ã¾ã™ã€‚<br>
              ã€Œç‚ãŒæ°´ã‚ˆã‚Šå°ã•ã„ã€çµ„ã¿åˆã‚ã›ã¯å…¨ã¦ä¸æ­£è§£ãªã®ã§ã€Ã—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚
            </div>
          </div>
        </div>
      </div>
      <button class="btn btn-std" style="width:100%; box-sizing:border-box;" onclick="closeHelp()">ç†è§£ã—ãŸ</button>
    </div>
  </div>

  <div id="result-modal" class="modal-overlay">
    <div class="seal-broken">å°å°è§£é™¤</div>
    <div style="color:#ccc; margin-top:10px;">çœŸå®Ÿã®ãƒ«ãƒ¼ãƒ³:</div>
    <div class="answer-reveal" id="final-code"></div>
    <div id="result-details" style="width:90%; max-width:400px; background:#222; padding:10px; border-radius:8px; margin-bottom:20px; text-align:left; max-height:30vh; overflow-y:auto; border:1px solid #444;"></div>
    <div style="color:#fff; margin-bottom:20px;">åˆ°é”ãƒ©ã‚¦ãƒ³ãƒ‰: <span id="final-round" class="en-font"></span></div>
    <div style="display:flex; gap:10px; width:90%; max-width:350px;">
      <button class="btn btn-std" style="justify-content:center; flex:1;" onclick="reviewBoard()">ç›¤é¢ã‚’è¦‹ã‚‹</button>
      <button class="btn btn-std" style="justify-content:center; flex:1; background:#d4af37; color:#000; border-color:#fff;" onclick="location.reload()">æ¬¡ã®éºè·¡ã¸</button>
    </div>
  </div>

  <div id="id-modal" class="modal-overlay">
    <div style="background:#111; padding:20px; border:1px solid #444; border-radius:10px; width:80%; max-width:300px;">
      <h3 style="color:#fff; margin-top:0;">çŸ³ç¢‘IDã‚’å…¥åŠ›</h3>
      <input type="text" id="input-seed" placeholder="ä¾‹: A1B2C" style="width:100%; padding:10px; font-size:1.2rem; text-align:center; margin-bottom:15px; background:#222; border:1px solid #555; color:#fff; font-family:'Cinzel', serif; text-transform:uppercase;">
      <div style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">é›£æ˜“åº¦ã‚’é¸æŠã—ã¦é–‹å§‹:</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
        <button class="btn btn-std" style="width:auto; padding:10px; font-size:0.8rem; margin:0;" onclick="startFromId('standard')">åŸºæœ¬</button>
        <button class="btn btn-hard" style="width:auto; padding:10px; font-size:0.8rem; margin:0;" onclick="startFromId('hard')">é«˜é›£åº¦</button>
        <button class="btn btn-night" style="width:auto; padding:10px; font-size:0.8rem; margin:0;" onclick="startFromId('nightmare')">æ‚ªå¤¢</button>
        <button class="btn btn-omega" style="width:auto; padding:10px; font-size:0.8rem; margin:0; border:1px solid #fff;" onclick="startFromId('omega')">Î©</button>
      </div>
      <button class="btn btn-std" style="margin-top:15px; width:100%; border-color:#555; color:#aaa;" onclick="closeIdModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="history-modal" class="modal-overlay">
    <div id="history-content">
      <div class="close-help" onclick="closeHistory()">Ã—</div>
      <h3 style="color:#fff; margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">æ¢æŸ»ã®è¨˜éŒ²</h3>
      <div id="history-list"></div>
    </div>
  </div>
<script>
// --- LOGIC ENGINE v7.1 (Fixed RNG & Full Features) ---

// é«˜æ€§èƒ½ä¹±æ•°ç”Ÿæˆå™¨ (Mulberry32)
// ã“ã‚Œã«ã‚ˆã‚Šã€IDã‹ã‚‰å¸¸ã«åŒã˜å•é¡ŒãŒç”Ÿæˆã•ã‚Œã€ã‹ã¤ç”Ÿæˆå¤±æ•—ãŒæ¿€æ¸›ã—ã¾ã™
class SeededRandom {
  constructor(seedStr) {
    // æ–‡å­—åˆ—ã‚’32bitã‚·ãƒ¼ãƒ‰å€¤ã«å¤‰æ› (MurmurHash3ã®ç°¡æ˜“ç‰ˆ)
    let h = 2166136261 >>> 0;
    for (let i = 0; i < seedStr.length; i++) {
      h = Math.imul(h ^ seedStr.charCodeAt(i), 16777619);
    }
    this.a = h >>> 0;
  }
  next() {
    let t = this.a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }
}
let rng = null;

const POOL = [
  { name:"ç‚ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"ç‚ = å¶æ•°", f:(i,a,v)=>i%2==0 }, 
  { name:"ç‚ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"ç‚ = å¥‡æ•°", f:(i,a,v)=>i%2!=0 }, 
  { name:"æ°´ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"æ°´ = å¶æ•°", f:(i,a,v)=>a%2==0 }, 
  { name:"æ°´ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"æ°´ = å¥‡æ•°", f:(i,a,v)=>a%2!=0 }, 
  { name:"é¢¨ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"é¢¨ = å¶æ•°", f:(i,a,v)=>v%2==0 }, 
  { name:"é¢¨ã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"é¢¨ = å¥‡æ•°", f:(i,a,v)=>v%2!=0 },

  { name:"ç‚ã¨1ã®é–¢ä¿‚ (=, >)", desc:"ç‚ = 1", f:(i,a,v)=>i==1 },
  { name:"ç‚ã¨1ã®é–¢ä¿‚ (=, >)", desc:"ç‚ > 1", f:(i,a,v)=>i>1 },
  { name:"æ°´ã¨1ã®é–¢ä¿‚ (=, >)", desc:"æ°´ = 1", f:(i,a,v)=>a==1 },
  { name:"æ°´ã¨1ã®é–¢ä¿‚ (=, >)", desc:"æ°´ > 1", f:(i,a,v)=>a>1 },
  { name:"é¢¨ã¨1ã®é–¢ä¿‚ (=, >)", desc:"é¢¨ = 1", f:(i,a,v)=>v==1 },
  { name:"é¢¨ã¨1ã®é–¢ä¿‚ (=, >)", desc:"é¢¨ > 1", f:(i,a,v)=>v>1 },

  { name:"ç‚ã¨3ã®é–¢ä¿‚ (=, >)", desc:"ç‚ = 3", f:(i,a,v)=>i==3 },
  { name:"ç‚ã¨3ã®é–¢ä¿‚ (=, >)", desc:"ç‚ > 3", f:(i,a,v)=>i>3 },
  { name:"æ°´ã¨3ã®é–¢ä¿‚ (=, >)", desc:"æ°´ = 3", f:(i,a,v)=>a==3 },
  { name:"æ°´ã¨3ã®é–¢ä¿‚ (=, >)", desc:"æ°´ > 3", f:(i,a,v)=>a>3 },
  { name:"é¢¨ã¨3ã®é–¢ä¿‚ (=, >)", desc:"é¢¨ = 3", f:(i,a,v)=>v==3 },
  { name:"é¢¨ã¨3ã®é–¢ä¿‚ (=, >)", desc:"é¢¨ > 3", f:(i,a,v)=>v>3 },

  { name:"ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ > æ°´", f:(i,a,v)=>i>a }, 
  { name:"ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ < æ°´", f:(i,a,v)=>i<a }, 
  { name:"ç‚ã¨æ°´ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ = æ°´", f:(i,a,v)=>i==a },
  { name:"æ°´ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"æ°´ > é¢¨", f:(i,a,v)=>a>v }, 
  { name:"æ°´ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"æ°´ < é¢¨", f:(i,a,v)=>a<v }, 
  { name:"æ°´ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"æ°´ = é¢¨", f:(i,a,v)=>a==v },
  { name:"ç‚ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ > é¢¨", f:(i,a,v)=>i>v }, 
  { name:"ç‚ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ < é¢¨", f:(i,a,v)=>i<v }, 
  { name:"ç‚ã¨é¢¨ã®æ¯”è¼ƒ (<, =, >)", desc:"ç‚ = é¢¨", f:(i,a,v)=>i==v },

  { name:"æœ€å¤§å€¤ã®æ‰€åœ¨ (â‰§)", desc:"ç‚ãŒæœ€å¤§ (ä»–ä»¥ä¸Š)", f:(i,a,v)=>i>=a && i>=v }, 
  { name:"æœ€å¤§å€¤ã®æ‰€åœ¨ (â‰§)", desc:"æ°´ãŒæœ€å¤§ (ä»–ä»¥ä¸Š)", f:(i,a,v)=>a>=i && a>=v }, 
  { name:"æœ€å¤§å€¤ã®æ‰€åœ¨ (â‰§)", desc:"é¢¨ãŒæœ€å¤§ (ä»–ä»¥ä¸Š)", f:(i,a,v)=>v>=i && v>=a }, 
  { name:"æœ€å°å€¤ã®æ‰€åœ¨ (â‰¦)", desc:"ç‚ãŒæœ€å° (ä»–ä»¥ä¸‹)", f:(i,a,v)=>i<=a && i<=v }, 
  { name:"æœ€å°å€¤ã®æ‰€åœ¨ (â‰¦)", desc:"æ°´ãŒæœ€å° (ä»–ä»¥ä¸‹)", f:(i,a,v)=>a<=i && a<=v }, 
  { name:"æœ€å°å€¤ã®æ‰€åœ¨ (â‰¦)", desc:"é¢¨ãŒæœ€å° (ä»–ä»¥ä¸‹)", f:(i,a,v)=>v<=i && v<=a }, 

  { name:"åˆè¨ˆã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"åˆè¨ˆ = å¶æ•°", f:(i,a,v)=>(i+a+v)%2==0 },
  { name:"åˆè¨ˆã®å¶å¥‡ (å¶æ•°, å¥‡æ•°)", desc:"åˆè¨ˆ = å¥‡æ•°", f:(i,a,v)=>(i+a+v)%2!=0 },
  { name:"åˆè¨ˆã¨6ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ < 6", f:(i,a,v)=>(i+a+v)<6 },
  { name:"åˆè¨ˆã¨6ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ â‰§ 6", f:(i,a,v)=>(i+a+v)>=6 },
  { name:"åˆè¨ˆã¨10ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ < 10", f:(i,a,v)=>(i+a+v)<10 },
  { name:"åˆè¨ˆã¨10ã®é–¢ä¿‚ (<, â‰§)", desc:"åˆè¨ˆ â‰§ 10", f:(i,a,v)=>(i+a+v)>=10 },

  { name:"ç´ æ•°ã®æœ‰ç„¡ (ã‚ã‚Š, ãªã—)", desc:"ç´ æ•°ã‚’å«ã‚€", f:(i,a,v)=>[i,a,v].some(n=>[2,3,5].includes(n)) },
  { name:"ç´ æ•°ã®æœ‰ç„¡ (ã‚ã‚Š, ãªã—)", desc:"ç´ æ•°ã‚’å«ã¾ãªã„", f:(i,a,v)=>![i,a,v].some(n=>[2,3,5].includes(n)) },

  { name:"ç‚+æ°´ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+æ°´ > 5", f:(i,a,v)=>(i+a)>5 },
  { name:"ç‚+æ°´ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+æ°´ < 5", f:(i,a,v)=>(i+a)<5 },
  { name:"ç‚+æ°´ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+æ°´ = 5", f:(i,a,v)=>(i+a)==5 },
  { name:"æ°´+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´+é¢¨ > 5", f:(i,a,v)=>(a+v)>5 },
  { name:"æ°´+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´+é¢¨ < 5", f:(i,a,v)=>(a+v)<5 },
  { name:"æ°´+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"æ°´+é¢¨ = 5", f:(i,a,v)=>(a+v)==5 },
  { name:"ç‚+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+é¢¨ > 5", f:(i,a,v)=>(i+v)>5 },
  { name:"ç‚+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+é¢¨ < 5", f:(i,a,v)=>(i+v)<5 },
  { name:"ç‚+é¢¨ã¨5ã®é–¢ä¿‚ (<, =, >)", desc:"ç‚+é¢¨ = 5", f:(i,a,v)=>(i+v)==5 },

  { name:"å¶æ•°ã®æ•° (1, 2)", desc:"å¶æ•°ãŒ1å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n%2==0).length==1 },
  { name:"å¶æ•°ã®æ•° (1, 2)", desc:"å¶æ•°ãŒ2å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n%2==0).length==2 },
  { name:"1ã®æ•° (0, 1)", desc:"1ã‚’å«ã¾ãªã„", f:(i,a,v)=>[i,a,v].filter(n=>n==1).length==0 },
  { name:"1ã®æ•° (0, 1)", desc:"1ãŒ1å€‹", f:(i,a,v)=>[i,a,v].filter(n=>n==1).length==1 },
  
  { name:"ä¸¦ã³ã®æ³•å‰‡ (å…¨ç•°, ãƒšã‚¢, æ˜‡é †)", desc:"ã™ã¹ã¦ç•°ãªã‚‹", f:(i,a,v)=>i!=a && a!=v && i!=v }, 
  { name:"ä¸¦ã³ã®æ³•å‰‡ (å…¨ç•°, ãƒšã‚¢, æ˜‡é †)", desc:"ãƒšã‚¢ã‚ã‚Š(2ã¤åŒã˜)", f:(i,a,v)=>i==a || a==v || i==v }, 
  { name:"ä¸¦ã³ã®æ³•å‰‡ (å…¨ç•°, ãƒšã‚¢, æ˜‡é †)", desc:"æ˜‡é † (ç‚<æ°´<é¢¨)", f:(i,a,v)=>i<a && a<v }
];

let state = { 
  ans:{i:0,a:0,v:0}, rules:[], round:1, mana:0, maxMana:3, 
  liarIndex:-1, stoneCount:5, isOmega:false,
  currentSeed: "", currentMode: ""
};

function generateSeed(length) {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

function limitInput(el) {
  if(el.value < 1) el.value = 1;
  if(el.value > 5) el.value = 5;
}

function initMatrix() {
  const grid = document.getElementById('logic-matrix');
  grid.innerHTML = '<div></div>'; 
  for(let n=1; n<=5; n++) grid.innerHTML += `<div class="grid-header">${n}</div>`;
  const rows = [
    {label:"ç‚", color:"#ff9999", id:"m-i"},
    {label:"æ°´", color:"#99ccff", id:"m-a"},
    {label:"é¢¨", color:"#99ffcc", id:"m-v"}
  ];
  rows.forEach(r => {
    grid.innerHTML += `<div class="grid-row-label" style="color:${r.color}">${r.label}</div>`;
    for(let n=1; n<=5; n++) {
      grid.innerHTML += `<div class="grid-cell" id="${r.id}-${n}" onclick="toggleCell(this)"></div>`;
    }
  });
  document.querySelectorAll('.memo-btn').forEach(btn => {
    btn.classList.remove('is-o');
    btn.classList.remove('is-x');
  });
}
function toggleCell(el) {
  if(el.classList.contains('cell-x')) {
    el.classList.remove('cell-x'); el.classList.add('cell-o');
  } else if(el.classList.contains('cell-o')) {
    el.classList.remove('cell-o');
  } else { el.classList.add('cell-x'); }
}
function toggleMemo(el) {
  if(el.classList.contains('is-x')) {
    el.classList.remove('is-x');
  } else if(el.classList.contains('is-o')) {
    el.classList.remove('is-o'); el.classList.add('is-x');
  } else { el.classList.add('is-o'); }
}
function toggleMemoArea() {
  document.getElementById('memo-pad').classList.toggle('closed');
}

function setBackground(mode) {
    const body = document.body;
    switch(mode) {
        case 'standard': body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #1a252e 0%, #05080a 100%)"; break;
        case 'hard': body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #3e1a1a 0%, #0a0505 100%)"; break;
        case 'nightmare': body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #2c1a3e 0%, #08050a 100%)"; break;
        case 'chaos': body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #333 0%, #000 100%)"; break;
        case 'omega': body.style.backgroundImage = "radial-gradient(circle at 50% 50%, #000 0%, #111 100%)"; break;
    }
}

function startGame(mode) {
  const newSeed = generateSeed(5);
  initGame(mode, newSeed);
}

function startFromId(mode) {
  const input = document.getElementById('input-seed');
  const seed = input.value.trim().toUpperCase();
  if(!seed) { alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  closeIdModal();
  initGame(mode, seed);
}

function initGame(mode, seed) {
  document.getElementById('loading-indicator').style.display = 'block';
  
  rng = new SeededRandom(seed);
  state.currentSeed = seed;
  state.currentMode = mode;
  
  setTimeout(() => {
    state.round = 1;
    state.mana = 0;
    state.maxMana = (mode === 'nightmare' || mode === 'omega') ? 2 : 3;
    state.stoneCount = (mode === 'standard') ? 4 : 5;
    state.isOmega = (mode === 'omega');

    const resultBtn = document.getElementById('btn-show-result');
    if(resultBtn) resultBtn.style.display = 'none';
    
    let success = false;
    let attempts = 0;
    const maxAttempts = 50000; 
    
    while(!success && attempts < maxAttempts) {
      attempts++;
      state.ans = {
        i: Math.floor(rng.next()*5)+1,
        a: Math.floor(rng.next()*5)+1,
        v: Math.floor(rng.next()*5)+1
      };
      
      let validRules = POOL.filter(r => r.f(state.ans.i, state.ans.a, state.ans.v) === true);
      if(validRules.length < state.stoneCount) continue;

      let picked = [];
      let temp = [...validRules];
      
      for (let i = temp.length - 1; i > 0; i--) {
          const j = Math.floor(rng.next() * (i + 1));
          [temp[i], temp[j]] = [temp[j], temp[i]];
      }
      for(let r of temp) {
        if(!picked.some(p => p.name === r.name)) picked.push(r);
        if(picked.length === state.stoneCount) break;
      }
      if(picked.length < state.stoneCount) continue;

      let matches = 0;
      for(let i=1; i<=5; i++) {
        for(let a=1; a<=5; a++) {
          for(let v=1; v<=5; v++) {
             if(picked.every(rule => rule.f(i,a,v))) matches++;
          }
        }
      }

      if(matches === 1) {
        if(mode === 'chaos') {
          const tempLiar = Math.floor(rng.next()*state.stoneCount);
          let chaosSolutions = 0;
          for(let i=1; i<=5; i++) {
            for(let a=1; a<=5; a++) {
              for(let v=1; v<=5; v++) {
                 let trueCount = 0;
                 picked.forEach((r, idx) => {
                   let res = r.f(i, a, v);
                   if(idx === tempLiar) res = !res;
                   if(res) trueCount++;
                 });
                 if(trueCount === state.stoneCount) chaosSolutions++;
              }
            }
          }
          if(chaosSolutions === 1) {
            state.rules = picked;
            state.liarIndex = tempLiar;
            success = true;
          }
        } else {
          state.rules = picked;
          state.liarIndex = -1;
          success = true;
        }
      }
    }

    document.getElementById('loading-indicator').style.display = 'none';

    if(!success) {
      alert("ç”Ÿæˆå¤±æ•—: æ¡ä»¶ã«åˆã†ãƒ‘ã‚ºãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®IDã‚’è©¦ã™ã‹ã€ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
      rng = new SeededRandom(generateSeed(5)); 
    } else {
      document.getElementById('title-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
      setBackground(mode);
      updateHUD();
      document.getElementById('log-container').innerHTML = '';
      document.getElementById('chaos-warning').style.display = (mode === 'chaos') ? 'block' : 'none';
      
      const hud = document.querySelector('.hud');
      // å¤ã„IDè¡¨ç¤ºãŒã‚ã‚Œã°æ¶ˆã™
      const oldId = document.getElementById('current-id-display');
      if(oldId) oldId.remove();
      
      hud.insertAdjacentHTML('afterend', 
        `<div id="current-id-display" style="text-align:center; color:#555; font-size:0.7rem; margin-top:-10px;">ID: <span style="font-family:'Cinzel',serif; color:#777;">${state.currentSeed}</span></div>`
      );

      document.getElementById('omega-rule-area').style.display = state.isOmega ? 'block' : 'none';
      initMatrix();
      renderProphecies();
    }
  }, 100);
}

function renderProphecies() {
  const c = document.getElementById('prophecy-container');
  c.innerHTML = '';
  const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
  
  if (state.isOmega) {
    const listContainer = document.getElementById('omega-list');
    listContainer.innerHTML = '';
    let shuffledRules = [...state.rules];
    for (let i = shuffledRules.length - 1; i > 0; i--) {
        const j = Math.floor(rng.next() * (i + 1));
        [shuffledRules[i], shuffledRules[j]] = [shuffledRules[j], shuffledRules[i]];
    }
    shuffledRules.forEach(r => {
      const item = document.createElement('div');
      item.className = 'omega-list-item';
      item.innerText = r.name;
      item.onclick = () => { item.classList.toggle('excluded'); };
      listContainer.appendChild(item);
    });
  }

  state.rules.forEach((r, idx) => {
    let div = document.createElement('div');
    if (state.isOmega) {
      div.className = 'stone is-mystery';
      div.id = `stone-${idx}`;
      div.innerHTML = `<div class="stone-text" style="font-size:1.8rem;">???</div>`;
    } else {
      div.className = 'stone';
      div.id = `stone-${idx}`;
      div.innerHTML = `
        <div class="stone-content">
          <div class="stone-title">äºˆè¨€ ${names[idx]}</div>
          <div class="stone-text">${r.name}</div>
        </div>
        <div class="stone-id">${names[idx]}</div>
      `;
    }
    div.onclick = () => checkProphecy(idx, r, div);
    c.appendChild(div);
  });
}

function checkProphecy(idx, rule, el) {
  if(state.mana >= state.maxMana) return;
  const i = +document.getElementById('r1').value;
  const a = +document.getElementById('r2').value;
  const v = +document.getElementById('r3').value;
  if(!i || !a || !v) return;
  
  if(state.mana === 0) {
    document.getElementById('r1').disabled = true;
    document.getElementById('r2').disabled = true;
    document.getElementById('r3').disabled = true;
  }

  let isTrue = rule.f(i, a, v);
  if(idx === state.liarIndex) isTrue = !isTrue;

  state.mana++;
  updateHUD();
  
  const log = document.getElementById('log-container');
  const entry = document.createElement('div');
  const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
  entry.className = isTrue ? 'log-entry log-true' : 'log-entry log-false';
  entry.innerHTML = `
    <span>R${state.round} äºˆè¨€${names[idx]} <span class="log-nums">${i}-${a}-${v}</span></span>
    <strong>${isTrue ? "TRUE" : "FALSE"}</strong>
  `;
  log.prepend(entry);

  if(state.mana >= state.maxMana) {
    document.querySelectorAll('.stone').forEach(s => s.classList.add('disabled'));
  }
}

function nextRound() {
  if(state.mana === 0) return;
  state.round++;
  state.mana = 0;
  updateHUD();
  document.getElementById('r1').disabled = false;
  document.getElementById('r2').disabled = false;
  document.getElementById('r3').disabled = false;
  document.querySelectorAll('.stone').forEach(s => s.classList.remove('disabled'));
}

function attemptUnlock() {
  const i = +document.getElementById('r1').value;
  const a = +document.getElementById('r2').value;
  const v = +document.getElementById('r3').value;
  
  const modal = document.getElementById('result-modal');
  modal.style.display = 'flex';
  
  const isCorrect = (i === state.ans.i && a === state.ans.a && v === state.ans.v);
  const title = document.querySelector('.seal-broken');
  if(isCorrect) {
    title.innerText = "å°å°è§£é™¤";
    title.style.color = "#fff";
  } else {
    title.innerText = "è§£é™¤å¤±æ•—";
    title.style.color = "#c0392b";
  }
  
  document.getElementById('final-code').innerText = `${state.ans.i} ${state.ans.a} ${state.ans.v}`;
  document.getElementById('final-round').innerText = state.round;

  saveHistory(isCorrect);

  const detailBox = document.getElementById('result-details');
  let html = '';
  const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
  state.rules.forEach((r, idx) => {
      const isLiar = (idx === state.liarIndex);
      const liarTag = isLiar ? '<span class="res-liar-txt">[å˜˜ã¤ã]</span> ' : '';
      html += `<div class="res-row">
        <div><strong>äºˆè¨€${names[idx]}</strong>: ${liarTag}${r.name}</div>
        <div style="color:#d4af37; padding-left:10px; font-size:0.85rem;">
           ğŸ‘‰ æ­£è§£ã®æ³•å‰‡: <strong>${r.desc}</strong>
        </div>
      </div>`;
  });
  detailBox.innerHTML = html;
}

function saveHistory(isWin) {
  const historyItem = {
    seed: state.currentSeed,
    mode: state.currentMode,
    round: state.round,
    win: isWin,
    date: new Date().toLocaleString()
  };
  let history = JSON.parse(localStorage.getItem('omega_history') || '[]');
  history.unshift(historyItem);
  if(history.length > 30) history.pop();
  localStorage.setItem('omega_history', JSON.stringify(history));
}

function showHistory() {
  const modal = document.getElementById('history-modal');
  const list = document.getElementById('history-list');
  const history = JSON.parse(localStorage.getItem('omega_history') || '[]');
  
  modal.style.display = 'flex';
  list.innerHTML = '';
  
  if(history.length === 0) {
    list.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">è¨˜éŒ²ãªã—</div>';
    return;
  }

  history.forEach(h => {
    const item = document.createElement('div');
    item.className = 'hist-item';
    let modeLabel = h.mode.toUpperCase();
    if(h.mode==='standard') modeLabel = 'STD';
    if(h.mode==='nightmare') modeLabel = 'NIGHT';
    
    item.innerHTML = `
      <div class="hist-left">
        <span class="hist-mode mode-${h.mode}">${modeLabel}</span>
        <span class="hist-id">#${h.seed}</span>
        <div class="hist-date">${h.date} - R${h.round}</div>
      </div>
      <div style="display:flex; align-items:center;">
        <span class="hist-result ${h.win ? 'res-win':'res-lose'}">${h.win ? 'WIN':'LOSE'}</span>
        <button class="btn-replay" onclick="startFromHistory('${h.mode}', '${h.seed}')">å†æŒ‘æˆ¦</button>
      </div>
    `;
    list.appendChild(item);
  });
}

function startFromHistory(mode, seed) {
  closeHistory();
  initGame(mode, seed);
}

function reviewBoard() {
  document.getElementById('result-modal').style.display = 'none';
  const resultBtn = document.getElementById('btn-show-result');
  if(resultBtn) resultBtn.style.display = 'flex';
  
  document.getElementById('r1').disabled = true;
  document.getElementById('r2').disabled = true;
  document.getElementById('r3').disabled = true;
  document.querySelectorAll('.stone').forEach(s => s.classList.add('disabled'));
  document.querySelectorAll('.btn-action').forEach(b => b.style.display = 'none');

  if(state.liarIndex !== -1) {
      const liarStone = document.getElementById(`stone-${state.liarIndex}`);
      if(liarStone) liarStone.classList.add('is-liar');
  }
  
  if(state.isOmega) {
      const names = ["Î±", "Î²", "Î³", "Î´", "Îµ"];
      state.rules.forEach((r, idx) => {
          const s = document.getElementById(`stone-${idx}`);
          if(s) {
              s.innerHTML = `
                <div style="font-size:0.7rem; color:#aaa;">${names[idx]}</div>
                <div style="font-size:0.9rem; color:#fff;">${r.name}</div>
              `;
              s.style.background = "#222";
              s.style.border = "1px solid #777";
          }
      });
  }
}

function showResult() { document.getElementById('result-modal').style.display = 'flex'; }
function updateHUD() {
  document.getElementById('ui-round').innerText = state.round;
  document.getElementById('ui-mana').innerText = `${state.mana}/${state.maxMana}`;
}
function showHelp() { document.getElementById('help-modal').style.display = 'flex'; }
function closeHelp() { document.getElementById('help-modal').style.display = 'none'; }
function showInputId() { document.getElementById('id-modal').style.display = 'flex'; }
function closeIdModal() { document.getElementById('id-modal').style.display = 'none'; }
function closeHistory() { document.getElementById('history-modal').style.display = 'none'; }
</script>
</body>
</html>
